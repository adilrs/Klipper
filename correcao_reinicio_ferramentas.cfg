# ===================================================================
# CORRE√á√ÉO DO PROBLEMA DE REIN√çCIO DE FERRAMENTAS
# ===================================================================
# 
# PROBLEMA IDENTIFICADO:
# - Ap√≥s reiniciar, o sistema assume que est√° com T0 (tool=1)
# - Mas se estava com T2 (tool=3) antes do rein√≠cio, causa desastre
# - O init_tool_restore n√£o sincroniza corretamente o TOOL_STATE
#
# SOLU√á√ÉO:
# - Melhorar o delayed_gcode para sincronizar corretamente
# - Adicionar verifica√ß√£o f√≠sica com LIDAR quando dispon√≠vel
# - Criar macros de emerg√™ncia para corre√ß√£o manual
# ===================================================================

# üîß DELAYED_GCODE MELHORADO
# Substitui o init_tool_restore original
[delayed_gcode init_tool_restore_fixed]
initial_duration: 2.0  # Aguarda 2 segundos para estabilizar
gcode:
  {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
  {% set show_t = saved_tool - 1 %}  # Para exibir T0, T1, T2
  
  RESPOND PREFIX="INFO" MSG="üîÑ INICIALIZA√á√ÉO: Restaurando ferramenta salva T{show_t} (TOOL={saved_tool})"
  
  # 1. SINCRONIZAR TOOL_STATE com valor salvo
  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={saved_tool}
  
  # 2. ATIVAR EXTRUSORA CORRETA
  {% set extruders = {
    1: "extruder", 2: "extruder1", 3: "extruder2"
  } %}
  {% set extruder_name = extruders[saved_tool] %}
  
  {% if printer[extruder_name] is defined %}
    ACTIVATE_EXTRUDER EXTRUDER={extruder_name}
    RESPOND PREFIX="INFO" MSG="‚úÖ Extrusora {extruder_name} ativada"
  {% else %}
    RESPOND PREFIX="ERROR" MSG="‚ùå Extrusora {extruder_name} n√£o encontrada!"
  {% endif %}
  
  # 3. APLICAR OFFSETS CORRETOS
  {% set vars = printer.save_variables.variables %}
  {% if saved_tool == 1 %}
    # T0 sempre tem offset zero (refer√™ncia)
    SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0
    RESPOND PREFIX="INFO" MSG="üéØ T0: Offset ZERO aplicado (refer√™ncia BLTouch)"
  {% elif saved_tool == 2 %}
    # T1 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer['gcode_macro TOOL_DATA']['offset_x2']|default(0)|float %}
    {% set y = printer['gcode_macro TOOL_DATA']['offset_y2']|default(0)|float %}
    {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
    SET_GCODE_OFFSET X={x} Y={y} Z={z}
    RESPOND PREFIX="INFO" MSG="üéØ T1: Offset aplicado X={x} Y={y} Z={z}"
  {% elif saved_tool == 3 %}
    # T2 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
    {% set x = printer['gcode_macro TOOL_DATA']['offset_x3']|default(0)|float %}
    {% set y = printer['gcode_macro TOOL_DATA']['offset_y3']|default(0)|float %}
    {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
    SET_GCODE_OFFSET X={x} Y={y} Z={z}
    RESPOND PREFIX="INFO" MSG="üéØ T2: Offset aplicado X={x} Y={y} Z={z}"
  {% endif %}
  
  # 4. VERIFICA√á√ÉO F√çSICA (se LIDAR dispon√≠vel)
  {% if printer["gcode_macro LIDAR_MODE"].status %}
    {% set lidar = printer["gcode_macro DISTANCIA_VL53"].distancia|float %}
    {% if lidar <= 110 %}
      RESPOND PREFIX="INFO" MSG="‚úÖ LIDAR: Ferramenta f√≠sica detectada ({lidar}mm)"
    {% else %}
      RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è LIDAR: Nenhuma ferramenta detectada ({lidar}mm)"
      RESPOND PREFIX="INFO" MSG="üí° Verifique se a ferramenta est√° realmente montada"
    {% endif %}
  {% else %}
    RESPOND PREFIX="INFO" MSG="üö´ LIDAR desativado - sem verifica√ß√£o f√≠sica"
  {% endif %}
  
  # 5. CARREGAR OFFSETS Z
  INIT_TOOL_OFFSETS
  
  RESPOND PREFIX="INFO" MSG="‚úÖ SISTEMA INICIALIZADO: T{show_t} ativa e sincronizada"
  M117 Sistema pronto - T{show_t} ativa

# üö® MACRO DE EMERG√äNCIA - CORRE√á√ÉO MANUAL
[gcode_macro CORRIGIR_TOOL_FIS]
description: Corrige manualmente qual ferramenta est√° fisicamente montada
gcode:
  {% set tool = params.TOOL|default(1)|int %}
  {% set show_t = tool - 1 %}
  
  {% if tool < 1 or tool > 3 %}
    RESPOND PREFIX="ERROR" MSG="‚ùå FERRAMENTA INV√ÅLIDA! Use TOOL=1, 2 ou 3"
    RETURN
  {% endif %}
  
  RESPOND PREFIX="INFO" MSG="üîß CORRE√á√ÉO MANUAL: Definindo T{show_t} como ferramenta f√≠sica ativa"
  
  # Sincronizar estados
  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={tool}
  SAVE_VARIABLE VARIABLE=tool VALUE={tool}
  
  # Ativar extrusora correta
  {% set extruders = {
    1: "extruder", 2: "extruder1", 3: "extruder2"
  } %}
  {% set extruder_name = extruders[tool] %}
  ACTIVATE_EXTRUDER EXTRUDER={extruder_name}
  
  # Aplicar offsets
  {% set vars = printer.save_variables.variables %}
  {% if tool == 1 %}
    SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0
    RESPOND PREFIX="INFO" MSG="üéØ T0: Offset ZERO aplicado"
  {% elif tool == 2 %}
    {% set x = printer['gcode_macro TOOL_DATA']['offset_x2']|default(0)|float %}
    {% set y = printer['gcode_macro TOOL_DATA']['offset_y2']|default(0)|float %}
    {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
    SET_GCODE_OFFSET X={x} Y={y} Z={z}
    RESPOND PREFIX="INFO" MSG="üéØ T1: Offset aplicado X={x} Y={y} Z={z}"
  {% elif tool == 3 %}
    {% set x = printer['gcode_macro TOOL_DATA']['offset_x3']|default(0)|float %}
    {% set y = printer['gcode_macro TOOL_DATA']['offset_y3']|default(0)|float %}
    {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
    SET_GCODE_OFFSET X={x} Y={y} Z={z}
    RESPOND PREFIX="INFO" MSG="üéØ T2: Offset aplicado X={x} Y={y} Z={z}"
  {% endif %}
  
  RESPOND PREFIX="INFO" MSG="‚úÖ CORRE√á√ÉO CONCLU√çDA: T{show_t} ativa e sincronizada"
  M117 T{show_t} corrigida manualmente

# üîç DIAGN√ìSTICO DE SINCRONIZA√á√ÉO
[gcode_macro VERIFICAR_SINCRONIZACAO]
description: Verifica se os estados est√£o sincronizados
gcode:
  {% set tool_state = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
  {% set active_extruder = printer.toolhead.extruder %}
  
  {% set show_state = tool_state - 1 %}
  {% set show_saved = saved_tool - 1 %}
  
  RESPOND MSG="üîç ===== VERIFICA√á√ÉO DE SINCRONIZA√á√ÉO ====="
  RESPOND MSG="üìä TOOL_STATE: T{show_state} (TOOL={tool_state})"
  RESPOND MSG="üìä Variables.cfg: T{show_saved} (TOOL={saved_tool})"
  RESPOND MSG="üìä Extrusora ativa: {active_extruder}"
  
  {% if tool_state == saved_tool %}
    RESPOND MSG="‚úÖ ESTADOS SINCRONIZADOS"
  {% else %}
    RESPOND MSG="‚ùå ESTADOS DESSINCRONIZADOS!"
    RESPOND MSG="üí° Execute: CORRIGIR_FERRAMENTA_FISICA TOOL={saved_tool}"
  {% endif %}
  
  # Verificar LIDAR se dispon√≠vel
  {% if printer["gcode_macro LIDAR_MODE"].status %}
    {% set lidar = printer["gcode_macro DISTANCIA_VL53"].distancia|float %}
    RESPOND MSG="üîç LIDAR: {lidar}mm"
    {% if lidar <= 110 %}
      RESPOND MSG="‚úÖ Ferramenta f√≠sica detectada"
    {% else %}
      RESPOND MSG="‚ö†Ô∏è Nenhuma ferramenta f√≠sica detectada"
    {% endif %}
  {% else %}
    RESPOND MSG="üö´ LIDAR desativado"
  {% endif %}

# üîÑ MACRO DE REINICIALIZA√á√ÉO SEGURA
[gcode_macro RESTART_TOOLS]
description: Reinicializa o sistema de ferramentas de forma segura
gcode:
  RESPOND PREFIX="INFO" MSG="üîÑ REINICIALIZANDO SISTEMA DE FERRAMENTAS..."
  
  # For√ßar T0 como estado seguro
  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=1
  SAVE_VARIABLE VARIABLE=tool VALUE=1
  
  # Ativar extruder principal
  ACTIVATE_EXTRUDER EXTRUDER=extruder
  
  # Aplicar offset zero
  SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0
  
  # Recarregar offsets
  INIT_TOOL_OFFSETS
  
  RESPOND PREFIX="INFO" MSG="‚úÖ SISTEMA REINICIALIZADO: T0 ativa (estado seguro)"
  M117 Sistema reinicializado - T0 ativa

# ===================================================================
# INSTRU√á√ïES DE USO:
# ===================================================================
# 
# 1. INCLUIR NO PRINTER.CFG:
#    [include correcao_reinicio_ferramentas.cfg]
# 
# 2. DESABILITAR O DELAYED_GCODE ORIGINAL:
#    Comentar ou renomear [delayed_gcode init_tool_restore]
# 
# 3. COMANDOS DISPON√çVEIS:
#    - VERIFICAR_SINCRONIZACAO: Verifica se estados est√£o ok
#    - CORRIGIR_FERRAMENTA_FISICA TOOL=X: Corrige manualmente
#    - REINICIAR_SISTEMA_FERRAMENTAS: Reset completo para T0
# 
# 4. CEN√ÅRIO DE USO:
#    - Reiniciou com T2 mas sistema pensa que √© T0?
#    - Execute: CORRIGIR_FERRAMENTA_FISICA TOOL=3
# 
# ===================================================================