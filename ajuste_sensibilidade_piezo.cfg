# Guia de Ajuste de Sensibilidade do Sensor Piezoelétrico
# Use este arquivo para calibrar a sensibilidade ideal

[gcode_macro CALIB_SENS_PIEZO]
description: Guia passo-a-passo para ajustar a sensibilidade do sensor
gcode:
    RESPOND MSG="🔧 CALIBRAÇÃO DE SENSIBILIDADE - SENSOR PIEZOELÉTRICO"
    RESPOND MSG="════════════════════════════════════════════════════"
    RESPOND MSG=""
    RESPOND MSG="📍 SITUAÇÃO ATUAL: LED só pisca com impacto forte"
    RESPOND MSG="🎯 OBJETIVO: Ajustar para detectar toques leves"
    RESPOND MSG=""
    RESPOND MSG="🔧 INSTRUÇÕES DE AJUSTE:"
    RESPOND MSG="1. Localize o potenciômetro (parafuso pequeno) na placa LM393"
    RESPOND MSG="2. Use uma chave de fenda pequena ou chave Phillips"
    RESPOND MSG="3. Gire LENTAMENTE no sentido HORÁRIO (aumenta sensibilidade)"
    RESPOND MSG="4. Faça 1/4 de volta por vez"
    RESPOND MSG="5. Teste após cada ajuste com toque leve"
    RESPOND MSG=""
    RESPOND MSG="⚠️  CUIDADO:"
    RESPOND MSG="- NÃO gire muito rápido ou muito longe"
    RESPOND MSG="- Se ficar muito sensível, gire anti-horário"
    RESPOND MSG="- Teste sempre após cada ajuste"
    RESPOND MSG=""
    RESPOND MSG="🧪 Para testar: TESTE_TOQUE_LEVE"
    RESPOND MSG="Estado atual do sensor: {printer['gcode_button sensor_piezo'].state}"

[gcode_macro TESTE_TOQUE_LEVE]
description: Teste específico para toques leves
gcode:
    RESPOND MSG="👆 TESTE DE TOQUE LEVE"
    RESPOND MSG="═══════════════════════"
    RESPOND MSG="Estado inicial: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    RESPOND MSG="📋 FAÇA AGORA:"
    RESPOND MSG="1. Toque MUITO LEVEMENTE o sensor (como uma pena)"
    RESPOND MSG="2. Observe se aparece '🔴 Sensor acionado'"
    RESPOND MSG="3. Solte e veja se aparece '🟢 Sensor liberado'"
    RESPOND MSG=""
    RESPOND MSG "✅ SE FUNCIONOU: Sensibilidade está boa!"
    RESPOND MSG="❌ SE NÃO FUNCIONOU: Gire potenciômetro 1/4 volta horário"
    RESPOND MSG=""
    RESPOND MSG="Estado atual: {printer['gcode_button sensor_piezo'].state}"

[gcode_macro TESTE_PROG_SENS]
description: Teste com diferentes níveis de força
gcode:
    RESPOND MSG="📊 TESTE PROGRESSIVO DE SENSIBILIDADE"
    RESPOND MSG="════════════════════════════════════"
    RESPOND MSG=""
    RESPOND MSG="Vamos testar 4 níveis de toque:"
    RESPOND MSG=""
    
    # Nível 1 - Muito leve
    RESPOND MSG="🪶 NÍVEL 1: TOQUE MUITO LEVE (como uma pena)"
    RESPOND MSG="Toque agora e aguarde 3 segundos..."
    G4 P3000
    RESPOND MSG="Resultado Nível 1: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    
    # Nível 2 - Leve
    RESPOND MSG="👆 NÍVEL 2: TOQUE LEVE (dedo suave)"
    RESPOND MSG="Toque agora e aguarde 3 segundos..."
    G4 P3000
    RESPOND MSG="Resultado Nível 2: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    
    # Nível 3 - Normal
    RESPOND MSG="✋ NÍVEL 3: TOQUE NORMAL"
    RESPOND MSG="Toque agora e aguarde 3 segundos..."
    G4 P3000
    RESPOND MSG="Resultado Nível 3: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    
    # Nível 4 - Firme
    RESPOND MSG="👊 NÍVEL 4: TOQUE FIRME"
    RESPOND MSG="Toque agora e aguarde 3 segundos..."
    G4 P3000
    RESPOND MSG="Resultado Nível 4: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    
    RESPOND MSG="📋 ANÁLISE DOS RESULTADOS:"
    RESPOND MSG="- Ideal: Níveis 1-3 devem detectar (estado = 1)"
    RESPOND MSG="- Se só Nível 4 detecta: Gire potenciômetro horário"
    RESPOND MSG="- Se todos detectam: Sensibilidade está boa!"
    RESPOND MSG="- Se detecta sem tocar: Gire potenciômetro anti-horário"

[gcode_macro MONITOR_REAL_TIME]
description: Monitor em tempo real durante ajuste do potenciômetro
gcode:
    {% set duracao = params.DURACAO|default(60)|int %}
    
    RESPOND MSG="⏱️  MONITOR DE AJUSTE EM TEMPO REAL"
    RESPOND MSG="═══════════════════════════════════"
    RESPOND MSG="Duração: {duracao} segundos"
    RESPOND MSG=""
    RESPOND MSG="🔧 INSTRUÇÕES:"
    RESPOND MSG="1. Deixe esta macro rodando"
    RESPOND MSG="2. Ajuste o potenciômetro lentamente"
    RESPOND MSG="3. Teste toques leves enquanto ajusta"
    RESPOND MSG="4. Observe as mudanças em tempo real"
    RESPOND MSG=""
    
    {% set total_checks = duracao * 2 %}  # Verifica a cada 0.5s
    {% for i in range(total_checks) %}
        {% set tempo = (i * 0.5)|round(1) %}
        {% set estado = printer['gcode_button sensor_piezo'].state %}
        
        {% if estado == 1 %}
            RESPOND MSG="🔴 {tempo}s: SENSOR ACIONADO!"
        {% else %}
            RESPOND MSG="🟢 {tempo}s: Sensor livre"
        {% endif %}
        
        G4 P500  # 0.5 segundos
        
        {% if (i + 1) % 20 == 0 %}
            {% set progresso = ((i + 1) / total_checks * 100)|int %}
            RESPOND MSG="📊 Progresso: {progresso}% - Continue ajustando..."
        {% endif %}
    {% endfor %}
    
    RESPOND MSG="✅ Monitoramento concluído!"
    RESPOND MSG="Execute TESTE_TOQUE_LEVE para verificar resultado final"