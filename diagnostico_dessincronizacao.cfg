# Diagn√≥stico de Dessincroniza√ß√£o de Ferramentas
# Criado para resolver o problema de estado inconsistente

[gcode_macro DIAGNOSTICO_COMPLETO]
description: Verifica todos os estados do sistema de ferramentas
gcode:
  RESPOND PREFIX="INFO" MSG="=== DIAGN√ìSTICO COMPLETO ==="
  
  # Estado do TOOL_STATE
  {% set tool_state = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set show_tool_state = tool_state - 1 %}
  RESPOND PREFIX="INFO" MSG="TOOL_STATE.tool = {tool_state} (T{show_tool_state})"
  
  # Estado do variables.cfg
  {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
  {% set show_saved = saved_tool - 1 %}
  RESPOND PREFIX="INFO" MSG="variables.tool = {saved_tool} (T{show_saved})"
  
  # Extrusora ativa
  {% set active_extruder = printer.toolhead.extruder %}
  RESPOND PREFIX="INFO" MSG="Extrusora ativa: {active_extruder}"
  
  # Detec√ß√£o f√≠sica (LIDAR)
  {% if printer["gcode_macro LIDAR_MODE"].STATUS %}
    {% set lidar = printer["gcode_macro DISTANCIA_VL53"].distancia|float %}
    RESPOND PREFIX="INFO" MSG="LIDAR: {lidar}mm (ferramenta {'presente' if lidar <= 110 else 'ausente'})"
  {% else %}
    RESPOND PREFIX="INFO" MSG="LIDAR: desabilitado"
  {% endif %}
  
  # Verificar consist√™ncia
  {% if tool_state != saved_tool %}
    RESPOND PREFIX="ERROR" MSG="‚ùå DESSINCRONIZA√á√ÉO: TOOL_STATE({tool_state}) ‚â† variables({saved_tool})"
  {% else %}
    RESPOND PREFIX="INFO" MSG="‚úÖ Estados sincronizados"
  {% endif %}
  
  RESPOND PREFIX="INFO" MSG="=== FIM DIAGN√ìSTICO ==="

[gcode_macro SINCRONIZAR_ESTADOS]
description: For√ßa sincroniza√ß√£o entre TOOL_STATE e variables.cfg
gcode:
  {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={saved_tool}
  {% set show_t = saved_tool - 1 %}
  RESPOND PREFIX="INFO" MSG="‚úÖ TOOL_STATE sincronizado com variables.cfg: T{show_t}"
  
  # Ativar extrusora correta
  {% set extruders = {1: "extruder", 2: "extruder1", 3: "extruder2"} %}
  {% if saved_tool in extruders %}
    ACTIVATE_EXTRUDER EXTRUDER={extruders[saved_tool]}
    RESPOND PREFIX="INFO" MSG="‚úÖ Extrusora {extruders[saved_tool]} ativada"
  {% endif %}
  
  # Aplicar offsets corretos
  APPLY_TOOL_OFFSET

[gcode_macro CORRIGIR_DESSINC]
description: Detecta e corrige automaticamente dessincroniza√ß√£o
gcode:
  RESPOND PREFIX="INFO" MSG="üîß Iniciando corre√ß√£o autom√°tica..."
  
  # Verificar estados
  {% set tool_state = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
  
  {% if tool_state != saved_tool %}
    RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è Dessincroniza√ß√£o detectada: TOOL_STATE={tool_state}, variables={saved_tool}"
    RESPOND PREFIX="INFO" MSG="üîß Sincronizando com variables.cfg (fonte confi√°vel)..."
    SINCRONIZAR_ESTADOS
  {% else %}
    RESPOND PREFIX="INFO" MSG="‚úÖ Estados j√° sincronizados"
    # Mesmo assim, garantir que extrusora e offsets est√£o corretos
    {% set extruders = {1: "extruder", 2: "extruder1", 3: "extruder2"} %}
    {% if saved_tool in extruders %}
      ACTIVATE_EXTRUDER EXTRUDER={extruders[saved_tool]}
    {% endif %}
    APPLY_TOOL_OFFSET
  {% endif %}
  
  RESPOND PREFIX="INFO" MSG="‚úÖ Corre√ß√£o conclu√≠da"