#####################################################################
#           CALIBRA√á√ÉO AUTOM√ÅTICA COM SENSOR TP223               #
#####################################################################
# Sistema de Calibra√ß√£o Autom√°tica usando Sensor TP223
# Integra√ß√£o com sistema dual probe (BLTouch + TP223)
# Vers√£o: 1.0 - Espec√≠fico para TP223
# Data: Janeiro 2025

[gcode_macro CALIBRACAO_TP223_CONFIG]
description: Configura√ß√µes espec√≠ficas para calibra√ß√£o autom√°tica com TP223
variable_sensor_pin: "^host:gpio22"     # Pin do sensor TP223 (pullup)
variable_reference_x: 320.0             # Posi√ß√£o X da superf√≠cie de refer√™ncia
variable_reference_y: 100.0             # Posi√ß√£o Y da superf√≠cie de refer√™ncia
variable_reference_z: 10.0              # Altura inicial segura
variable_probe_speed: 300               # Velocidade de aproxima√ß√£o (mm/min)
variable_probe_speed_slow: 60           # Velocidade final de toque (mm/min)
variable_probe_distance: 15.0           # Dist√¢ncia m√°xima de sondagem
variable_samples: 5                     # N√∫mero de amostras por medi√ß√£o
variable_tolerance: 0.02                # Toler√¢ncia entre amostras (mm)
variable_retract_distance: 5.0          # Dist√¢ncia de retra√ß√£o ap√≥s toque
variable_settle_time: 1000              # Tempo de estabiliza√ß√£o (ms)
gcode:
    {% set x_pos = params.X|default(320)|float %}
    {% set y_pos = params.Y|default(100)|float %}
    {% set z_pos = params.Z|default(10)|float %}
    {% set speed = params.SPEED|default(300)|int %}
    {% set slow_speed = params.SLOW_SPEED|default(60)|int %}
    {% set distance = params.DISTANCE|default(15)|float %}
    {% set samples = params.SAMPLES|default(5)|int %}
    {% set tolerance = params.TOLERANCE|default(0.02)|float %}
    
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_TP223_CONFIG VARIABLE=reference_x VALUE={x_pos}
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_TP223_CONFIG VARIABLE=reference_y VALUE={y_pos}
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_TP223_CONFIG VARIABLE=reference_z VALUE={z_pos}
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_TP223_CONFIG VARIABLE=probe_speed VALUE={speed}
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_TP223_CONFIG VARIABLE=probe_speed_slow VALUE={slow_speed}
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_TP223_CONFIG VARIABLE=probe_distance VALUE={distance}
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_TP223_CONFIG VARIABLE=samples VALUE={samples}
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_TP223_CONFIG VARIABLE=tolerance VALUE={tolerance}
    
    RESPOND MSG="‚úÖ Configura√ß√£o TP223 atualizada: X{x_pos} Y{y_pos} Z{z_pos}"
    RESPOND MSG="üìä Amostras: {samples}, Toler√¢ncia: {tolerance}mm, Velocidade: {speed}mm/min"

#####################################################################
#                    MEDI√á√ÉO AUTOM√ÅTICA DE DIST√ÇNCIA              #
#####################################################################

[gcode_macro MEDIR_TP223]
description: Mede automaticamente a dist√¢ncia do bico usando sensor TP223
variable_last_measurement: 0.0
variable_measurements_history: []
variable_measurement_count: 0
gcode:
    {% set config = printer["gcode_macro CALIBRACAO_TP223_CONFIG"] %}
    {% set tool = params.TOOL|default(printer.toolhead.extruder)|string %}
    
    RESPOND MSG="üîç ===== MEDI√á√ÉO AUTOM√ÅTICA DIST√ÇNCIA BICO ====="
    RESPOND MSG="üîß Ferramenta: {tool}"
    RESPOND MSG="üìç Sensor TP223 no GPIO 22"
    
    # Verificar se est√° em home
    {% if not 'xyz' in printer.toolhead.homed_axes %}
        RESPOND MSG="üè† Executando home..."
        G28
    {% endif %}
    
    # Ativar ferramenta se especificada
    {% if tool != printer.toolhead.extruder %}
        T{tool[-1]}
        G4 P2000  # Aguardar estabiliza√ß√£o
    {% endif %}
    
    # Posicionar sobre ponto de refer√™ncia
    RESPOND MSG="üìç Posicionando sobre ponto de refer√™ncia..."
    G90
    G1 X{config.reference_x} Y{config.reference_y} Z{config.reference_z} F{config.probe_speed}
    G4 P{config.settle_time}
    
    # Reset do sensor TP223
    SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=sensor_triggered VALUE=0
    SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=trigger_z VALUE=0.0
    
    # Executar m√∫ltiplas medi√ß√µes
    {% set measurements = [] %}
    {% for sample in range(config.samples) %}
        RESPOND MSG="üìè Medi√ß√£o {sample + 1}/{config.samples}..."
        
        # Reset do sensor antes de cada medi√ß√£o
        SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=sensor_triggered VALUE=0
        
        # Sondagem com TP223
        PROBE_TP223_SURFACE
        
        # Verificar se sensor foi acionado
        {% set triggered = printer["gcode_macro TESTE_TP223_IND"].sensor_triggered %}
        {% if triggered %}
            {% set z_pos = printer["gcode_macro TESTE_TP223_IND"].trigger_z %}
            {% set measurements = measurements + [z_pos] %}
            RESPOND MSG="‚úÖ Medi√ß√£o {sample + 1}: Z = {z_pos|round(4)}mm"
        {% else %}
            RESPOND MSG="‚ùå ERRO: Sensor TP223 n√£o detectou contato na medi√ß√£o {sample + 1}"
            {action_raise_error("Falha na detec√ß√£o de contato pelo TP223")}
        {% endif %}
        
        # Retra√ß√£o para pr√≥xima medi√ß√£o
        G1 Z{config.reference_z} F{config.probe_speed}
        G4 P{config.settle_time}
    {% endfor %}
    
    # Calcular estat√≠sticas
    {% if measurements|length > 0 %}
        {% set avg_z = (measurements|sum) / measurements|length %}
        {% set min_z = measurements|min %}
        {% set max_z = measurements|max %}
        {% set range_z = max_z - min_z %}
    {% else %}
        {% set avg_z = 0.0 %}
        {% set min_z = 0.0 %}
        {% set max_z = 0.0 %}
        {% set range_z = 0.0 %}
        RESPOND MSG="‚ùå ERRO: Nenhuma medi√ß√£o v√°lida foi obtida"
        {action_raise_error("Falha completa na detec√ß√£o - nenhuma medi√ß√£o v√°lida")}
    {% endif %}
    
    # Verificar toler√¢ncia
    {% if range_z > config.tolerance %}
        RESPOND MSG="‚ö†Ô∏è AVISO: Range {range_z|round(4)}mm excede toler√¢ncia {config.tolerance}mm"
    {% else %}
        RESPOND MSG="‚úÖ Precis√£o OK: Range {range_z|round(4)}mm dentro da toler√¢ncia"
    {% endif %}
    
    # Salvar resultados
    SET_GCODE_VARIABLE MACRO=MEDIR_TP223 VARIABLE=last_measurement VALUE={avg_z}
    SET_GCODE_VARIABLE MACRO=MEDIR_TP223 VARIABLE=measurement_count VALUE={measurements|length}
    
    # Exibir resultados
    RESPOND MSG="üìä ===== RESULTADOS DA MEDI√á√ÉO ====="
    RESPOND MSG="üéØ Dist√¢ncia m√©dia do bico: {avg_z|round(4)}mm"
    RESPOND MSG="üìè Range de medi√ß√µes: {range_z|round(4)}mm"
    RESPOND MSG="üìà M√≠nimo: {min_z|round(4)}mm | M√°ximo: {max_z|round(4)}mm"
    RESPOND MSG="üî¢ Amostras v√°lidas: {measurements|length}/{config.samples}"
    
    # Calcular offset sugerido (assumindo mesa em Z=0)
    {% set suggested_offset = avg_z %}
    RESPOND MSG="üí° Offset Z sugerido: {suggested_offset|round(4)}mm"
    
    # Retornar para posi√ß√£o segura
    G1 Z20 F{config.probe_speed}
    
    RESPOND MSG="‚úÖ Medi√ß√£o autom√°tica conclu√≠da!"

#####################################################################
#                    SONDAGEM COM SENSOR TP223                    #
#####################################################################

[gcode_macro PROBE_TP223_SURFACE]
description: Sondagem usando sensor TP223 com detec√ß√£o de toque capacitivo
gcode:
    {% set config = printer["gcode_macro CALIBRACAO_TP223_CONFIG"] %}
    
    # Salvar posi√ß√£o atual
    {% set start_z = printer.gcode_move.gcode_position.z %}
    
    RESPOND MSG="üîç Iniciando sondagem com TP223..."
    
    # Reset vari√°veis do sensor
    SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=sensor_triggered VALUE=0
    SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=trigger_z VALUE=0.0
    
    # Executar sondagem em duas fases usando macros auxiliares
    G91  # Modo relativo
    
    # Fase 1: Aproxima√ß√£o r√°pida
    RESPOND MSG="‚ö° Iniciando aproxima√ß√£o r√°pida..."
    _PROBE_TP223_FAST_SIMPLE
    
    # Fase 2: Aproxima√ß√£o lenta se necess√°rio
    {% if printer["gcode_macro TESTE_TP223_IND"].sensor_triggered == 0 %}
        RESPOND MSG="üéØ Iniciando aproxima√ß√£o lenta..."
        _PROBE_TP223_SLOW_SIMPLE
    {% endif %}
    
    G90  # Voltar ao modo absoluto
    
    # Verificar resultado final
    {% if printer["gcode_macro TESTE_TP223_IND"].sensor_triggered == 0 %}
        RESPOND MSG="‚ùå ERRO: TP223 n√£o detectou contato ap√≥s sondagem completa"
        RESPOND MSG="üí° Dica: Verifique se o bico est√° pr√≥ximo da superf√≠cie do sensor"
        RESPOND MSG="üí° Dica: Teste manualmente com TESTE_TP223_IND"
        {action_raise_error("Falha na detec√ß√£o de contato pelo TP223")}
    {% endif %}
    
    RESPOND MSG="‚úÖ Sondagem TP223 conclu√≠da com sucesso!"
    RESPOND MSG="üìç Posi√ß√£o final: Z{printer.gcode_move.gcode_position.z}"

# Macro auxiliar para aproxima√ß√£o r√°pida simples
[gcode_macro _PROBE_TP223_FAST_SIMPLE]
gcode:
    # Aproxima√ß√£o r√°pida em passos de 0.5mm at√© 30mm
    {% for i in range(60) %}
        {% if printer["gcode_macro TESTE_TP223_IND"].sensor_triggered == 0 %}
            G1 Z-0.5 F{printer["gcode_macro CALIBRACAO_TP223_CONFIG"].probe_speed}
            G4 P50
            # Verificar sensor TP223 diretamente
        {% endif %}
    {% endfor %}

# Macro auxiliar para aproxima√ß√£o lenta simples
[gcode_macro _PROBE_TP223_SLOW_SIMPLE]
gcode:
    # Aproxima√ß√£o lenta em passos de 0.1mm at√© 4mm adicionais
    {% for i in range(40) %}
        {% if printer["gcode_macro TESTE_TP223_IND"].sensor_triggered == 0 %}
            G1 Z-0.1 F{printer["gcode_macro CALIBRACAO_TP223_CONFIG"].probe_speed_slow}
            G4 P100
            # Verificar sensor TP223 diretamente
        {% endif %}
    {% endfor %}



#####################################################################
#                    CALIBRA√á√ÉO AUTOM√ÅTICA DE OFFSET              #
#####################################################################

[gcode_macro CALIBRAR_OFFSET_Z_TP223]
description: Calibra automaticamente o offset Z usando medi√ß√µes do TP223
gcode:
    {% set tool = params.TOOL|default(printer.toolhead.extruder)|string %}
    {% set save_offset = params.SAVE|default(1)|int %}
    
    RESPOND MSG="üîß ===== CALIBRA√á√ÉO AUTOM√ÅTICA OFFSET Z ====="
    RESPOND MSG="üõ†Ô∏è Ferramenta: {tool}"
    
    # Executar medi√ß√£o autom√°tica
    MEDIR_TP223 TOOL={tool}
        
        # Obter resultado da medi√ß√£o
        {% set measured_distance = printer["gcode_macro MEDIR_TP223"].last_measurement %}
    
    {% if measured_distance > 0 %}
        # Calcular offset (assumindo que a mesa est√° em Z=0)
        {% set calculated_offset = measured_distance %}
        
        RESPOND MSG="üìê Dist√¢ncia medida: {measured_distance|round(4)}mm"
        RESPOND MSG="üéØ Offset Z calculado: {calculated_offset|round(4)}mm"
        
        {% if save_offset %}
            # Salvar offset em variables.cfg
            {% set offset_var = "tool_offset_z_" + tool %}
            SAVE_VARIABLE VARIABLE={offset_var} VALUE={calculated_offset}
            
            # Aplicar offset imediatamente
            SET_GCODE_OFFSET Z={calculated_offset}
            
            RESPOND MSG="üíæ Offset Z salvo e aplicado para {tool}"
            RESPOND MSG="‚úÖ Calibra√ß√£o autom√°tica conclu√≠da!"
        {% else %}
            RESPOND MSG="üí° Offset calculado (n√£o salvo): {calculated_offset|round(4)}mm"
            RESPOND MSG="üîÑ Use SAVE=1 para salvar automaticamente"
        {% endif %}
    {% else %}
        RESPOND MSG="‚ùå ERRO: Medi√ß√£o inv√°lida. Verifique sensor TP223"
    {% endif %}

#####################################################################
#                    MACROS DE TESTE E DIAGN√ìSTICO               #
#####################################################################

[gcode_macro TESTAR_TP223_CALIBRACAO]
description: Teste completo do sistema de calibra√ß√£o TP223
gcode:
    RESPOND MSG="üß™ ===== TESTE SISTEMA CALIBRA√á√ÉO TP223 ====="
    
    # Verificar configura√ß√£o
    {% set config = printer["gcode_macro CALIBRACAO_TP223_CONFIG"] %}
    RESPOND MSG="üìç Posi√ß√£o refer√™ncia: X{config.reference_x} Y{config.reference_y} Z{config.reference_z}"
    RESPOND MSG="üìä Configura√ß√£o: {config.samples} amostras, toler√¢ncia {config.tolerance}mm"
    
    # Verificar sensor TP223
    {% set sensor_state = printer["gcode_macro TESTE_TP223_IND"].sensor_triggered %}
    RESPOND MSG="üîç Estado sensor TP223: {'ACIONADO' if sensor_state else 'LIVRE'}"
    
    # Teste de posicionamento
    RESPOND MSG="üìç Testando posicionamento..."
    G90
    G1 X{config.reference_x} Y{config.reference_y} Z{config.reference_z} F3000
    
    RESPOND MSG="‚úÖ Sistema pronto para calibra√ß√£o autom√°tica"
    RESPOND MSG="üí° Execute: MEDIR_TP223 para teste"
    RESPOND MSG="üí° Execute: CALIBRAR_OFFSET_Z_TP223 para calibra√ß√£o completa"

[gcode_macro STATUS_TP223_CALIBRACAO]
description: Mostra status atual do sistema de calibra√ß√£o TP223
gcode:
    {% set config = printer["gcode_macro CALIBRACAO_TP223_CONFIG"] %}
    {% set last_measurement = printer["gcode_macro MEDIR_TP223"].last_measurement %}
    {% set measurement_count = printer["gcode_macro MEDIR_TP223"].measurement_count %}
    
    RESPOND MSG="üìä ===== STATUS CALIBRA√á√ÉO TP223 ====="
    RESPOND MSG="üîß Sensor: TP223 no GPIO 22"
    RESPOND MSG="üìç Posi√ß√£o refer√™ncia: X{config.reference_x} Y{config.reference_y}"
    RESPOND MSG="üìè √öltima medi√ß√£o: {last_measurement|round(4)}mm"
    RESPOND MSG="üî¢ Total de amostras: {measurement_count}"
    RESPOND MSG="‚öôÔ∏è Configura√ß√£o: {config.samples} amostras, ¬±{config.tolerance}mm"
    
    # Verificar offsets salvos
    {% set tools = ['extruder', 'extruder1', 'extruder2', 'extruder3'] %}
    {% for tool in tools %}
        {% set offset_var = "tool_offset_z_" + tool %}
        {% if offset_var in printer.save_variables.variables %}
            {% set offset_value = printer.save_variables.variables[offset_var] %}
            RESPOND MSG="üéØ {tool}: Z offset = {offset_value|round(4)}mm"
        {% endif %}
    {% endfor %}

#####################################################################
#                         COMANDOS √öTEIS                          #
#####################################################################
# CALIBRACAO_TP223_CONFIG           - Configurar sistema
# MEDIR_TP223                       - Medir dist√¢ncia automaticamente
# CALIBRAR_OFFSET_Z_TP223           - Calibrar offset Z automaticamente
# TESTAR_TP223_CALIBRACAO           - Teste completo do sistema
# STATUS_TP223_CALIBRACAO           - Status atual do sistema
# 
# Exemplos de uso:
# CALIBRACAO_TP223_CONFIG X=320 Y=100 SAMPLES=5 TOLERANCE=0.02
# MEDIR_TP223 TOOL=extruder
# CALIBRAR_OFFSET_Z_TP223 TOOL=extruder SAVE=1
#####################################################################