# ===================================================================
#                 CONFIGURA√á√ÉO COMPLETA SENSOR PIEZOEL√âTRICO
# ===================================================================
# Configura√ß√£o para usar o sensor piezoel√©trico como probe principal
# com base nos testes realizados
#
# POSI√á√ÉO: X320 Y100 (absoluta)
# GPIO: 22
# Z_OFFSET: -0.9mm (sensor 0.9mm abaixo da mesa)
# ===================================================================

# DESCOMENTE ESTA SE√á√ÉO PARA ATIVAR O SENSOR PIEZO COMO PROBE PRINCIPAL
# (Lembre-se de comentar a se√ß√£o [bltouch] se n√£o for usar ambos)

# [probe] - COMENTADO: Voltando a usar BLTouch
# pin: ^host:gpio22                   # GPIO 22 com pullup interno
# x_offset: 280.0                      # Calculado pelo TESTE_OFFSET_PIEZO_BLTOUCH
# y_offset: 150.0                      # Calculado pelo TESTE_OFFSET_PIEZO_BLTOUCH
# z_offset: -1.2                       # Ajustado para compensar espessura da manta
# speed: 5.0                           # Velocidade de aproxima√ß√£o
# samples: 3                           # N√∫mero de amostras por medi√ß√£o
# sample_retract_dist: 2.0             # Dist√¢ncia de retra√ß√£o entre amostras
# samples_result: median               # Usar mediana das amostras
# samples_tolerance: 0.01              # Toler√¢ncia entre amostras
# samples_tolerance_retries: 3         # Tentativas se exceder toler√¢ncia

# ===================================================================
#                        CONFIGURA√á√ÉO ALTERNATIVA
# ===================================================================
# Se quiser manter BLTouch para home e usar piezo para calibra√ß√£o

# Sensor piezoel√©trico como bot√£o para calibra√ß√£o manual
# COMENTADO: Conflito com [probe] ativo
#[gcode_button sensor_piezo_calibracao]
#pin: !host:gpio22
#press_gcode:
#    RESPOND MSG="üîç Sensor piezo ativado na posi√ß√£o X320 Y100"
#    RESPOND MSG="üìè Altura detectada com offset -0.9mm"

# ===================================================================
#                           MACROS DE CALIBRA√á√ÉO
# ===================================================================

[gcode_macro CAL_PZO_MAN]
description: Calibra√ß√£o manual do sensor piezoel√©trico
gcode:
    RESPOND MSG="üéØ ===== CALIBRA√á√ÉO MANUAL SENSOR PIEZO ====="
    
    # Salvar estado
    SAVE_GCODE_STATE NAME=calib_piezo
    G90
    
    # Mover para posi√ß√£o do sensor
    RESPOND MSG="üöÄ Movendo para posi√ß√£o do sensor piezo..."
    G1 X320 Y100 Z10 F3000
    
    # Instru√ß√µes para o usu√°rio
    RESPOND MSG="üìã INSTRU√á√ïES:"
    RESPOND MSG="1. Abaixe o Z manualmente at√© o sensor tocar a mesa"
    RESPOND MSG="2. Quando o sensor ativar, anote a posi√ß√£o Z"
    RESPOND MSG="3. A diferen√ßa para Z=0 + 0.9mm √© seu offset"
    RESPOND MSG="4. Configure z_offset no [probe] com esse valor"
    
    # Aguardar ativa√ß√£o do sensor
    RESPOND MSG="‚è≥ Aguardando ativa√ß√£o do sensor..."
    RESPOND MSG="üí° Use os controles manuais para abaixar o Z"
    
    # Restaurar estado
    RESTORE_GCODE_STATE NAME=calib_piezo

[gcode_macro TST_PRC_PZO]
description: Testa precis√£o do sensor piezoel√©trico
gcode:
    RESPOND MSG="üéØ Testando precis√£o do sensor piezoel√©trico..."
    
    # Salvar posi√ß√£o atual
    SAVE_GCODE_STATE NAME=teste_precisao
    
    # Garantir que estamos em modo absoluto
    G90
    
    # Fazer home para estabelecer refer√™ncia
    RESPOND MSG="üè† Fazendo home para estabelecer refer√™ncia..."
    G28
    
    # Mover para posi√ß√£o do sensor piezo
    RESPOND MSG="üöÄ Movendo para posi√ß√£o do sensor piezo (X320 Y100)..."
    G1 X320 Y100 Z10 F3000
    
    # Teste de detec√ß√£o do sensor TP223
    RESPOND MSG="üîç Testando detec√ß√£o do sensor TP223..."
    
    # Resetar vari√°veis do sensor TP223
    SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=sensor_triggered VALUE=0
    SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=trigger_z VALUE=0
    
    # Aproxima√ß√£o gradual para testar o sensor TP223
    RESPOND MSG="üìâ Descendo gradualmente para testar sensor TP223..."
    
    # Descer gradualmente at√© o sensor ativar
    _DESCIDA_GRADUAL_TP223
    
    # Subir para posi√ß√£o segura
    G1 Z10 F1000
    
    # Executar teste de precis√£o manual com 5 amostras do TP223
    RESPOND MSG="üìä Executando teste de precis√£o com 5 amostras do TP223..."
    
    {% set measurements = [] %}
    {% for sample in range(1, 6) %}
        RESPOND MSG="üìè Amostra {sample}/5..."
        
        # Reset do sensor para nova medi√ß√£o
        SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=sensor_triggered VALUE=0
        SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=trigger_z VALUE=0.0
        
        # Descer at√© ativar o sensor
        _MEDICAO_PRECISAO_TP223 SAMPLE={sample}
        
        # Subir para pr√≥xima medi√ß√£o
        G1 Z10 F1000
        G4 P1000  # Pausa entre medi√ß√µes
    {% endfor %}
    
    # Calcular estat√≠sticas de precis√£o
    {% if measurements|length > 0 %}
        {% set avg_z = (measurements|sum / measurements|length)|round(3) %}
        {% set min_z = measurements|min %}
        {% set max_z = measurements|max %}
        {% set range_z = (max_z - min_z)|round(3) %}
        
        RESPOND MSG="üìä ===== RESULTADOS PRECIS√ÉO TP223 ====="
        RESPOND MSG="üìè M√©dia: {avg_z}mm"
        RESPOND MSG="üìê M√≠nimo: {min_z}mm"
        RESPOND MSG="üìê M√°ximo: {max_z}mm"
        RESPOND MSG="üìè Range: {range_z}mm"
        
        {% if range_z < 0.02 %}
            RESPOND MSG="‚úÖ EXCELENTE: Precis√£o < 0.02mm"
        {% elif range_z < 0.05 %}
            RESPOND MSG="‚úÖ BOA: Precis√£o < 0.05mm"
        {% else %}
            RESPOND MSG="‚ö†Ô∏è ATEN√á√ÉO: Precis√£o > 0.05mm - verificar sensor"
        {% endif %}
    {% else %}
        RESPOND MSG="‚ùå ERRO: Nenhuma medi√ß√£o v√°lida obtida"
    {% endif %}
    
    # Restaurar posi√ß√£o
    RESTORE_GCODE_STATE NAME=teste_precisao
    
    RESPOND MSG="‚úÖ Teste de precis√£o conclu√≠do!"

# ===================================================================
#                        MACROS AUXILIARES
# ===================================================================

[gcode_macro _DESCIDA_GRADUAL_TP223]
description: Descida gradual at√© ativar sensor TP223 com parada imediata
gcode:
    # Descer de 1mm em 1mm at√© o sensor ativar ou atingir Z0
    {% set sensor_ativado = false %}
    {% for step in range(1, 11) %}
        {% if not sensor_ativado %}
            {% set target_z = 10 - step %}
            G1 Z{target_z} F300
            G4 P200  # Pausa para estabilizar
            
            # Verificar se sensor foi ativado ap√≥s movimento
            {% if printer['gcode_button sensor_tp223_teste'].state == 'PRESSED' or printer["gcode_macro TESTE_TP223_IND"].sensor_triggered == 1 %}
                {% set altura_detectada = printer.gcode_move.gcode_position.z %}
                RESPOND MSG="‚úÖ Sensor TP223 ativado! Altura detectada: Z = {altura_detectada}mm"
                {action_respond_info("Sensor ativado - parando descida")}
                # Atualizar vari√°veis da macro
                SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=sensor_triggered VALUE=1
                SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=trigger_z VALUE={altura_detectada}
                # Marcar sensor como ativado para parar o loop
                {% set sensor_ativado = true %}
            {% elif step == 10 %}
                RESPOND MSG="‚ö†Ô∏è AVISO: Sensor TP223 n√£o ativou at√© Z0. Verifique conex√£o!"
            {% endif %}
        {% endif %}
    {% endfor %}

[gcode_macro _MEDICAO_PRECISAO_TP223]
description: Realiza uma medi√ß√£o de precis√£o com o sensor TP223
gcode:
    {% set sample = params.SAMPLE|default(1)|int %}
    
    # Descer de 1mm em 1mm at√© o sensor ativar ou atingir Z0
    {% set sensor_ativado = false %}
    {% for step in range(1, 11) %}
        {% if not sensor_ativado %}
            {% set target_z = 10 - step %}
            G1 Z{target_z} F200  # Velocidade mais lenta para precis√£o
            G4 P300
            
            # Verificar se sensor foi ativado ap√≥s movimento
            {% if printer['gcode_button sensor_tp223_teste'].state == 'PRESSED' or printer["gcode_macro TESTE_TP223_IND"].sensor_triggered == 1 %}
                {% set measured_z = printer.gcode_move.gcode_position.z %}
                RESPOND MSG="   ‚úÖ Medi√ß√£o {sample}: Z = {measured_z}mm"
                # Atualizar vari√°veis da macro
                SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=sensor_triggered VALUE=1
                SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=trigger_z VALUE={measured_z}
                # Marcar sensor como ativado para parar o loop
                {% set sensor_ativado = true %}
            {% elif step == 10 %}
                RESPOND MSG="‚ö†Ô∏è AVISO: Medi√ß√£o {sample} falhou - sensor n√£o ativou"
            {% endif %}
        {% endif %}
    {% endfor %}

[gcode_macro MED_ALT_PZO]
description: Mede altura usando sensor piezoel√©trico
gcode:
    {% if printer.probe is defined %}
        RESPOND MSG="üìè Medindo altura com sensor piezoel√©trico..."
        G1 X320 Y100 Z10 F3000
        PROBE
        {% set altura = printer.probe.last_z_result %}
        RESPOND MSG="üìå Altura medida: Z = {altura}mm"
        RESPOND MSG="üìè Altura real da mesa: {altura + 0.9}mm"
    {% else %}
        RESPOND MSG="‚ùå Sensor n√£o configurado como [probe]"
        RESPOND MSG="üí° Use CALIBRAR_PIEZO_MANUAL para calibra√ß√£o manual"
    {% endif %}

# ===================================================================
#                         EXEMPLO DE USO
# ===================================================================
# 1. Execute: TESTE_OFFSET_PIEZO_BLTOUCH (do arquivo anterior)
# 2. Anote os offsets X e Y calculados
# 3. Descomente a se√ß√£o [probe] acima
# 4. Substitua x_offset e y_offset pelos valores calculados
# 5. Execute: RESTART
# 6. Execute: TESTAR_PRECISAO_PIEZO
# 7. Execute: PROBE_CALIBRATE (se necess√°rio ajustar z_offset)
# ===================================================================

# ===================================================================
#                           COMANDOS √öTEIS
# ===================================================================
# CALIBRAR_PIEZO_MANUAL     - Calibra√ß√£o manual do sensor
# TESTAR_PRECISAO_PIEZO     - Teste de precis√£o (10 amostras)
# MEDIR_ALTURA_PIEZO        - Medi√ß√£o √∫nica de altura
# G1 X320 Y100 Z10 F3000    - Mover para posi√ß√£o do sensor
# QUERY_PROBE               - Verificar status do probe
# ===================================================================