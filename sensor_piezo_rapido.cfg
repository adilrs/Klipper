# Configuração otimizada para sensor piezoelétrico - Detecção de movimentos RÁPIDOS
# O sensor piezoelétrico responde melhor a mudanças rápidas de pressão/vibração

# Sensor piezoelétrico otimizado para movimentos rápidos
# COMENTADO: Conflito com CONFIGURACAO_PIEZO_COMPLETA.cfg
#[gcode_button sensor_piezo]
#pin: host:gpio22  # Sem pull-up para máxima sensibilidade a mudanças rápidas
#press_gcode:
#    RESPOND MSG="⚡ Movimento rápido detectado!"
#release_gcode:
#    RESPOND MSG="🟢 Sensor estabilizado"

# Macro para teste de movimentos rápidos
[gcode_macro TST_MOV_RAP]
description: Teste específico para movimentos rápidos no sensor
gcode:
    RESPOND MSG="⚡ TESTE DE MOVIMENTO RÁPIDO ⚡"
    RESPOND MSG="═══════════════════════════════"
    RESPOND MSG=""
    RESPOND MSG="🎯 COMO TESTAR:"
    RESPOND MSG="1. Dê um TOQUE RÁPIDO no sensor (tap)"
    RESPOND MSG="2. Faça um movimento de 'cutucada' rápida"
    RESPOND MSG="3. Bata levemente com o dedo (como tambor)"
    RESPOND MSG="4. Evite pressão constante - use movimentos dinâmicos"
    RESPOND MSG=""
    RESPOND MSG="✅ MOVIMENTOS QUE FUNCIONAM BEM:"
    RESPOND MSG="- Tap rápido com dedo"
    RESPOND MSG="- Cutucada rápida"
    RESPOND MSG="- Batida leve e rápida"
    RESPOND MSG="- Movimento de 'picar' o sensor"
    RESPOND MSG=""
    RESPOND MSG="❌ MOVIMENTOS QUE NÃO FUNCIONAM:"
    RESPOND MSG="- Pressão lenta e constante"
    RESPOND MSG="- Toque muito suave e lento"
    RESPOND MSG="- Apoiar o dedo sem movimento"
    RESPOND MSG=""
    RESPOND MSG="Estado atual: {printer['gcode_button sensor_piezo'].state}"

# Macro para calibração de velocidade de toque
[gcode_macro CAL_VEL_TCH]
description: Calibra a velocidade ideal de toque para o sensor
gcode:
    RESPOND MSG="🏃 CALIBRAÇÃO DE VELOCIDADE DE TOQUE"
    RESPOND MSG="═══════════════════════════════════"
    RESPOND MSG=""
    RESPOND MSG="Vamos testar diferentes velocidades de toque:"
    RESPOND MSG=""
    
    # Teste 1 - Muito lento
    RESPOND MSG="🐌 TESTE 1: TOQUE MUITO LENTO"
    RESPOND MSG="Toque o sensor MUITO devagar (2-3 segundos)"
    RESPOND MSG="Aguardando 5 segundos para teste..."
    G4 P5000
    RESPOND MSG="Resultado Lento: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    
    # Teste 2 - Velocidade normal
    RESPOND MSG="🚶 TESTE 2: TOQUE VELOCIDADE NORMAL"
    RESPOND MSG="Toque o sensor em velocidade normal (1 segundo)"
    RESPOND MSG="Aguardando 5 segundos para teste..."
    G4 P5000
    RESPOND MSG="Resultado Normal: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    
    # Teste 3 - Rápido
    RESPOND MSG="🏃 TESTE 3: TOQUE RÁPIDO"
    RESPOND MSG="Dê um TAP rápido no sensor (0.2-0.5 segundos)"
    RESPOND MSG="Aguardando 5 segundos para teste..."
    G4 P5000
    RESPOND MSG="Resultado Rápido: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    
    # Teste 4 - Muito rápido
    RESPOND MSG="⚡ TESTE 4: TOQUE MUITO RÁPIDO"
    RESPOND MSG="Dê uma 'cutucada' super rápida (como estalar dedos)"
    RESPOND MSG="Aguardando 5 segundos para teste..."
    G4 P5000
    RESPOND MSG="Resultado Muito Rápido: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    
    RESPOND MSG="📊 ANÁLISE:"
    RESPOND MSG="- Sensores piezo respondem melhor a mudanças RÁPIDAS"
    RESPOND MSG="- Teste 3 e 4 devem ter melhores resultados"
    RESPOND MSG="- Se só Teste 4 funciona: sensor está bem calibrado"
    RESPOND MSG="- Se nenhum funciona: verifique conexões"

# Macro para simular toque de probe automático
[gcode_macro SIM_PRB_RAP]
description: Simula como seria o toque do probe automático
gcode:
    RESPOND MSG="🤖 SIMULAÇÃO DE PROBE AUTOMÁTICO"
    RESPOND MSG="═══════════════════════════════"
    RESPOND MSG=""
    RESPOND MSG="Esta simulação mostra como o sensor detectaria"
    RESPOND MSG="o toque rápido durante uma calibração automática."
    RESPOND MSG=""
    RESPOND MSG="🎯 CENÁRIO: Bico descendo e tocando a mesa"
    RESPOND MSG="- Movimento: Rápido e preciso"
    RESPOND MSG="- Duração: Muito breve (milissegundos)"
    RESPOND MSG="- Tipo: Impacto dinâmico"
    RESPOND MSG=""
    RESPOND MSG="Para simular, dê um TAP rápido como se fosse"
    RESPOND MSG="o bico tocando a mesa durante calibração."
    RESPOND MSG=""
    RESPOND MSG="Estado inicial: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    RESPOND MSG="👆 SIMULE AGORA: Tap rápido no sensor!"
    RESPOND MSG="(Como se o bico tivesse tocado a mesa)"

# Macro para monitoramento de resposta rápida
[gcode_macro MON_RSP_RAP]
description: Monitora a resposta do sensor a movimentos rápidos
gcode:
    {% set duracao = params.DURACAO|default(30)|int %}
    
    RESPOND MSG="⚡ MONITOR DE RESPOSTA RÁPIDA"
    RESPOND MSG="═══════════════════════════════"
    RESPOND MSG="Duração: {duracao} segundos"
    RESPOND MSG=""
    RESPOND MSG="🎯 INSTRUÇÕES:"
    RESPOND MSG="1. Faça vários TAPs rápidos no sensor"
    RESPOND MSG="2. Varie a velocidade dos toques"
    RESPOND MSG="3. Observe qual velocidade detecta melhor"
    RESPOND MSG="4. Anote o padrão de resposta"
    RESPOND MSG=""
    
    {% set total_checks = duracao * 4 %}  # Verifica a cada 0.25s para capturar movimentos rápidos
    {% for i in range(total_checks) %}
        {% set tempo = (i * 0.25)|round(2) %}
        {% set estado = printer['gcode_button sensor_piezo'].state %}
        
        {% if estado == 1 %}
            RESPOND MSG="⚡ {tempo}s: MOVIMENTO DETECTADO!"
        {% endif %}
        
        G4 P250  # 0.25 segundos - frequência alta para capturar movimentos rápidos
        
        {% if (i + 1) % 40 == 0 %}
            {% set progresso = ((i + 1) / total_checks * 100)|int %}
            RESPOND MSG="📊 {progresso}% - Continue testando movimentos rápidos..."
        {% endif %}
    {% endfor %}
    
    RESPOND MSG="✅ Monitoramento concluído!"
    RESPOND MSG="Revise quantos movimentos foram detectados"

# Macro de dicas para otimização
[gcode_macro DIC_SNS_RAP]
description: Dicas para otimizar sensor piezoelétrico para movimentos rápidos
gcode:
    RESPOND MSG="💡 DICAS PARA SENSOR PIEZOELÉTRICO RÁPIDO"
    RESPOND MSG="═══════════════════════════════════════"
    RESPOND MSG=""
    RESPOND MSG="🔧 CONFIGURAÇÃO FÍSICA:"
    RESPOND MSG="- Fixe bem o sensor na mesa/superfície"
    RESPOND MSG="- Evite superfícies que absorvem vibração"
    RESPOND MSG="- Mantenha conexões firmes e curtas"
    RESPOND MSG="- Use cabo blindado se possível"
    RESPOND MSG=""
    RESPOND MSG="⚡ OTIMIZAÇÃO PARA VELOCIDADE:"
    RESPOND MSG="- Sensor piezo = detector de MUDANÇA, não pressão"
    RESPOND MSG="- Funciona melhor com impactos rápidos"
    RESPOND MSG="- Ideal para probe automático (toque e solta rápido)"
    RESPOND MSG="- Não funciona bem com pressão constante"
    RESPOND MSG=""
    RESPOND MSG="🎯 PARA CALIBRAÇÃO AUTOMÁTICA:"
    RESPOND MSG="- Configure velocidade de probe baixa (1-3mm/s)"
    RESPOND MSG="- Use retração rápida após detecção"
    RESPOND MSG="- Ajuste altura Z para toque leve mas definido"
    RESPOND MSG="- Teste com diferentes materiais de superfície"
    RESPOND MSG=""
    RESPOND MSG="🔍 TROUBLESHOOTING:"
    RESPOND MSG="- Se não detecta: aumente velocidade do movimento"
    RESPOND MSG="- Se detecta demais: reduza sensibilidade na placa"
    RESPOND MSG="- Se instável: verifique fixação e blindagem"