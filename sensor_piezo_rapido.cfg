# ConfiguraÃ§Ã£o otimizada para sensor piezoelÃ©trico - DetecÃ§Ã£o de movimentos RÃPIDOS
# O sensor piezoelÃ©trico responde melhor a mudanÃ§as rÃ¡pidas de pressÃ£o/vibraÃ§Ã£o

# Sensor piezoelÃ©trico otimizado para movimentos rÃ¡pidos
# COMENTADO: Conflito com CONFIGURACAO_PIEZO_COMPLETA.cfg
#[gcode_button sensor_piezo]
#pin: host:gpio22  # Sem pull-up para mÃ¡xima sensibilidade a mudanÃ§as rÃ¡pidas
#press_gcode:
#    RESPOND MSG="âš¡ Movimento rÃ¡pido detectado!"
#release_gcode:
#    RESPOND MSG="ğŸŸ¢ Sensor estabilizado"

# Macro para teste de movimentos rÃ¡pidos
[gcode_macro TST_MOV_RAP]
description: Teste especÃ­fico para movimentos rÃ¡pidos no sensor
gcode:
    RESPOND MSG="âš¡ TESTE DE MOVIMENTO RÃPIDO âš¡"
    RESPOND MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND MSG=""
    RESPOND MSG="ğŸ¯ COMO TESTAR:"
    RESPOND MSG="1. DÃª um TOQUE RÃPIDO no sensor (tap)"
    RESPOND MSG="2. FaÃ§a um movimento de 'cutucada' rÃ¡pida"
    RESPOND MSG="3. Bata levemente com o dedo (como tambor)"
    RESPOND MSG="4. Evite pressÃ£o constante - use movimentos dinÃ¢micos"
    RESPOND MSG=""
    RESPOND MSG="âœ… MOVIMENTOS QUE FUNCIONAM BEM:"
    RESPOND MSG="- Tap rÃ¡pido com dedo"
    RESPOND MSG="- Cutucada rÃ¡pida"
    RESPOND MSG="- Batida leve e rÃ¡pida"
    RESPOND MSG="- Movimento de 'picar' o sensor"
    RESPOND MSG=""
    RESPOND MSG="âŒ MOVIMENTOS QUE NÃƒO FUNCIONAM:"
    RESPOND MSG="- PressÃ£o lenta e constante"
    RESPOND MSG="- Toque muito suave e lento"
    RESPOND MSG="- Apoiar o dedo sem movimento"
    RESPOND MSG=""
    RESPOND MSG="Estado atual: {printer['gcode_button sensor_piezo'].state}"

# Macro para calibraÃ§Ã£o de velocidade de toque
[gcode_macro CAL_VEL_TCH]
description: Calibra a velocidade ideal de toque para o sensor
gcode:
    RESPOND MSG="ğŸƒ CALIBRAÃ‡ÃƒO DE VELOCIDADE DE TOQUE"
    RESPOND MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND MSG=""
    RESPOND MSG="Vamos testar diferentes velocidades de toque:"
    RESPOND MSG=""
    
    # Teste 1 - Muito lento
    RESPOND MSG="ğŸŒ TESTE 1: TOQUE MUITO LENTO"
    RESPOND MSG="Toque o sensor MUITO devagar (2-3 segundos)"
    RESPOND MSG="Aguardando 5 segundos para teste..."
    G4 P5000
    RESPOND MSG="Resultado Lento: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    
    # Teste 2 - Velocidade normal
    RESPOND MSG="ğŸš¶ TESTE 2: TOQUE VELOCIDADE NORMAL"
    RESPOND MSG="Toque o sensor em velocidade normal (1 segundo)"
    RESPOND MSG="Aguardando 5 segundos para teste..."
    G4 P5000
    RESPOND MSG="Resultado Normal: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    
    # Teste 3 - RÃ¡pido
    RESPOND MSG="ğŸƒ TESTE 3: TOQUE RÃPIDO"
    RESPOND MSG="DÃª um TAP rÃ¡pido no sensor (0.2-0.5 segundos)"
    RESPOND MSG="Aguardando 5 segundos para teste..."
    G4 P5000
    RESPOND MSG="Resultado RÃ¡pido: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    
    # Teste 4 - Muito rÃ¡pido
    RESPOND MSG="âš¡ TESTE 4: TOQUE MUITO RÃPIDO"
    RESPOND MSG="DÃª uma 'cutucada' super rÃ¡pida (como estalar dedos)"
    RESPOND MSG="Aguardando 5 segundos para teste..."
    G4 P5000
    RESPOND MSG="Resultado Muito RÃ¡pido: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    
    RESPOND MSG="ğŸ“Š ANÃLISE:"
    RESPOND MSG="- Sensores piezo respondem melhor a mudanÃ§as RÃPIDAS"
    RESPOND MSG="- Teste 3 e 4 devem ter melhores resultados"
    RESPOND MSG="- Se sÃ³ Teste 4 funciona: sensor estÃ¡ bem calibrado"
    RESPOND MSG="- Se nenhum funciona: verifique conexÃµes"

# Macro para simular toque de probe automÃ¡tico
[gcode_macro SIM_PRB_RAP]
description: Simula como seria o toque do probe automÃ¡tico
gcode:
    RESPOND MSG="ğŸ¤– SIMULAÃ‡ÃƒO DE PROBE AUTOMÃTICO"
    RESPOND MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND MSG=""
    RESPOND MSG="Esta simulaÃ§Ã£o mostra como o sensor detectaria"
    RESPOND MSG="o toque rÃ¡pido durante uma calibraÃ§Ã£o automÃ¡tica."
    RESPOND MSG=""
    RESPOND MSG="ğŸ¯ CENÃRIO: Bico descendo e tocando a mesa"
    RESPOND MSG="- Movimento: RÃ¡pido e preciso"
    RESPOND MSG="- DuraÃ§Ã£o: Muito breve (milissegundos)"
    RESPOND MSG="- Tipo: Impacto dinÃ¢mico"
    RESPOND MSG=""
    RESPOND MSG="Para simular, dÃª um TAP rÃ¡pido como se fosse"
    RESPOND MSG="o bico tocando a mesa durante calibraÃ§Ã£o."
    RESPOND MSG=""
    RESPOND MSG="Estado inicial: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    RESPOND MSG="ğŸ‘† SIMULE AGORA: Tap rÃ¡pido no sensor!"
    RESPOND MSG="(Como se o bico tivesse tocado a mesa)"

# Macro para monitoramento de resposta rÃ¡pida
[gcode_macro MON_RSP_RAP]
description: Monitora a resposta do sensor a movimentos rÃ¡pidos
gcode:
    {% set duracao = params.DURACAO|default(30)|int %}
    
    RESPOND MSG="âš¡ MONITOR DE RESPOSTA RÃPIDA"
    RESPOND MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND MSG="DuraÃ§Ã£o: {duracao} segundos"
    RESPOND MSG=""
    RESPOND MSG="ğŸ¯ INSTRUÃ‡Ã•ES:"
    RESPOND MSG="1. FaÃ§a vÃ¡rios TAPs rÃ¡pidos no sensor"
    RESPOND MSG="2. Varie a velocidade dos toques"
    RESPOND MSG="3. Observe qual velocidade detecta melhor"
    RESPOND MSG="4. Anote o padrÃ£o de resposta"
    RESPOND MSG=""
    
    {% set total_checks = duracao * 4 %}  # Verifica a cada 0.25s para capturar movimentos rÃ¡pidos
    {% for i in range(total_checks) %}
        {% set tempo = (i * 0.25)|round(2) %}
        {% set estado = printer['gcode_button sensor_piezo'].state %}
        
        {% if estado == 1 %}
            RESPOND MSG="âš¡ {tempo}s: MOVIMENTO DETECTADO!"
        {% endif %}
        
        G4 P250  # 0.25 segundos - frequÃªncia alta para capturar movimentos rÃ¡pidos
        
        {% if (i + 1) % 40 == 0 %}
            {% set progresso = ((i + 1) / total_checks * 100)|int %}
            RESPOND MSG="ğŸ“Š {progresso}% - Continue testando movimentos rÃ¡pidos..."
        {% endif %}
    {% endfor %}
    
    RESPOND MSG="âœ… Monitoramento concluÃ­do!"
    RESPOND MSG="Revise quantos movimentos foram detectados"

# Macro de dicas para otimizaÃ§Ã£o
[gcode_macro DIC_SNS_RAP]
description: Dicas para otimizar sensor piezoelÃ©trico para movimentos rÃ¡pidos
gcode:
    RESPOND MSG="ğŸ’¡ DICAS PARA SENSOR PIEZOELÃ‰TRICO RÃPIDO"
    RESPOND MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND MSG=""
    RESPOND MSG="ğŸ”§ CONFIGURAÃ‡ÃƒO FÃSICA:"
    RESPOND MSG="- Fixe bem o sensor na mesa/superfÃ­cie"
    RESPOND MSG="- Evite superfÃ­cies que absorvem vibraÃ§Ã£o"
    RESPOND MSG="- Mantenha conexÃµes firmes e curtas"
    RESPOND MSG="- Use cabo blindado se possÃ­vel"
    RESPOND MSG=""
    RESPOND MSG="âš¡ OTIMIZAÃ‡ÃƒO PARA VELOCIDADE:"
    RESPOND MSG="- Sensor piezo = detector de MUDANÃ‡A, nÃ£o pressÃ£o"
    RESPOND MSG="- Funciona melhor com impactos rÃ¡pidos"
    RESPOND MSG="- Ideal para probe automÃ¡tico (toque e solta rÃ¡pido)"
    RESPOND MSG="- NÃ£o funciona bem com pressÃ£o constante"
    RESPOND MSG=""
    RESPOND MSG="ğŸ¯ PARA CALIBRAÃ‡ÃƒO AUTOMÃTICA:"
    RESPOND MSG="- Configure velocidade de probe baixa (1-3mm/s)"
    RESPOND MSG="- Use retraÃ§Ã£o rÃ¡pida apÃ³s detecÃ§Ã£o"
    RESPOND MSG="- Ajuste altura Z para toque leve mas definido"
    RESPOND MSG="- Teste com diferentes materiais de superfÃ­cie"
    RESPOND MSG=""
    RESPOND MSG="ğŸ” TROUBLESHOOTING:"
    RESPOND MSG="- Se nÃ£o detecta: aumente velocidade do movimento"
    RESPOND MSG="- Se detecta demais: reduza sensibilidade na placa"
    RESPOND MSG="- Se instÃ¡vel: verifique fixaÃ§Ã£o e blindagem"