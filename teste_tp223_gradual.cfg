# Script de Teste Gradual do Sensor TP223
# Testa o sensor descendo de 1 em 1mm até o disparo

[gcode_macro TST_TP223]
description: Teste gradual do sensor TP223 descendo de 1 em 1mm
gcode:
    # Verificar se o sensor está configurado
    {% if not printer.probe %}
        RESPOND TYPE=error MSG="Sensor probe não configurado!"
        { action_raise_error("Sensor probe não encontrado") }
    {% endif %}
    
    RESPOND TYPE=command MSG="TST_TP223: Iniciando teste gradual do sensor TP223..."
    
    # Fazer homing
    G28
    
    # Posicionar no ponto de teste do TP223 (centro da mesa)
    G90  ; Modo absoluto
    G1 X150 Y150 F6000  ; Posicionar no centro (ajustar conforme sua impressora)
    
    # Iniciar a 10mm de altura
    G1 Z10 F1000
    RESPOND TYPE=command MSG="Posicionado a 10mm de altura"
    
    # Loop para descer de 1 em 1mm e testar o sensor
    {% for altura in [9, 8, 7, 6, 5, 4, 3, 2, 1, 0] %}
        # Descer para altura atual
        G1 Z{altura} F300
        
        # Aguardar estabilização
        G4 P500
        
        # Verificar estado do sensor
        {% if printer.probe.last_query %}
            RESPOND TYPE=command MSG="TST_TP223: Sensor DISPAROU na altura Z={altura}mm!"
            # Subir para posição segura
            G1 Z20 F1000
            RESPOND TYPE=command MSG="TST_TP223: Teste concluído - sensor funcionando corretamente"
            # Sair do loop
            {% set altura = -1 %}
        {% else %}
            RESPOND TYPE=command MSG="Z={altura}mm - Sensor não disparou"
        {% endif %}
        
        # Se chegou a Z=0 sem disparo
        {% if altura == 0 %}
            RESPOND TYPE=error MSG="TST_TP223: ATENÇÃO: Sensor não disparou até Z=0mm!"
            G1 Z20 F1000
            RESPOND TYPE=error MSG="Verificar instalação e configuração do sensor"
        {% endif %}
    {% endfor %}
    
    # Retornar para posição segura
    G1 Z20 F1000
    G1 X0 Y0 F6000
    RESPOND TYPE=command MSG="Teste finalizado"

[gcode_macro TESTE_TP223_MANUAL]
description: Teste manual do sensor TP223 com altura específica
gcode:
    {% set altura = params.Z|default(5)|float %}
    
    RESPOND TYPE=command MSG="Testando sensor TP223 na altura Z={altura}mm"
    
    # Fazer homing
    G28
    
    # Posicionar no ponto de teste
    G90
    G1 X150 Y150 F6000
    G1 Z{altura} F1000
    
    # Aguardar e testar
    G4 P1000
    
    {% if printer.probe.last_query %}
        RESPOND TYPE=command MSG="Sensor DISPARADO na altura Z={altura}mm"
    {% else %}
        RESPOND TYPE=command MSG="Sensor NÃO disparado na altura Z={altura}mm"
    {% endif %}
    
    # Retornar para posição segura
    G1 Z20 F1000
    G1 X0 Y0 F6000

[gcode_macro STATUS_SENSOR_TP223]
description: Mostra o status atual do sensor TP223
gcode:
    {% if printer.probe %}
        {% if printer.probe.last_query %}
            RESPOND TYPE=command MSG="Sensor TP223: DISPARADO"
        {% else %}
            RESPOND TYPE=command MSG="Sensor TP223: NÃO DISPARADO"
        {% endif %}
    {% else %}
        RESPOND TYPE=error MSG="Sensor probe não configurado!"
    {% endif %}

# Instruções de uso:
# 1. TESTE_TP223_GRADUAL - Teste automático descendo de 1 em 1mm
# 2. TESTE_TP223_MANUAL Z=5 - Teste manual em altura específica
# 3. STATUS_SENSOR_TP223 - Verificar status atual do sensor
#
# IMPORTANTE: Ajustar as coordenadas X150 Y150 conforme o centro da sua mesa
# e verificar se o sensor está corretamente configurado no printer.cfg