# ===================================================================
# VERIFICA√á√ÉO E CORRE√á√ÉO DE ESTADO DE FERRAMENTA
# ===================================================================

[gcode_macro VERIFICAR_ESTADO_FERRAMENTA]
description: Verifica se o estado salvo corresponde ao estado f√≠sico real
gcode:
    # Verificar estado f√≠sico usando LIDAR
    {% if printer["gcode_macro LIDAR_MODE"].status %}
        {% set lidar = printer["gcode_macro DISTANCIA_VL53"].distancia|float %}
    {% else %}
        {% set lidar = 100.0 %}
    {% endif %}
    
    {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
    {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
    {% set show_saved = saved_tool - 1 %}
    {% set show_current = current_tool - 1 %}
    
    RESPOND PREFIX="INFO" MSG="üîç ===== VERIFICA√á√ÉO DE ESTADO ====="
    RESPOND PREFIX="INFO" MSG="üìä Estado salvo: T{show_saved} (TOOL={saved_tool})"
    RESPOND PREFIX="INFO" MSG="üìä Estado atual: T{show_current} (TOOL={current_tool})"
    RESPOND PREFIX="INFO" MSG="üìä LIDAR: {lidar}mm"
    
    # Verificar consist√™ncia
    {% if lidar <= 110 %}
        RESPOND PREFIX="INFO" MSG="‚úÖ Ferramenta f√≠sica detectada"
        {% if saved_tool == current_tool %}
            RESPOND PREFIX="INFO" MSG="‚úÖ Estados sincronizados - sistema OK"
        {% else %}
            RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è Estados dessincronizados - corrigindo..."
            SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={saved_tool}
            RESPOND PREFIX="INFO" MSG="üîÑ Estado corrigido para T{show_saved}"
        {% endif %}
    {% else %}
        RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è Nenhuma ferramenta f√≠sica detectada"
        {% if saved_tool != 1 or current_tool != 1 %}
            RESPOND PREFIX="INFO" MSG="üîÑ Corrigindo para T0 (sem ferramenta)..."
            SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=1
            SAVE_VARIABLE VARIABLE=tool VALUE=1
            RESPOND PREFIX="INFO" MSG="‚úÖ Estado corrigido para T0"
        {% else %}
            RESPOND PREFIX="INFO" MSG="‚úÖ Estado j√° correto (T0)"
        {% endif %}
    {% endif %}

[gcode_macro CORRIGIR_FERRAMENTA_FISICA]
description: For√ßa corre√ß√£o quando h√° inconsist√™ncia f√≠sica
gcode:
    {% set tool_solicitada = params.TOOL|default(1)|int %}
    
    # Verificar estado f√≠sico usando LIDAR
    {% if printer["gcode_macro LIDAR_MODE"].status %}
        {% set lidar = printer["gcode_macro DISTANCIA_VL53"].distancia|float %}
    {% else %}
        {% set lidar = 100.0 %}
    {% endif %}
    
    RESPOND PREFIX="INFO" MSG="üîß ===== CORRE√á√ÉO FOR√áADA ====="
    RESPOND PREFIX="INFO" MSG="üéØ Ferramenta solicitada: T{tool_solicitada - 1} (TOOL={tool_solicitada})"
    RESPOND PREFIX="INFO" MSG="üìä LIDAR: {lidar}mm"
    
    {% if lidar <= 110 %}
        RESPOND PREFIX="INFO" MSG="‚úÖ Ferramenta f√≠sica detectada - aplicando corre√ß√£o"
        # Atualizar estados
        SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={tool_solicitada}
        SAVE_VARIABLE VARIABLE=tool VALUE={tool_solicitada}
        
        # Ativar extrusora correta
        {% set extruders = {
            1: "extruder", 2: "extruder1", 3: "extruder2"
        } %}
        {% if tool_solicitada in extruders %}
            ACTIVATE_EXTRUDER EXTRUDER={extruders[tool_solicitada]}
            RESPOND PREFIX="INFO" MSG="üîÑ Extrusora {extruders[tool_solicitada]} ativada"
        {% endif %}
        
        # Aplicar offsets corretos
        APPLY_TOOL_OFFSET
        
        {% set show_t = tool_solicitada - 1 %}
        RESPOND PREFIX="INFO" MSG="‚úÖ Corre√ß√£o conclu√≠da - T{show_t} ativa"
        M117 Ferramenta corrigida: T{show_t}
    {% else %}
        RESPOND PREFIX="ERROR" MSG="‚ùå Nenhuma ferramenta f√≠sica detectada - n√£o √© poss√≠vel corrigir"
        RESPOND PREFIX="INFO" MSG="üí° Sugest√£o: Carregue fisicamente uma ferramenta primeiro"
        M117 Erro: Sem ferramenta f√≠sica
    {% endif %}

[gcode_macro RESET_FERRAMENTA_SEGURO]
description: Reset completo para estado seguro (T0)
gcode:
    RESPOND PREFIX="INFO" MSG="üîÑ ===== RESET PARA ESTADO SEGURO ====="
    
    # For√ßar T0 em todos os estados
    SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=1
    SAVE_VARIABLE VARIABLE=tool VALUE=1
    
    # Ativar extrusora principal
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    
    # Aplicar offset zero
    SET_GCODE_OFFSET X=0 Y=0 Z=0
    
    RESPOND PREFIX="INFO" MSG="‚úÖ Sistema resetado para T0 (estado seguro)"
    M117 Reset: T0 ativa

[gcode_macro PRE_PRINT_CHECK]
description: Verifica√ß√£o completa antes de iniciar impress√£o
gcode:
    RESPOND PREFIX="INFO" MSG="üîç ===== VERIFICA√á√ÉO PR√â-IMPRESS√ÉO ====="
    
    # Executar verifica√ß√£o completa
    VERIFICAR_ESTADO_FERRAMENTA
    
    # Verificar se h√° inconsist√™ncias
    {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
    {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
    
    {% if saved_tool != current_tool %}
        RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è ATEN√á√ÉO: Estados dessincronizados detectados!"
        RESPOND PREFIX="INFO" MSG="üí° Recomenda√ß√£o: Execute CORRIGIR_FERRAMENTA_FISICA antes de imprimir"
        M117 ATEN√á√ÉO: Estados dessincronizados
    {% else %}
        RESPOND PREFIX="INFO" MSG="‚úÖ Sistema verificado - pronto para impress√£o"
        M117 Sistema verificado - OK
    {% endif %}

[gcode_macro DIAGNOSTICO_TROMBAMENTO]
description: Diagn√≥stico espec√≠fico para problemas de trombamento de ferramenta
gcode:
    RESPOND PREFIX="INFO" MSG="üîç ===== DIAGN√ìSTICO DE TROMBAMENTO ====="
    
    # Estado atual do sistema
    {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
    {% set current_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
    {% set show_saved = saved_tool - 1 %}
    {% set show_current = current_tool - 1 %}
    
    RESPOND PREFIX="INFO" MSG="üìä Estado salvo: T{show_saved} (TOOL={saved_tool})"
    RESPOND PREFIX="INFO" MSG="üìä Estado atual: T{show_current} (TOOL={current_tool})"
    
    # Verificar LIDAR
    {% if printer["gcode_macro LIDAR_MODE"].status %}
        {% set lidar = printer["gcode_macro DISTANCIA_VL53"].distancia|float %}
        RESPOND PREFIX="INFO" MSG="üìä LIDAR: ATIVO ({lidar}mm)"
        {% if lidar <= 110 %}
            RESPOND PREFIX="INFO" MSG="‚úÖ Ferramenta f√≠sica detectada"
        {% else %}
            RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è Nenhuma ferramenta f√≠sica detectada"
        {% endif %}
    {% else %}
        RESPOND PREFIX="WARNING" MSG="üìä LIDAR: DESATIVADO (usando valores simulados)"
        RESPOND PREFIX="INFO" MSG="üí° Execute 'LIDAR_ON' para ativar detec√ß√£o f√≠sica"
    {% endif %}
    
    # An√°lise de risco de trombamento
    RESPOND PREFIX="INFO" MSG="üîç AN√ÅLISE DE RISCO:"
    
    {% if saved_tool != current_tool %}
        RESPOND PREFIX="ERROR" MSG="‚ùå ALTO RISCO: Estados dessincronizados!"
        RESPOND PREFIX="INFO" MSG="   Causa prov√°vel: Reinicializa√ß√£o sem detec√ß√£o f√≠sica correta"
        RESPOND PREFIX="INFO" MSG="   Solu√ß√£o: CORRIGIR_FERRAMENTA_FISICA TOOL={saved_tool}"
    {% elif not printer["gcode_macro LIDAR_MODE"].status %}
        RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è M√âDIO RISCO: LIDAR desativado"
        RESPOND PREFIX="INFO" MSG="   Sistema confia apenas no estado salvo"
        RESPOND PREFIX="INFO" MSG="   Solu√ß√£o: LIDAR_ON para detec√ß√£o f√≠sica"
    {% else %}
        {% set lidar = printer["gcode_macro DISTANCIA_VL53"].distancia|float %}
        {% if (saved_tool > 1 and lidar > 110) or (saved_tool == 1 and lidar <= 110) %}
            RESPOND PREFIX="WARNING" MSG="‚ö†Ô∏è M√âDIO RISCO: Estado vs realidade f√≠sica inconsistente"
            RESPOND PREFIX="INFO" MSG="   Estado indica T{show_saved}, mas LIDAR indica o contr√°rio"
            RESPOND PREFIX="INFO" MSG="   Solu√ß√£o: Verificar fisicamente e usar CORRIGIR_FERRAMENTA_FISICA"
        {% else %}
            RESPOND PREFIX="INFO" MSG="‚úÖ BAIXO RISCO: Estados consistentes"
        {% endif %}
    {% endif %}
    
    RESPOND PREFIX="INFO" MSG="üõ†Ô∏è COMANDOS DE CORRE√á√ÉO DISPON√çVEIS:"
    RESPOND PREFIX="INFO" MSG="   LIDAR_ON - Ativar detec√ß√£o f√≠sica"
    RESPOND PREFIX="INFO" MSG="   CORRIGIR_FERRAMENTA_FISICA TOOL=X - For√ßar corre√ß√£o"
    RESPOND PREFIX="INFO" MSG="   RESET_FERRAMENTA_SEGURO - Reset completo para T0"
    RESPOND PREFIX="INFO" MSG="   STARTUP - Reinicializar sistema com nova l√≥gica"