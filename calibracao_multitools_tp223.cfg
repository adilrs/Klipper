#####################################################################
#           SISTEMA DE CALIBRA√á√ÉO MULTI-FERRAMENTAS TP223         #
#####################################################################
# Sistema de Calibra√ß√£o Multi-Ferramentas usando TP223
# T0 = Refer√™ncia base (configurado pelo sistema normal do Klipper)
# T1-T3 = Offsets relativos a T0 (salvos em variables.cfg)
# Vers√£o: 1.0 - Sistema Comparativo
# Data: Janeiro 2025

[gcode_macro CALIB_MT_CONFIG]
description: Configura√ß√µes do sistema de calibra√ß√£o multi-ferramentas
variable_reference_x: 320.0             # Posi√ß√£o X da superf√≠cie de refer√™ncia
variable_reference_y: 100.0             # Posi√ß√£o Y da superf√≠cie de refer√™ncia
variable_reference_z: 10.0              # Altura inicial segura
variable_probe_speed: 300               # Velocidade de aproxima√ß√£o (mm/min)
variable_probe_speed_slow: 60           # Velocidade final de toque (mm/min)
variable_probe_distance: 15.0           # Dist√¢ncia m√°xima de sondagem
variable_samples: 5                     # N√∫mero de amostras por medi√ß√£o
variable_tolerance: 0.02                # Toler√¢ncia entre amostras (mm)
variable_retract_distance: 5.0          # Dist√¢ncia de retra√ß√£o ap√≥s toque
variable_settle_time: 1000              # Tempo de estabiliza√ß√£o (ms)
variable_tools_enabled: [0, 1, 2]       # Ferramentas ativas (T3 desativado)
variable_t0_reference_z: 0.0            # Refer√™ncia Z do T0 (medida)
variable_last_calibration_time: ""      # Timestamp da √∫ltima calibra√ß√£o
gcode:
    {% set x_pos = params.X|default(320)|float %}
    {% set y_pos = params.Y|default(100)|float %}
    {% set z_pos = params.Z|default(10)|float %}
    {% set speed = params.SPEED|default(300)|int %}
    {% set slow_speed = params.SLOW_SPEED|default(60)|int %}
    {% set distance = params.DISTANCE|default(15)|float %}
    {% set samples = params.SAMPLES|default(5)|int %}
    {% set tolerance = params.TOLERANCE|default(0.02)|float %}
    
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_MULTITOOLS_CONFIG VARIABLE=reference_x VALUE={x_pos}
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_MULTITOOLS_CONFIG VARIABLE=reference_y VALUE={y_pos}
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_MULTITOOLS_CONFIG VARIABLE=reference_z VALUE={z_pos}
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_MULTITOOLS_CONFIG VARIABLE=probe_speed VALUE={speed}
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_MULTITOOLS_CONFIG VARIABLE=probe_speed_slow VALUE={slow_speed}
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_MULTITOOLS_CONFIG VARIABLE=probe_distance VALUE={distance}
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_MULTITOOLS_CONFIG VARIABLE=samples VALUE={samples}
    SET_GCODE_VARIABLE MACRO=CALIBRACAO_MULTITOOLS_CONFIG VARIABLE=tolerance VALUE={tolerance}
    
    RESPOND MSG="‚úÖ Configura√ß√£o multi-ferramentas atualizada: X{x_pos} Y{y_pos} Z{z_pos}"
    RESPOND MSG="üìä Amostras: {samples}, Toler√¢ncia: {tolerance}mm, Velocidade: {speed}mm/min"

#####################################################################
#                    CALIBRA√á√ÉO T0 COMO REFER√äNCIA                #
#####################################################################

[gcode_macro CAL_T0]
description: Calibra T0 como referencia base usando TP223
variable_t0_average_z: 0.0
variable_calibration_status: "not_calibrated"
gcode:
    RESPOND MSG="===== CALIBRACAO T0 COMO REFERENCIA ====="
    RESPOND MSG="T0 sera usado como base para comparacao"
    
    # Home se necessario
    {% if not 'xyz' in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    
    # Ativar T0
    T0
    G4 P2000
    
    # Posicionar sobre ponto de referencia
    G90
    G1 X320 Y100 Z10 F3000
    G4 P1000
    
    # Medicao com TP223
    RESPOND MSG="Iniciando medicao com TP223..."
    MEDIR_TP223
    
    # Salvar resultado
    {% set measured_z = printer["gcode_macro MEDIR_TP223"].last_measurement %}
    SAVE_VARIABLE VARIABLE=calibration_ref_z VALUE={measured_z}
    SAVE_VARIABLE VARIABLE=tool_0_offset_z VALUE={measured_z}
    
    # Resultado
    RESPOND MSG="T0 calibrado: Z={measured_z}mm"
    RESPOND MSG="Referencia salva em variables.cfg"
    
    # Posicao segura
    G1 Z20 F300
    
    RESPOND MSG="Calibracao T0 concluida!"

#####################################################################
#                    MEDI√á√ÉO COMPARATIVA T1-T3                   #
#####################################################################

[gcode_macro CAL_TOOL]
description: Mede uma ferramenta espec√≠fica comparando com T0
variable_last_tool_measured: -1
variable_last_measurement_z: 0.0
variable_last_offset_calculated: 0.0
gcode:
    {% set tool_num = params.TOOL|default(1)|int %}
    {% set config = printer["gcode_macro CALIBRACAO_MULTITOOLS_CONFIG"] %}
    {% set t0_ref = printer["gcode_macro CAL_T0"].t0_average_z %}
    
    # Verificar se T0 foi calibrado
    {% if t0_ref == 0.0 %}
        RESPOND MSG="‚ùå ERRO: T0 n√£o foi calibrado. Execute CALIBRAR_T0_TP223 primeiro"
        {action_raise_error("T0 deve ser calibrado antes das outras ferramentas")}
    {% endif %}
    
    # Verificar se ferramenta est√° habilitada
    {% if tool_num not in config.tools_enabled %}
        RESPOND MSG="‚ö†Ô∏è AVISO: T{tool_num} est√° desabilitado"
        {% if tool_num == 3 %}
            RESPOND MSG="üí° T3 est√° preparado mas desativado (aguardando componentes)"
        {% endif %}
        {action_raise_error("Ferramenta T" + tool_num|string + " n√£o est√° habilitada")}
    {% endif %}
    
    RESPOND MSG="üîç ===== MEDI√á√ÉO COMPARATIVA T{tool_num} ====="
    RESPOND MSG="üìä Refer√™ncia T0: {t0_ref|round(4)}mm"
    
    # Ativar ferramenta
    RESPOND MSG="üîß Ativando ferramenta T{tool_num}..."
    T{tool_num}
    G4 P2000  # Aguardar estabiliza√ß√£o
    
    # Posicionar sobre ponto de refer√™ncia
    RESPOND MSG="üìç Posicionando T{tool_num} sobre ponto de refer√™ncia..."
    G90
    G1 X{config.reference_x} Y{config.reference_y} Z{config.reference_z} F3000
    G4 P1000  # Aguardar estabiliza√ß√£o
    
    # Usar o sistema de medi√ß√£o existente
    RESPOND MSG="üìè Iniciando medi√ß√£o autom√°tica com TP223..."
    MEDIR_TP223
        
        # Obter resultado da medi√ß√£o
        {% set measured_z = printer["gcode_macro MEDIR_TP223"].last_measurement %}
        {% set measurement_count = printer["gcode_macro MEDIR_TP223"].measurement_count %}
    
    # Verificar se a medi√ß√£o foi bem-sucedida
    {% if measured_z > 0 and measurement_count > 0 %}
        # Calcular offset relativo a T0
        {% set offset_z = measured_z - t0_ref %}
        
        # Salvar resultados
        SET_GCODE_VARIABLE MACRO=CAL_TOOL VARIABLE=last_tool_measured VALUE={tool_num}
        SET_GCODE_VARIABLE MACRO=CAL_TOOL VARIABLE=last_measurement_z VALUE={measured_z}
        SET_GCODE_VARIABLE MACRO=CAL_TOOL VARIABLE=last_offset_calculated VALUE={offset_z}
        
        # Salvar offset em variables.cfg
        {% set offset_var = "tool_" + tool_num|string + "_offset_z" %}
        SAVE_VARIABLE VARIABLE={offset_var} VALUE={offset_z}
        
        # Exibir resultados
        RESPOND MSG="üìä ===== RESULTADOS T{tool_num} COMPARATIVO ====="
        RESPOND MSG="üéØ T{tool_num} Dist√¢ncia m√©dia: {measured_z|round(4)}mm"
        RESPOND MSG="üìè T{tool_num} Amostras: {measurement_count}"
        RESPOND MSG="‚öñÔ∏è Offset Z relativo a T0: {offset_z|round(4)}mm"
        RESPOND MSG="üíæ Offset T{tool_num} salvo em variables.cfg"
    {% else %}
        RESPOND MSG="‚ùå ERRO: Falha na medi√ß√£o do T{tool_num}"
        RESPOND MSG="üí° Verifique sensor TP223 e tente novamente"
        {action_raise_error("Falha na calibra√ß√£o do T" + tool_num|string + " - medi√ß√£o inv√°lida")}
    {% endif %}
    
    # Retornar para posi√ß√£o segura
    G1 Z20 F3000
    
    RESPOND MSG="‚úÖ Medi√ß√£o T{tool_num} conclu√≠da!"

#####################################################################
#                    CALIBRA√á√ÉO AUTOM√ÅTICA COMPLETA              #
#####################################################################

[gcode_macro CAL_ALL]
description: Calibra todas as ferramentas automaticamente (T0 + T1-T3)
variable_calibration_results: {}
variable_calibration_completed: False
gcode:
    {% set config = printer["gcode_macro CALIBRACAO_MULTITOOLS_CONFIG"] %}
    
    RESPOND MSG="üöÄ ===== CALIBRA√á√ÉO AUTOM√ÅTICA COMPLETA ====="
    RESPOND MSG="üìã Sequ√™ncia: G28 ‚Üí T0 refer√™ncia ‚Üí T1-T3 comparativo"
    RESPOND MSG="üîß Ferramentas ativas: {config.tools_enabled}"
    
    # Passo 1: Home com T0
    RESPOND MSG="üè† Passo 1: Home com T0..."
    T0
    G4 P1000
    G28
    
    # Passo 2: Calibrar T0 como refer√™ncia
    RESPOND MSG="üéØ Passo 2: Calibrando T0 como refer√™ncia..."
    CAL_T0
    
    # Verificar se T0 foi calibrado com sucesso
    {% set t0_status = printer["gcode_macro CAL_T0"].calibration_status %}
    {% if t0_status == "error" %}
        RESPOND MSG="‚ùå ERRO: Falha na calibra√ß√£o T0. Processo interrompido."
        {action_raise_error("Calibra√ß√£o T0 falhou")}
    {% endif %}
    
    # Passo 3: Medir T1-T3 comparativamente
    {% set results = {} %}
    {% for tool_num in config.tools_enabled %}
        {% if tool_num != 0 %}
            RESPOND MSG="üîç Passo 3.{tool_num}: Medindo T{tool_num} comparativo..."
            CAL_TOOL TOOL={tool_num}
            
            # Coletar resultados
            {% set last_offset = printer["gcode_macro CAL_TOOL"].last_offset_calculated %}
            {% set results = results.update({("T" + tool_num|string): last_offset}) %}
        {% endif %}
    {% endfor %}
    
    # Salvar timestamp da calibra√ß√£o completa
    {% set timestamp = printer.system_stats.cputime|int %}
    SAVE_VARIABLE VARIABLE=last_full_calibration VALUE={timestamp}
    
    # Marcar calibra√ß√£o como completa
    SET_GCODE_VARIABLE MACRO=CAL_ALL VARIABLE=calibration_completed VALUE=True
    
    # Exibir resumo final
    RESPOND MSG="üìä ===== RESUMO CALIBRA√á√ÉO COMPLETA ====="
    {% set t0_ref = printer["gcode_macro CAL_T0"].t0_average_z %}
    RESPOND MSG="üéØ T0 (Refer√™ncia): {t0_ref|round(4)}mm"
    
    {% for tool_num in config.tools_enabled %}
        {% if tool_num != 0 %}
            {% set offset_var = "tool_" + tool_num|string + "_offset_z" %}
            {% if offset_var in printer.save_variables.variables %}
                {% set offset_value = printer.save_variables.variables[offset_var] %}
                RESPOND MSG="‚öñÔ∏è T{tool_num} Offset: {offset_value|round(4)}mm (relativo a T0)"
            {% endif %}
        {% endif %}
    {% endfor %}
    
    # Retornar para T0
    RESPOND MSG="üîß Retornando para T0..."
    T0
    G1 Z20 F3000
    
    RESPOND MSG="‚úÖ CALIBRA√á√ÉO AUTOM√ÅTICA COMPLETA FINALIZADA!"
    RESPOND MSG="üíæ Todos os offsets salvos em variables.cfg"
    RESPOND MSG="üí° Use STATUS_CALIBRACAO_MULTITOOLS para verificar resultados"

#####################################################################
#                    MACROS DE DIAGN√ìSTICO E STATUS              #
#####################################################################

[gcode_macro STATUS_CALIB_MT]
description: Mostra status completo da calibra√ß√£o multi-ferramentas
gcode:
    {% set config = printer["gcode_macro CALIBRACAO_MULTITOOLS_CONFIG"] %}
    {% set t0_ref = printer["gcode_macro CAL_T0"].t0_average_z %}
    {% set t0_status = printer["gcode_macro CAL_T0"].calibration_status %}
    {% set calibration_completed = printer["gcode_macro CAL_ALL"].calibration_completed %}
    
    RESPOND MSG="üìä ===== STATUS CALIBRA√á√ÉO MULTI-FERRAMENTAS ====="
    RESPOND MSG="üîß Sistema: TP223 no GPIO 22"
    RESPOND MSG="üìç Posi√ß√£o refer√™ncia: X{config.reference_x} Y{config.reference_y}"
    RESPOND MSG="‚öôÔ∏è Configura√ß√£o: {config.samples} amostras, ¬±{config.tolerance}mm"
    RESPOND MSG="üîß Ferramentas ativas: {config.tools_enabled}"
    
    # Status T0
    RESPOND MSG="üéØ T0 (Refer√™ncia): {t0_ref|round(4)}mm - Status: {t0_status}"
    
    # Status T1-T3
    {% for tool_num in [1, 2, 3] %}
        {% set offset_var = "tool_" + tool_num|string + "_offset_z" %}
        {% if offset_var in printer.save_variables.variables %}
            {% set offset_value = printer.save_variables.variables[offset_var] %}
            {% set status = "ATIVO" if tool_num in config.tools_enabled else "DESATIVADO" %}
            RESPOND MSG="‚öñÔ∏è T{tool_num}: {offset_value|round(4)}mm (relativo a T0) - {status}"
        {% else %}
            {% set status = "N√ÉO CALIBRADO" %}
            {% if tool_num == 3 %}
                {% set status = "PREPARADO (aguardando componentes)" %}
            {% endif %}
            RESPOND MSG="‚ùå T{tool_num}: {status}"
        {% endif %}
    {% endfor %}
    
    # Status geral
    {% if calibration_completed %}
        RESPOND MSG="‚úÖ Calibra√ß√£o completa: FINALIZADA"
        {% if "last_full_calibration" in printer.save_variables.variables %}
            {% set last_cal = printer.save_variables.variables.last_full_calibration %}
            RESPOND MSG="üïí √öltima calibra√ß√£o: {last_cal}"
        {% endif %}
    {% else %}
        RESPOND MSG="‚è≥ Calibra√ß√£o completa: PENDENTE"
    {% endif %}

[gcode_macro TESTE_MT]
description: Teste completo do sistema multi-ferramentas
gcode:
    RESPOND MSG="üß™ ===== TESTE SISTEMA MULTI-FERRAMENTAS ====="
    
    # Verificar configura√ß√£o
    {% set config = printer["gcode_macro CALIBRACAO_MULTITOOLS_CONFIG"] %}
    RESPOND MSG="üìç Posi√ß√£o refer√™ncia: X{config.reference_x} Y{config.reference_y} Z{config.reference_z}"
    RESPOND MSG="üìä Configura√ß√£o: {config.samples} amostras, toler√¢ncia {config.tolerance}mm"
    
    # Verificar sensor TP223
    {% set sensor_state = printer["gcode_macro TESTE_TP223_IND"].sensor_triggered %}
    RESPOND MSG="üîç Estado sensor TP223: {'ACIONADO' if sensor_state else 'LIVRE'}"
    
    # Verificar ferramentas
    RESPOND MSG="üîß Ferramentas ativas: {config.tools_enabled}"
    
    # Teste de posicionamento
    RESPOND MSG="üìç Testando posicionamento..."
    G90
    G1 X{config.reference_x} Y{config.reference_y} Z{config.reference_z} F3000
    
    RESPOND MSG="‚úÖ Sistema pronto para calibra√ß√£o multi-ferramentas"
    RESPOND MSG="üí° Execute: CAL_ALL"

#####################################################################
#                    MACROS DE CONFIGURA√á√ÉO AVAN√áADA             #
#####################################################################

[gcode_macro ATIVAR_T3]
description: Ativa T3 quando componentes chegarem
gcode:
    {% set config = printer["gcode_macro CALIBRACAO_MULTITOOLS_CONFIG"] %}
    {% set current_tools = config.tools_enabled %}
    
    {% if 3 not in current_tools %}
        {% set new_tools = current_tools + [3] %}
        SET_GCODE_VARIABLE MACRO=CALIBRACAO_MULTITOOLS_CONFIG VARIABLE=tools_enabled VALUE={new_tools}
        RESPOND MSG="‚úÖ T3 ativado! Ferramentas ativas: {new_tools}"
        RESPOND MSG="üí° Execute CAL_ALL para incluir T3"
    {% else %}
        RESPOND MSG="‚ÑπÔ∏è T3 j√° est√° ativo"
    {% endif %}

[gcode_macro DESATIVAR_T3]
description: Desativa T3 temporariamente
gcode:
    {% set config = printer["gcode_macro CALIBRACAO_MULTITOOLS_CONFIG"] %}
    {% set current_tools = config.tools_enabled %}
    
    {% if 3 in current_tools %}
        {% set new_tools = [] %}
        {% for tool in current_tools %}
            {% if tool != 3 %}
                {% set new_tools = new_tools + [tool] %}
            {% endif %}
        {% endfor %}
        SET_GCODE_VARIABLE MACRO=CALIBRACAO_MULTITOOLS_CONFIG VARIABLE=tools_enabled VALUE={new_tools}
        RESPOND MSG="‚ö†Ô∏è T3 desativado! Ferramentas ativas: {new_tools}"
    {% else %}
        RESPOND MSG="‚ÑπÔ∏è T3 j√° est√° desativado"
    {% endif %}

#####################################################################
#                         COMANDOS √öTEIS                          #
#####################################################################
# CALIBRACAO_MULTITOOLS_CONFIG      - Configurar sistema
# CAL_T0                           - Calibrar T0 como base
# CAL_TOOL                          - Medir ferramenta espec√≠fica
# CAL_ALL                           - Calibra√ß√£o autom√°tica completa
# STATUS_CALIBRACAO_MULTITOOLS       - Status do sistema
# TESTAR_SISTEMA_MULTITOOLS          - Teste completo
# ATIVAR_T3 / DESATIVAR_T3           - Controle T3
# 
# Sequ√™ncia recomendada:
# 1. CALIBRACAO_MULTITOOLS_CONFIG
# 2. TESTAR_SISTEMA_MULTITOOLS
# 3. CAL_ALL
# 4. STATUS_CALIBRACAO_MULTITOOLS
#####################################################################