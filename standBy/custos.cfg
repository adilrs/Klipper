[gcode_macro PRINT_COST_CONFIG]
variable_filament_cost_per_gram: 0.16
variable_filament_density: 1.24
variable_filament_diameter: 1.75
variable_energy_cost_per_hour: 0.75
variable_machine_hourly_cost: 1.50
variable_profit_multiplier: 6.0  ; 500% de lucro = custo × 6
gcode:
  M117 Configuração de custo atualizada

[gcode_macro SALVAR_CUSTO]
gcode:
  {% set time = printer.print_stats.print_duration|float %}
  {% set hours = time / 3600 %}
  {% set length = printer.extruder.filament_used|default(0)|float %}
  {% set radius = printer["gcode_macro PRINT_COST_CONFIG"].filament_diameter / 2 %}
  {% set volume = (3.1416 * radius**2 * length) / 1000 %}
  {% set density = printer["gcode_macro PRINT_COST_CONFIG"].filament_density %}
  {% set grams = volume * density %}
  {% set cost_per_gram = printer["gcode_macro PRINT_COST_CONFIG"].filament_cost_per_gram %}
  {% set filament_cost = grams * cost_per_gram %}
  {% set energy_cost = hours * printer["gcode_macro PRINT_COST_CONFIG"].energy_cost_per_hour %}
  {% set machine_cost = hours * printer["gcode_macro PRINT_COST_CONFIG"].machine_hourly_cost %}
  {% set total_cost = filament_cost + energy_cost + machine_cost %}
  {% set multiplier = printer["gcode_macro PRINT_COST_CONFIG"].profit_multiplier %}
  {% set final_price = total_cost * multiplier %}
  {% set file = printer.print_stats.filename|default("desconhecido") %}
  {% set date = printer.print_stats.start_time|int %}
  {% set timestamp = printer.print_stats.start_time|int %}
  {% set linha = timestamp ~ "," ~ file ~ "," ~ "%.2f"|format(hours) ~ "," ~ "%.1f"|format(grams) ~ "," ~ "%.2f"|format(total_cost) ~ "," ~ "%.2f"|format(final_price) %}
  RESPOND PREFIX="CUSTO" MSG="Custo: R$ %.2f | Preço final: R$ %.2f" % (total_cost, final_price)
  WRITE_FILE FILENAME=/home/adilson/printer_data/gcodes/historico_custos.csv APPEND=1 DATA="{linha}\n"