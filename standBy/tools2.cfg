[gcode_macro PARK]
description: Estaciona a ferramenta atual no dock e salva posição
gcode:
  {% set tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if tool == 0 %}
    RESPOND PREFIX="WARNING" MSG="Nenhuma ferramenta carregada — PARK cancelado"
    RETURN
  {% endif %}

  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|float %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set approach_pre = tool_y - 10 %}
  {% set approach_slow = approach_speed // 8 %}
  
  SAVE_GCODE_STATE NAME=park_state

  RESPOND MSG="Tool {tool} → estacionando no slot, eixo X preservado"
  M117 PARK: Tool {tool}

  G90
  G1 Y200 F{approach_speed}
  G1 Y{approach_pre} F{approach_speed}
  G1 Y{tool_y} F{approach_slow}

[gcode_macro UNPARK]
description: Retorna à posição anterior ao PARK com recuo seguro
gcode:
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  RESPOND MSG="Retornando da posição PARK"
  M117 UNPARK → recuando para Y200

  G90
  G1 Y200 F{approach_speed}

  RESTORE_GCODE_STATE NAME=park_state MOVE=1 MOVE_SPEED=150
  

  
[gcode_macro PURGA_SMART]
description: Purga leve na extrusora ativa
gcode:
  {% set tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set extruders = {1: "extruder", 2: "extruder1", 3: "extruder2"} %}
  {% set extruder_name = extruders[tool]|default("extruder") %}

  {% if tool == 0 %}
    RESPOND PREFIX="WARNING" MSG="Nenhuma ferramenta carregada — purga abortada"
    RETURN
  {% endif %}

  {% set temp = printer[extruder_name].temperature|float %}
  {% if temp < 150 %}
    RESPOND PREFIX="WARNING" MSG="Purga ignorada: extrusora em {temp}°C"
    RETURN
  {% endif %}

  RESPOND PREFIX="INFO" MSG="Purga em {extruder_name} (Tool {tool}) a {temp}°C"
  M117 Purga: Tool {tool}
  G92 E0
  G1 E5 F150


[gcode_macro VERIFICAR_TEMPERATURA]
description: Mostra temperatura de todas as ferramentas
gcode:
  {% for i in range(1, 5) %}
    {% set extruder_name = "extruder" if i == 1 else "extruder" ~ (i - 1) %}
    {% if printer[extruder_name] is defined %}
      {% set temp = printer[extruder_name].temperature|float %}
      RESPOND PREFIX="TOOL" MSG="Tool {i}: {extruder_name} → {temp}°C"
    {% else %}
      RESPOND PREFIX="TOOL" MSG="Tool {i}: Extrusora não definida"
    {% endif %}
  {% endfor %}


[gcode_macro DESENGATAR_FERRAMENTA]
description: Desengata a ferramenta atual, caso esteja carregada
gcode:
  {% set active_tool = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if active_tool == 0 %}
    RESPOND PREFIX="INFO" MSG="Nenhuma ferramenta carregada para desengatar"
    RETURN
  {% endif %}

  {% set dock_x = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ active_tool)|float %}
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set approach_pre = tool_y - 10 %}
  {% set approach_slow = approach_speed // 8 %}
  {% set extruder_name = "extruder" if active_tool == 1 else "extruder" ~ (active_tool - 1) %}
  {% set temperatura = printer[extruder_name].temperature|float %}

  G90
  RESPOND MSG="Desengatando Tool {active_tool}..."
  M117 Tool {active_tool} → Desengatando

  {% if temperatura >= 160 %}
    G91
    G1 E-6 F4000
    G90
    RESPOND MSG="Retração executada: {temperatura}°C"
  {% else %}
    RESPOND MSG="Retração ignorada: Tool em {temperatura}°C"
  {% endif %}

  G1 X{dock_x} Y200 F5000
  G1 Y{approach_pre} F{approach_speed}
  G1 Y{tool_y} F{approach_slow}

  ABRIR
  G4 P300

  G91
  G1 Y-15 F{approach_speed}
  G90

  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=0
  SAVE_VARIABLE VARIABLE=tool VALUE=0
  RESPOND MSG="Tool {active_tool} descarregada"
  M117 Tool {active_tool} descarregada

[gcode_macro ENGATAR_FERRAMENTA]
description: Engata ferramenta específica — use TOOL=N
gcode:
  {% set tool = params.TOOL|int %}
  {% if tool == 0 %}
    RESPOND MSG="Tool inválida"
    RETURN
  {% endif %}

  {% set x_pos = printer["gcode_macro TOOL_DATA"].get("dock_x" ~ tool)|float %}
  {% set tool_y = printer["gcode_macro TOOL_DATA"].tool_y|int %}
  {% set approach_speed = printer["gcode_macro TOOL_DATA"].approach_speed|int %}
  {% set approach_pre = tool_y - 10 %}
  {% set approach_slow = approach_speed // 8 %}

  RESPOND MSG="Engatando Tool {tool}..."
  M117 Tool {tool} → Engatando

  G1 Y200 X{x_pos} F{approach_speed}
  G1 Y{approach_pre} F{approach_speed}
  G1 Y{tool_y} F{approach_slow}

  FECHAR
  G4 P300

  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={tool}
  SAVE_VARIABLE VARIABLE=tool VALUE={tool}
  RESPOND MSG="Tool {tool} carregada"
  M117 Tool {tool} carregada


[gcode_macro TROCA_INTEL]
gcode:
  {% set tool = params.TOOL|default(0)|int %}
  EXECUTE_MACRO MACRO=DESENGATAR_FERRAMENTA
  EXECUTE_MACRO MACRO=ENGATAR_FERRAMENTA TOOL={tool}


  