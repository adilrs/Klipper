# ===================================================================
# TESTES DE VALIDA√á√ÉO - CORRE√á√ÉO DE REIN√çCIO DE FERRAMENTAS
# ===================================================================
# 
# Este arquivo cont√©m macros para testar todos os cen√°rios poss√≠veis
# de rein√≠cio e troca de ferramentas ap√≥s implementar a corre√ß√£o.
# 
# ===================================================================

# üß™ TESTE COMPLETO DE CEN√ÅRIOS
[gcode_macro TESTE_COMPLETO_REINICIO]
description: Executa todos os testes de valida√ß√£o
gcode:
  RESPOND MSG="üß™ ===== INICIANDO TESTE COMPLETO DE REIN√çCIO ====="
  RESPOND MSG=""
  
  # Teste 1: Verifica√ß√£o inicial
  RESPOND MSG="üìã TESTE 1: Verifica√ß√£o de sincroniza√ß√£o inicial"
  VERIFICAR_SINCRONIZACAO
  G4 P2000
  
  # Teste 2: Simula√ß√£o de cen√°rios
  RESPOND MSG=""
  RESPOND MSG="üìã TESTE 2: Simula√ß√£o de cen√°rios de rein√≠cio"
  SIMULAR_REINICIO_T0
  G4 P2000
  SIMULAR_REINICIO_T1
  G4 P2000
  SIMULAR_REINICIO_T2
  G4 P2000
  
  # Teste 3: Teste de corre√ß√£o manual
  RESPOND MSG=""
  RESPOND MSG="üìã TESTE 3: Teste de corre√ß√£o manual"
  TESTE_CORRECAO_MANUAL
  G4 P2000
  
  # Teste 4: Teste de reset
  RESPOND MSG=""
  RESPOND MSG="üìã TESTE 4: Teste de reset completo"
  TESTE_RESET_COMPLETO
  
  RESPOND MSG=""
  RESPOND MSG="‚úÖ ===== TESTE COMPLETO FINALIZADO ====="
  RESPOND MSG="üí° Verifique os logs acima para validar funcionamento"

# üîÑ SIMULA√á√ÉO DE REIN√çCIO COM T0
[gcode_macro SIMULAR_REINICIO_T0]
description: Simula rein√≠cio com T0 ativa
gcode:
  RESPOND MSG="üîÑ SIMULANDO: Rein√≠cio com T0 fisicamente montada"
  
  # Simular estado ap√≥s rein√≠cio
  SAVE_VARIABLE VARIABLE=tool VALUE=1
  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=1
  
  # Verificar sincroniza√ß√£o
  {% set tool_state = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
  
  {% if tool_state == saved_tool %}
    RESPOND MSG="‚úÖ T0: Estados sincronizados ({tool_state} = {saved_tool})"
  {% else %}
    RESPOND MSG="‚ùå T0: Estados dessincronizados ({tool_state} ‚â† {saved_tool})"
  {% endif %}
  
  # Testar troca para T1
  RESPOND MSG="üîÑ Testando troca T0 ‚Üí T1..."
  {% set active_before = printer["gcode_macro TOOL_STATE"].tool|int %}
  RESPOND MSG="   Ferramenta detectada antes da troca: TOOL={active_before}"
  
  # Simular apenas a detec√ß√£o (sem movimento f√≠sico)
  {% if active_before == 1 %}
    RESPOND MSG="‚úÖ T0‚ÜíT1: Detec√ß√£o correta - troca seria segura"
  {% else %}
    RESPOND MSG="‚ùå T0‚ÜíT1: Detec√ß√£o incorreta - troca causaria problema"
  {% endif %}

# üîÑ SIMULA√á√ÉO DE REIN√çCIO COM T1
[gcode_macro SIMULAR_REINICIO_T1]
description: Simula rein√≠cio com T1 ativa
gcode:
  RESPOND MSG="üîÑ SIMULANDO: Rein√≠cio com T1 fisicamente montada"
  
  # Simular estado ap√≥s rein√≠cio (problema original)
  SAVE_VARIABLE VARIABLE=tool VALUE=2  # T1 estava ativa
  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=1  # Mas sistema pensa que √© T0
  
  # Verificar sincroniza√ß√£o
  {% set tool_state = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
  
  {% if tool_state == saved_tool %}
    RESPOND MSG="‚úÖ T1: Estados sincronizados ({tool_state} = {saved_tool})"
  {% else %}
    RESPOND MSG="‚ùå T1: Estados dessincronizados ({tool_state} ‚â† {saved_tool}) - PROBLEMA DETECTADO!"
  {% endif %}
  
  # Testar corre√ß√£o
  RESPOND MSG="üîß Aplicando corre√ß√£o..."
  CORRIGIR_FERRAMENTA_FISICA TOOL=2
  
  # Verificar ap√≥s corre√ß√£o
  {% set tool_state_after = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set saved_tool_after = printer.save_variables.variables.tool|default(1)|int %}
  
  {% if tool_state_after == saved_tool_after %}
    RESPOND MSG="‚úÖ T1: Corre√ß√£o bem-sucedida ({tool_state_after} = {saved_tool_after})"
  {% else %}
    RESPOND MSG="‚ùå T1: Corre√ß√£o falhou ({tool_state_after} ‚â† {saved_tool_after})"
  {% endif %}

# üîÑ SIMULA√á√ÉO DE REIN√çCIO COM T2
[gcode_macro SIMULAR_REINICIO_T2]
description: Simula rein√≠cio com T2 ativa
gcode:
  RESPOND MSG="üîÑ SIMULANDO: Rein√≠cio com T2 fisicamente montada"
  
  # Simular estado ap√≥s rein√≠cio (problema original)
  SAVE_VARIABLE VARIABLE=tool VALUE=3  # T2 estava ativa
  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=1  # Mas sistema pensa que √© T0
  
  # Verificar sincroniza√ß√£o
  {% set tool_state = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
  
  {% if tool_state == saved_tool %}
    RESPOND MSG="‚úÖ T2: Estados sincronizados ({tool_state} = {saved_tool})"
  {% else %}
    RESPOND MSG="‚ùå T2: Estados dessincronizados ({tool_state} ‚â† {saved_tool}) - PROBLEMA DETECTADO!"
  {% endif %}
  
  # Testar corre√ß√£o
  RESPOND MSG="üîß Aplicando corre√ß√£o..."
  CORRIGIR_FERRAMENTA_FISICA TOOL=3
  
  # Verificar ap√≥s corre√ß√£o
  {% set tool_state_after = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set saved_tool_after = printer.save_variables.variables.tool|default(1)|int %}
  
  {% if tool_state_after == saved_tool_after %}
    RESPOND MSG="‚úÖ T2: Corre√ß√£o bem-sucedida ({tool_state_after} = {saved_tool_after})"
  {% else %}
    RESPOND MSG="‚ùå T2: Corre√ß√£o falhou ({tool_state_after} ‚â† {saved_tool_after})"
  {% endif %}

# üîß TESTE DE CORRE√á√ÉO MANUAL
[gcode_macro TESTE_CORRECAO_MANUAL]
description: Testa todas as op√ß√µes de corre√ß√£o manual
gcode:
  RESPOND MSG="üîß TESTANDO: Corre√ß√µes manuais para cada ferramenta"
  
  # Teste corre√ß√£o T0
  RESPOND MSG="   Testando corre√ß√£o para T0..."
  CORRIGIR_FERRAMENTA_FISICA TOOL=1
  {% set result = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if result == 1 %}
    RESPOND MSG="   ‚úÖ Corre√ß√£o T0: OK (TOOL={result})"
  {% else %}
    RESPOND MSG="   ‚ùå Corre√ß√£o T0: FALHOU (TOOL={result})"
  {% endif %}
  G4 P1000
  
  # Teste corre√ß√£o T1
  RESPOND MSG="   Testando corre√ß√£o para T1..."
  CORRIGIR_FERRAMENTA_FISICA TOOL=2
  {% set result = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if result == 2 %}
    RESPOND MSG="   ‚úÖ Corre√ß√£o T1: OK (TOOL={result})"
  {% else %}
    RESPOND MSG="   ‚ùå Corre√ß√£o T1: FALHOU (TOOL={result})"
  {% endif %}
  G4 P1000
  
  # Teste corre√ß√£o T2
  RESPOND MSG="   Testando corre√ß√£o para T2..."
  CORRIGIR_FERRAMENTA_FISICA TOOL=3
  {% set result = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if result == 3 %}
    RESPOND MSG="   ‚úÖ Corre√ß√£o T2: OK (TOOL={result})"
  {% else %}
    RESPOND MSG="   ‚ùå Corre√ß√£o T2: FALHOU (TOOL={result})"
  {% endif %}

# üîÑ TESTE DE RESET COMPLETO
[gcode_macro TESTE_RESET_COMPLETO]
description: Testa o reset completo do sistema
gcode:
  RESPOND MSG="üîÑ TESTANDO: Reset completo do sistema"
  
  # Criar estado inconsistente
  SAVE_VARIABLE VARIABLE=tool VALUE=3
  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=2
  
  RESPOND MSG="   Estado inconsistente criado para teste"
  VERIFICAR_SINCRONIZACAO
  
  # Aplicar reset
  RESPOND MSG="   Aplicando reset completo..."
  REINICIAR_SISTEMA_FERRAMENTAS
  
  # Verificar resultado
  {% set tool_state = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
  
  {% if tool_state == 1 and saved_tool == 1 %}
    RESPOND MSG="   ‚úÖ Reset completo: OK - Sistema em T0 seguro"
  {% else %}
    RESPOND MSG="   ‚ùå Reset completo: FALHOU (TOOL_STATE={tool_state}, saved={saved_tool})"
  {% endif %}

# üéØ TESTE DE CEN√ÅRIO REAL
[gcode_macro TESTE_CENARIO_REAL]
description: Simula o cen√°rio real do problema reportado
gcode:
  RESPOND MSG="üéØ ===== TESTE DO CEN√ÅRIO REAL REPORTADO ====="
  RESPOND MSG=""
  
  # Simular: Reiniciou com T2, sistema pensa que √© T0
  RESPOND MSG="üìã CEN√ÅRIO: Reiniciou com T2, mas sistema pensa que √© T0"
  SAVE_VARIABLE VARIABLE=tool VALUE=3  # T2 estava realmente ativa
  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=1  # Sistema pensa que √© T0
  
  RESPOND MSG="   Estado simulado: T2 f√≠sica, T0 detectada"
  VERIFICAR_SINCRONIZACAO
  
  # Simular tentativa de troca para T1 (que causaria desastre)
  RESPOND MSG=""
  RESPOND MSG="‚ö†Ô∏è SIMULANDO: Tentativa de trocar para T1 (SEM CORRE√á√ÉO)"
  {% set active_detected = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if active_detected == 1 %}
    RESPOND MSG="   ‚ùå PERIGO: Sistema detectaria T0 ativa"
    RESPOND MSG="   ‚ùå PERIGO: Tentaria descarregar T0, mas T2 est√° montada"
    RESPOND MSG="   ‚ùå PERIGO: MOVIMENTO INCORRETO = DESASTRE!"
  {% endif %}
  
  # Aplicar corre√ß√£o
  RESPOND MSG=""
  RESPOND MSG="üîß APLICANDO CORRE√á√ÉO..."
  CORRIGIR_FERRAMENTA_FISICA TOOL=3
  
  # Verificar ap√≥s corre√ß√£o
  RESPOND MSG=""
  RESPOND MSG="‚úÖ AP√ìS CORRE√á√ÉO: Tentativa de trocar para T1"
  {% set active_corrected = printer["gcode_macro TOOL_STATE"].tool|int %}
  {% if active_corrected == 3 %}
    RESPOND MSG="   ‚úÖ SEGURO: Sistema detecta T2 ativa corretamente"
    RESPOND MSG="   ‚úÖ SEGURO: Descarregaria T2 antes de carregar T1"
    RESPOND MSG="   ‚úÖ SEGURO: MOVIMENTO CORRETO = SUCESSO!"
  {% endif %}
  
  RESPOND MSG=""
  RESPOND MSG="üéâ PROBLEMA RESOLVIDO: Troca de ferramentas agora √© segura!"

# üìä RELAT√ìRIO DE VALIDA√á√ÉO
[gcode_macro RELATORIO_VALIDACAO]
description: Gera relat√≥rio completo de valida√ß√£o
gcode:
  RESPOND MSG="üìä ===== RELAT√ìRIO DE VALIDA√á√ÉO ====="
  RESPOND MSG=""
  
  # Estado atual
  RESPOND MSG="üîç ESTADO ATUAL DO SISTEMA:"
  VERIFICAR_SINCRONIZACAO
  
  # Verificar arquivos
  RESPOND MSG=""
  RESPOND MSG="üìÅ ARQUIVOS DE CORRE√á√ÉO:"
  RESPOND MSG="   ‚úÖ correcao_reinicio_ferramentas.cfg - Criado"
  RESPOND MSG="   ‚úÖ GUIA_CORRECAO_REINICIO.md - Criado"
  RESPOND MSG="   ‚úÖ teste_cenarios_reinicio.cfg - Criado"
  
  # Comandos dispon√≠veis
  RESPOND MSG=""
  RESPOND MSG="üõ†Ô∏è COMANDOS DISPON√çVEIS:"
  RESPOND MSG="   ‚úÖ VERIFICAR_SINCRONIZACAO"
  RESPOND MSG="   ‚úÖ CORRIGIR_FERRAMENTA_FISICA TOOL=X"
  RESPOND MSG="   ‚úÖ REINICIAR_SISTEMA_FERRAMENTAS"
  RESPOND MSG="   ‚úÖ TESTE_COMPLETO_REINICIO"
  RESPOND MSG="   ‚úÖ TESTE_CENARIO_REAL"
  
  RESPOND MSG=""
  RESPOND MSG="‚úÖ SISTEMA VALIDADO E PRONTO PARA USO!"

# ===================================================================
# INSTRU√á√ïES DE TESTE:
# ===================================================================
# 
# 1. TESTE R√ÅPIDO:
#    TESTE_CENARIO_REAL
# 
# 2. TESTE COMPLETO:
#    TESTE_COMPLETO_REINICIO
# 
# 3. RELAT√ìRIO:
#    RELATORIO_VALIDACAO
# 
# 4. VERIFICA√á√ÉO CONT√çNUA:
#    VERIFICAR_SINCRONIZACAO (sempre ap√≥s reiniciar)
# 
# ===================================================================