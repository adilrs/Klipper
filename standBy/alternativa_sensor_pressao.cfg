# ALTERNATIVA: Sistema hÃ­brido para detecÃ§Ã£o de contato lento
# SoluÃ§Ã£o para quando sensor piezoelÃ©trico nÃ£o funciona com probe lento

# CONFIGURAÃ‡ÃƒO PRINCIPAL: Probe com parÃ¢metros ultra-sensÃ­veis
[probe]
pin: !host:gpio22  # Pin invertido para mÃ¡xima sensibilidade
x_offset: 0
y_offset: 0
z_offset: 0.0      # Ajustar apÃ³s calibraÃ§Ã£o
speed: 0.5         # MUITO lento - 0.5mm/s
lift_speed: 3.0    # Subida moderada
samples: 5         # Mais amostras para confiabilidade
sample_retract_dist: 1.0  # DistÃ¢ncia menor de retraÃ§Ã£o
samples_result: median
samples_tolerance: 0.050   # TolerÃ¢ncia menor
samples_tolerance_retries: 5

# Sistema de backup com gcode_button para monitoramento
# COMENTADO: Conflito com [probe] ativo
#[gcode_button sensor_backup]
#pin: !host:gpio22
press_gcode:
    SET_GCODE_VARIABLE MACRO=MONITOR_CONTATO VARIABLE=contato_detectado VALUE=1
    RESPOND MSG="ğŸ¯ CONTATO DETECTADO!"
release_gcode:
    SET_GCODE_VARIABLE MACRO=MONITOR_CONTATO VARIABLE=contato_detectado VALUE=0
    RESPOND MSG="ğŸŸ¢ Contato liberado"

# VariÃ¡veis para monitoramento
[gcode_macro MONITOR_CONTATO]
variable_contato_detectado: 0
variable_tempo_ultimo_contato: 0
gcode:
    # Esta macro armazena variÃ¡veis de estado

# Macro para teste completo do sistema hÃ­brido
[gcode_macro TESTE_SISTEMA_HIBRIDO]
description: Testa sistema hÃ­brido para probe lento
gcode:
    RESPOND MSG="ğŸ”„ TESTE DO SISTEMA HÃBRIDO"
    RESPOND MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND MSG=""
    RESPOND MSG="Este sistema combina:"
    RESPOND MSG="âœ… Probe configurado para velocidade ultra-baixa"
    RESPOND MSG="âœ… Backup com gcode_button para monitoramento"
    RESPOND MSG="âœ… ParÃ¢metros otimizados para detecÃ§Ã£o lenta"
    RESPOND MSG=""
    RESPOND MSG="ğŸ§ª TESTE MANUAL:"
    RESPOND MSG="1. Aproxime dedo MUITO devagar do sensor"
    RESPOND MSG="2. Mantenha pressÃ£o constante por 3 segundos"
    RESPOND MSG="3. Observe as mensagens de detecÃ§Ã£o"
    RESPOND MSG=""
    RESPOND MSG="Estado inicial: {printer['gcode_button sensor_backup'].state}"
    RESPOND MSG="Contato detectado: {printer['gcode_macro MONITOR_CONTATO'].contato_detectado}"
    RESPOND MSG=""
    RESPOND MSG="ğŸ‘† INICIE O TESTE AGORA"

# Macro para simulaÃ§Ã£o de probe automÃ¡tico
[gcode_macro SIMULAR_PROBE_AUTOMATICO]
description: Simula como seria o probe automÃ¡tico real
gcode:
    {% set z_atual = printer.toolhead.position.z %}
    
    RESPOND MSG="ğŸ¤– SIMULAÃ‡ÃƒO DE PROBE AUTOMÃTICO"
    RESPOND MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND MSG=""
    RESPOND MSG="Simulando descida lenta do bico..."
    RESPOND MSG="PosiÃ§Ã£o Z atual: {z_atual:.2f}mm"
    RESPOND MSG=""
    RESPOND MSG="âš ï¸  ATENÃ‡ÃƒO: Esta Ã© apenas uma simulaÃ§Ã£o!"
    RESPOND MSG="O bico NÃƒO vai se mover."
    RESPOND MSG=""
    RESPOND MSG="ğŸ¯ COMO O PROBE REAL FUNCIONARIA:"
    RESPOND MSG="1. Bico desce a 0.5mm/s"
    RESPOND MSG="2. Sensor detecta contato"
    RESPOND MSG="3. Movimento para imediatamente"
    RESPOND MSG="4. Bico sobe 1mm"
    RESPOND MSG="5. Repete 5 vezes para mÃ©dia"
    RESPOND MSG=""
    RESPOND MSG="Para testar: pressione o sensor devagar"
    RESPOND MSG="e mantenha pressionado por alguns segundos"

# Macro para calibraÃ§Ã£o especÃ­fica de Z-offset
[gcode_macro CALIBRAR_Z_OFFSET_PIEZO]
description: Calibra Z-offset especificamente para sensor piezoelÃ©trico
gcode:
    RESPOND MSG="ğŸ“ CALIBRAÃ‡ÃƒO DE Z-OFFSET PIEZOELÃ‰TRICO"
    RESPOND MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND MSG=""
    RESPOND MSG="ğŸ¯ OBJETIVO: Encontrar altura exata do sensor"
    RESPOND MSG=""
    RESPOND MSG="ğŸ“‹ PROCEDIMENTO:"
    RESPOND MSG="1. Posicione bico sobre o sensor"
    RESPOND MSG="2. DesÃ§a manualmente atÃ© tocar levemente"
    RESPOND MSG="3. Anote a posiÃ§Ã£o Z quando sensor ativar"
    RESPOND MSG="4. Ajuste z_offset na configuraÃ§Ã£o [probe]"
    RESPOND MSG=""
    RESPOND MSG="ğŸ”§ COMANDOS ÃšTEIS:"
    RESPOND MSG="- G1 Z10 F300     (sobe 10mm devagar)"
    RESPOND MSG="- G1 Z-0.1 F60    (desce 0.1mm muito devagar)"
    RESPOND MSG="- M114            (mostra posiÃ§Ã£o atual)"
    RESPOND MSG=""
    RESPOND MSG="âš ï¸  CUIDADO:"
    RESPOND MSG="- Use movimentos muito pequenos (0.1mm)"
    RESPOND MSG="- Pare assim que sensor ativar"
    RESPOND MSG="- Anote a posiÃ§Ã£o Z exata"
    RESPOND MSG=""
    RESPOND MSG="Estado do sensor: {printer['gcode_button sensor_backup'].state}"

# Macro para diagnÃ³stico avanÃ§ado
[gcode_macro DIAG_AVANC_PIEZO]
description: DiagnÃ³stico completo do sistema piezoelÃ©trico
gcode:
    RESPOND MSG="ğŸ”¬ DIAGNÃ“STICO AVANÃ‡ADO"
    RESPOND MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND MSG=""
    RESPOND MSG="ğŸ“Š STATUS DO SISTEMA:"
    RESPOND MSG="- Pin configurado: !host:gpio22 (invertido)"
    RESPOND MSG="- Estado atual: {printer['gcode_button sensor_backup'].state}"
    RESPOND MSG="- Velocidade probe: 0.5mm/s"
    RESPOND MSG="- Amostras: 5"
    RESPOND MSG="- TolerÃ¢ncia: 0.050mm"
    RESPOND MSG=""
    RESPOND MSG="ğŸ” VERIFICAÃ‡Ã•ES NECESSÃRIAS:"
    RESPOND MSG=""
    RESPOND MSG="1. HARDWARE:"
    RESPOND MSG="   âœ“ LED da placa acende com toque leve?"
    RESPOND MSG="   âœ“ PotenciÃ´metro no mÃ¡ximo (sentido horÃ¡rio)?"
    RESPOND MSG="   âœ“ ConexÃµes firmes nos pinos GPIO?"
    RESPOND MSG=""
    RESPOND MSG="2. SOFTWARE:"
    RESPOND MSG="   âœ“ Pin invertido (!host:gpio22)?"
    RESPOND MSG="   âœ“ Velocidade baixa (â‰¤1mm/s)?"
    RESPOND MSG="   âœ“ MÃºltiplas amostras configuradas?"
    RESPOND MSG=""
    RESPOND MSG="3. MECÃ‚NICO:"
    RESPOND MSG="   âœ“ Sensor fixo rigidamente?"
    RESPOND MSG="   âœ“ SuperfÃ­cie de contato adequada?"
    RESPOND MSG="   âœ“ Sem vibraÃ§Ã£o na mesa?"
    RESPOND MSG=""
    RESPOND MSG="ğŸ§ª TESTES RECOMENDADOS:"
    RESPOND MSG="1. TESTE_SISTEMA_HIBRIDO"
    RESPOND MSG="2. SIMULAR_PROBE_AUTOMATICO"
    RESPOND MSG="3. CALIBRAR_Z_OFFSET_PIEZO"

# Macro para configuraÃ§Ã£o alternativa (caso a atual nÃ£o funcione)
[gcode_macro CONFIGURACAO_ALTERNATIVA]
description: Sugere configuraÃ§Ã£o alternativa se piezo nÃ£o funcionar
gcode:
    RESPOND MSG="ğŸ”„ CONFIGURAÃ‡ÃƒO ALTERNATIVA"
    RESPOND MSG="â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND MSG=""
    RESPOND MSG="Se o sensor piezoelÃ©trico nÃ£o funcionar"
    RESPOND MSG="com movimentos lentos, considere:"
    RESPOND MSG=""
    RESPOND MSG="ğŸ¯ ALTERNATIVAS RECOMENDADAS:"
    RESPOND MSG=""
    RESPOND MSG="1. BLTOUCH:"
    RESPOND MSG="   âœ… Funciona perfeitamente com probe lento"
    RESPOND MSG="   âœ… Muito confiÃ¡vel e preciso"
    RESPOND MSG="   âœ… Amplamente suportado"
    RESPOND MSG=""
    RESPOND MSG="2. SENSOR INDUTIVO:"
    RESPOND MSG="   âœ… Detecta metal da mesa"
    RESPOND MSG="   âœ… NÃ£o precisa de contato fÃ­sico"
    RESPOND MSG="   âœ… Muito durÃ¡vel"
    RESPOND MSG=""
    RESPOND MSG="3. SENSOR DE PRESSÃƒO (FSR):"
    RESPOND MSG="   âœ… Detecta pressÃ£o estÃ¡tica"
    RESPOND MSG="   âœ… Funciona com movimentos lentos"
    RESPOND MSG="   âœ… Mais barato que BLTouch"
    RESPOND MSG=""
    RESPOND MSG="4. STRAIN GAUGE:"
    RESPOND MSG="   âœ… Detecta deformaÃ§Ã£o mecÃ¢nica"
    RESPOND MSG="   âœ… Muito sensÃ­vel"
    RESPOND MSG="   âœ… Funciona com qualquer velocidade"
    RESPOND MSG=""
    RESPOND MSG="ğŸ’¡ RECOMENDAÃ‡ÃƒO:"
    RESPOND MSG="Para probe automÃ¡tico confiÃ¡vel,"
    RESPOND MSG="BLTouch Ã© a melhor opÃ§Ã£o!"