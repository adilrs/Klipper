# ALTERNATIVA: Sistema híbrido para detecção de contato lento
# Solução para quando sensor piezoelétrico não funciona com probe lento

# CONFIGURAÇÃO PRINCIPAL: Probe com parâmetros ultra-sensíveis
[probe]
pin: !host:gpio22  # Pin invertido para máxima sensibilidade
x_offset: 0
y_offset: 0
z_offset: 0.0      # Ajustar após calibração
speed: 0.5         # MUITO lento - 0.5mm/s
lift_speed: 3.0    # Subida moderada
samples: 5         # Mais amostras para confiabilidade
sample_retract_dist: 1.0  # Distância menor de retração
samples_result: median
samples_tolerance: 0.050   # Tolerância menor
samples_tolerance_retries: 5

# Sistema de backup com gcode_button para monitoramento
# COMENTADO: Conflito com [probe] ativo
#[gcode_button sensor_backup]
#pin: !host:gpio22
press_gcode:
    SET_GCODE_VARIABLE MACRO=MONITOR_CONTATO VARIABLE=contato_detectado VALUE=1
    RESPOND MSG="🎯 CONTATO DETECTADO!"
release_gcode:
    SET_GCODE_VARIABLE MACRO=MONITOR_CONTATO VARIABLE=contato_detectado VALUE=0
    RESPOND MSG="🟢 Contato liberado"

# Variáveis para monitoramento
[gcode_macro MONITOR_CONTATO]
variable_contato_detectado: 0
variable_tempo_ultimo_contato: 0
gcode:
    # Esta macro armazena variáveis de estado

# Macro para teste completo do sistema híbrido
[gcode_macro TESTE_SISTEMA_HIBRIDO]
description: Testa sistema híbrido para probe lento
gcode:
    RESPOND MSG="🔄 TESTE DO SISTEMA HÍBRIDO"
    RESPOND MSG="═══════════════════════════"
    RESPOND MSG=""
    RESPOND MSG="Este sistema combina:"
    RESPOND MSG="✅ Probe configurado para velocidade ultra-baixa"
    RESPOND MSG="✅ Backup com gcode_button para monitoramento"
    RESPOND MSG="✅ Parâmetros otimizados para detecção lenta"
    RESPOND MSG=""
    RESPOND MSG="🧪 TESTE MANUAL:"
    RESPOND MSG="1. Aproxime dedo MUITO devagar do sensor"
    RESPOND MSG="2. Mantenha pressão constante por 3 segundos"
    RESPOND MSG="3. Observe as mensagens de detecção"
    RESPOND MSG=""
    RESPOND MSG="Estado inicial: {printer['gcode_button sensor_backup'].state}"
    RESPOND MSG="Contato detectado: {printer['gcode_macro MONITOR_CONTATO'].contato_detectado}"
    RESPOND MSG=""
    RESPOND MSG="👆 INICIE O TESTE AGORA"

# Macro para simulação de probe automático
[gcode_macro SIMULAR_PROBE_AUTOMATICO]
description: Simula como seria o probe automático real
gcode:
    {% set z_atual = printer.toolhead.position.z %}
    
    RESPOND MSG="🤖 SIMULAÇÃO DE PROBE AUTOMÁTICO"
    RESPOND MSG="═══════════════════════════════"
    RESPOND MSG=""
    RESPOND MSG="Simulando descida lenta do bico..."
    RESPOND MSG="Posição Z atual: {z_atual:.2f}mm"
    RESPOND MSG=""
    RESPOND MSG="⚠️  ATENÇÃO: Esta é apenas uma simulação!"
    RESPOND MSG="O bico NÃO vai se mover."
    RESPOND MSG=""
    RESPOND MSG="🎯 COMO O PROBE REAL FUNCIONARIA:"
    RESPOND MSG="1. Bico desce a 0.5mm/s"
    RESPOND MSG="2. Sensor detecta contato"
    RESPOND MSG="3. Movimento para imediatamente"
    RESPOND MSG="4. Bico sobe 1mm"
    RESPOND MSG="5. Repete 5 vezes para média"
    RESPOND MSG=""
    RESPOND MSG="Para testar: pressione o sensor devagar"
    RESPOND MSG="e mantenha pressionado por alguns segundos"

# Macro para calibração específica de Z-offset
[gcode_macro CALIBRAR_Z_OFFSET_PIEZO]
description: Calibra Z-offset especificamente para sensor piezoelétrico
gcode:
    RESPOND MSG="📏 CALIBRAÇÃO DE Z-OFFSET PIEZOELÉTRICO"
    RESPOND MSG="════════════════════════════════════"
    RESPOND MSG=""
    RESPOND MSG="🎯 OBJETIVO: Encontrar altura exata do sensor"
    RESPOND MSG=""
    RESPOND MSG="📋 PROCEDIMENTO:"
    RESPOND MSG="1. Posicione bico sobre o sensor"
    RESPOND MSG="2. Desça manualmente até tocar levemente"
    RESPOND MSG="3. Anote a posição Z quando sensor ativar"
    RESPOND MSG="4. Ajuste z_offset na configuração [probe]"
    RESPOND MSG=""
    RESPOND MSG="🔧 COMANDOS ÚTEIS:"
    RESPOND MSG="- G1 Z10 F300     (sobe 10mm devagar)"
    RESPOND MSG="- G1 Z-0.1 F60    (desce 0.1mm muito devagar)"
    RESPOND MSG="- M114            (mostra posição atual)"
    RESPOND MSG=""
    RESPOND MSG="⚠️  CUIDADO:"
    RESPOND MSG="- Use movimentos muito pequenos (0.1mm)"
    RESPOND MSG="- Pare assim que sensor ativar"
    RESPOND MSG="- Anote a posição Z exata"
    RESPOND MSG=""
    RESPOND MSG="Estado do sensor: {printer['gcode_button sensor_backup'].state}"

# Macro para diagnóstico avançado
[gcode_macro DIAG_AVANC_PIEZO]
description: Diagnóstico completo do sistema piezoelétrico
gcode:
    RESPOND MSG="🔬 DIAGNÓSTICO AVANÇADO"
    RESPOND MSG="═══════════════════════"
    RESPOND MSG=""
    RESPOND MSG="📊 STATUS DO SISTEMA:"
    RESPOND MSG="- Pin configurado: !host:gpio22 (invertido)"
    RESPOND MSG="- Estado atual: {printer['gcode_button sensor_backup'].state}"
    RESPOND MSG="- Velocidade probe: 0.5mm/s"
    RESPOND MSG="- Amostras: 5"
    RESPOND MSG="- Tolerância: 0.050mm"
    RESPOND MSG=""
    RESPOND MSG="🔍 VERIFICAÇÕES NECESSÁRIAS:"
    RESPOND MSG=""
    RESPOND MSG="1. HARDWARE:"
    RESPOND MSG="   ✓ LED da placa acende com toque leve?"
    RESPOND MSG="   ✓ Potenciômetro no máximo (sentido horário)?"
    RESPOND MSG="   ✓ Conexões firmes nos pinos GPIO?"
    RESPOND MSG=""
    RESPOND MSG="2. SOFTWARE:"
    RESPOND MSG="   ✓ Pin invertido (!host:gpio22)?"
    RESPOND MSG="   ✓ Velocidade baixa (≤1mm/s)?"
    RESPOND MSG="   ✓ Múltiplas amostras configuradas?"
    RESPOND MSG=""
    RESPOND MSG="3. MECÂNICO:"
    RESPOND MSG="   ✓ Sensor fixo rigidamente?"
    RESPOND MSG="   ✓ Superfície de contato adequada?"
    RESPOND MSG="   ✓ Sem vibração na mesa?"
    RESPOND MSG=""
    RESPOND MSG="🧪 TESTES RECOMENDADOS:"
    RESPOND MSG="1. TESTE_SISTEMA_HIBRIDO"
    RESPOND MSG="2. SIMULAR_PROBE_AUTOMATICO"
    RESPOND MSG="3. CALIBRAR_Z_OFFSET_PIEZO"

# Macro para configuração alternativa (caso a atual não funcione)
[gcode_macro CONFIGURACAO_ALTERNATIVA]
description: Sugere configuração alternativa se piezo não funcionar
gcode:
    RESPOND MSG="🔄 CONFIGURAÇÃO ALTERNATIVA"
    RESPOND MSG="═══════════════════════════"
    RESPOND MSG=""
    RESPOND MSG="Se o sensor piezoelétrico não funcionar"
    RESPOND MSG="com movimentos lentos, considere:"
    RESPOND MSG=""
    RESPOND MSG="🎯 ALTERNATIVAS RECOMENDADAS:"
    RESPOND MSG=""
    RESPOND MSG="1. BLTOUCH:"
    RESPOND MSG="   ✅ Funciona perfeitamente com probe lento"
    RESPOND MSG="   ✅ Muito confiável e preciso"
    RESPOND MSG="   ✅ Amplamente suportado"
    RESPOND MSG=""
    RESPOND MSG="2. SENSOR INDUTIVO:"
    RESPOND MSG="   ✅ Detecta metal da mesa"
    RESPOND MSG="   ✅ Não precisa de contato físico"
    RESPOND MSG="   ✅ Muito durável"
    RESPOND MSG=""
    RESPOND MSG="3. SENSOR DE PRESSÃO (FSR):"
    RESPOND MSG="   ✅ Detecta pressão estática"
    RESPOND MSG="   ✅ Funciona com movimentos lentos"
    RESPOND MSG="   ✅ Mais barato que BLTouch"
    RESPOND MSG=""
    RESPOND MSG="4. STRAIN GAUGE:"
    RESPOND MSG="   ✅ Detecta deformação mecânica"
    RESPOND MSG="   ✅ Muito sensível"
    RESPOND MSG="   ✅ Funciona com qualquer velocidade"
    RESPOND MSG=""
    RESPOND MSG="💡 RECOMENDAÇÃO:"
    RESPOND MSG="Para probe automático confiável,"
    RESPOND MSG="BLTouch é a melhor opção!"