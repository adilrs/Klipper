#####################################################################
#              EXEMPLO PR√ÅTICO - IMPLEMENTA√á√ÉO SENSOR              #
#####################################################################
# Este arquivo cont√©m exemplos pr√°ticos para diferentes tipos de
# sensores e configura√ß√µes de hardware
# Sistema de Calibra√ß√£o Autom√°tica XYZ por Toque
# Vers√£o: 2.0 - Calibra√ß√£o 3D Completa

#####################################################################
#                    CONFIGURA√á√ïES POR TIPO DE SENSOR             #
#####################################################################

# ===== SENSOR CAPACITIVO LJ12A3-4-Z/BX =====
[probe sensor_capacitivo]
pin: ^PC4                             # Pin com pullup interno
x_offset: 0                           # Sensor alinhado com bico
y_offset: 0                           # Sensor alinhado com bico
z_offset: 0.5                         # Dist√¢ncia sensor-bico (calibrar)
speed: 3                              # Velocidade lenta para precis√£o
samples: 5                            # Mais amostras para capacitivo
sample_retract_dist: 3.0              # Retra√ß√£o maior
samples_tolerance: 0.015              # Toler√¢ncia mais apertada
samples_tolerance_retries: 5          # Mais tentativas

# ===== SENSOR PIEZOEL√âTRICO =====
[probe sensor_piezo]
pin: ^!PC4                            # L√≥gica invertida (comum em piezo)
x_offset: 0
y_offset: 0
z_offset: 0.1                         # Offset m√≠nimo
speed: 1                              # Muito lento para detectar for√ßa
samples: 3                            # Amostras padr√£o
sample_retract_dist: 1.0              # Retra√ß√£o m√≠nima
samples_tolerance: 0.005              # Toler√¢ncia muito apertada
samples_tolerance_retries: 3

# ===== MICROSWITCH DE PRECIS√ÉO =====
[probe sensor_switch]
pin: ^PC4                             # Pullup para switch NO
x_offset: 0
y_offset: 0
z_offset: 0.2                         # Altura do atuador
speed: 2                              # Velocidade moderada
samples: 3
sample_retract_dist: 2.0
samples_tolerance: 0.02
samples_tolerance_retries: 3

#####################################################################
#                    TESTES DE FUNCIONAMENTO                       #
#####################################################################

[gcode_macro TESTE_SENSOR_BASICO]
description: Teste b√°sico do sensor de toque
gcode:
    RESPOND MSG="üîç TESTE B√ÅSICO DO SENSOR"
    
    # Verificar estado inicial
    {% set initial_state = printer.probe.last_result %}
    RESPOND MSG="üìä Estado inicial: {'ACIONADO' if initial_state else 'LIVRE'}"
    
    # Posicionar sobre superf√≠cie de teste
    G28
    G90
    G1 X100 Y310 Z10 F3000
    
    RESPOND MSG="üìç Posicionado sobre superf√≠cie de refer√™ncia"
    RESPOND MSG="üîß Pressione o sensor manualmente e execute VERIFICAR_ESTADO_SENSOR"

[gcode_macro VERIFICAR_ESTADO_SENSOR]
description: Verificar estado atual do sensor
gcode:
    {% set current_state = printer.probe.last_result %}
    RESPOND MSG="üìä Estado atual: {'ACIONADO' if current_state else 'LIVRE'}"
    
    {% if current_state %}
        RESPOND MSG="‚úÖ Sensor funcionando - detectou acionamento"
    {% else %}
        RESPOND MSG="‚ö†Ô∏è Sensor livre - verifique conex√µes se deveria estar acionado"
    {% endif %}

[gcode_macro TESTE_SONDAGEM_MANUAL]
description: Teste de sondagem com supervis√£o manual
gcode:
    RESPOND MSG="üß™ TESTE DE SONDAGEM MANUAL"
    
    # Verifica√ß√µes de seguran√ßa
    {% if not printer.toolhead.homed_axes %}
        G28
    {% endif %}
    
    # Posicionar sobre superf√≠cie
    G90
    G1 X100 Y310 Z5 F3000
    
    RESPOND MSG="‚ö†Ô∏è ATEN√á√ÉO: Sondagem iniciar√° em 3 segundos"
    RESPOND MSG="üõë Pressione EMERGENCY STOP se algo estiver errado"
    G4 P3000
    
    # Executar sondagem
    PROBE
    
    # Mostrar resultado
    {% set z_result = printer.toolhead.position.z %}
    RESPOND MSG="üìè Resultado: Z = {z_result|round(4)}mm"
    
    # Retornar posi√ß√£o segura
    G1 Z10 F600

#####################################################################
#                 CALIBRA√á√ÉO DE OFFSET DO SENSOR                   #
#####################################################################

[gcode_macro CALIBRAR_OFFSET_SENSOR]
description: Calibrar offset Z do sensor em rela√ß√£o ao bico
gcode:
    RESPOND MSG="üéØ CALIBRA√á√ÉO DE OFFSET DO SENSOR"
    
    # Aquecimento para expans√£o t√©rmica real
    RESPOND MSG="üî• Aquecendo para temperatura de trabalho..."
    M104 S200
    M109 S200
    
    # Homing e posicionamento
    G28
    G90
    G1 X100 Y310 Z10 F3000
    
    # Primeira medi√ß√£o com sensor
    RESPOND MSG="üìè Medi√ß√£o 1: Sondagem com sensor"
    PROBE
    {% set sensor_z = printer.toolhead.position.z %}
    G1 Z10 F600
    
    # Segunda medi√ß√£o manual (papel)
    RESPOND MSG="üìÑ Medi√ß√£o 2: Ajuste manual com papel"
    RESPOND MSG="üîß Baixe o bico at√© tocar o papel (use controles manuais)"
    RESPOND MSG="üìù Quando ajustado, execute SALVAR_POSICAO_MANUAL"
    
    # Aguardar input manual
    M117 Ajuste manual - Execute SALVAR_POSICAO_MANUAL

[gcode_macro SALVAR_POSICAO_MANUAL]
description: Salvar posi√ß√£o manual para c√°lculo de offset
gcode:
    {% set manual_z = printer.toolhead.position.z %}
    {% set sensor_z = printer.save_variables.variables.get('temp_sensor_z', 0) %}
    
    # Calcular offset
    {% set offset = sensor_z - manual_z %}
    
    RESPOND MSG="üìä RESULTADOS DA CALIBRA√á√ÉO:"
    RESPOND MSG="   Sensor Z: {sensor_z|round(4)}mm"
    RESPOND MSG="   Manual Z: {manual_z|round(4)}mm"
    RESPOND MSG="   Offset calculado: {offset|round(4)}mm"
    
    # Salvar para uso posterior
    SAVE_VARIABLE VARIABLE=sensor_z_offset VALUE={offset}
    
    RESPOND MSG="üíæ Offset salvo! Atualize z_offset na configura√ß√£o do probe"
    RESPOND MSG="üìù Adicione: z_offset: {offset|round(4)} na se√ß√£o [probe]"

#####################################################################
#                    DIAGN√ìSTICO AVAN√áADO                          #
#####################################################################

[gcode_macro DIAG_SENSOR_COMP]
description: Diagn√≥stico completo do sistema de sensor
gcode:
    RESPOND MSG="üîç DIAGN√ìSTICO COMPLETO DO SENSOR"
    
    # Verificar configura√ß√£o
    {% set probe_config = printer.configfile.settings.probe %}
    RESPOND MSG="üìã CONFIGURA√á√ÉO ATUAL:"
    RESPOND MSG="   Pin: {probe_config.pin}"
    RESPOND MSG="   Velocidade: {probe_config.speed}mm/s"
    RESPOND MSG="   Amostras: {probe_config.samples}"
    RESPOND MSG="   Toler√¢ncia: {probe_config.samples_tolerance}mm"
    
    # Teste de conectividade
    RESPOND MSG="üîå TESTE DE CONECTIVIDADE:"
    {% set initial_state = printer.probe.last_result %}
    RESPOND MSG="   Estado inicial: {'ACIONADO' if initial_state else 'LIVRE'}"
    
    # Teste de m√∫ltiplas leituras
    RESPOND MSG="üìä TESTE DE ESTABILIDADE (10 leituras):"
    {% for i in range(10) %}
        G4 P100  # Aguardar 100ms
        {% set state = printer.probe.last_result %}
        RESPOND MSG="   Leitura {i+1}: {'HIGH' if state else 'LOW'}"
    {% endfor %}
    
    # Verificar hist√≥rico de sondagens
    {% if printer.probe.last_z_result %}
        RESPOND MSG="üìè √öLTIMA SONDAGEM: Z = {printer.probe.last_z_result|round(4)}mm"
    {% else %}
        RESPOND MSG="‚ö†Ô∏è Nenhuma sondagem anterior registrada"
    {% endif %}
    
    RESPOND MSG="‚úÖ Diagn√≥stico conclu√≠do"

#####################################################################
#                    ROTINA DE TESTE AUTOM√ÅTICO                    #
#####################################################################

[gcode_macro TESTE_AUTO_REP]
description: Teste autom√°tico de repetibilidade do sensor
gcode:
    {% set samples = params.SAMPLES|default(10)|int %}
    
    RESPOND MSG="üéØ TESTE DE REPETIBILIDADE ({samples} amostras)"
    
    # Prepara√ß√£o
    G28
    G90
    G1 X100 Y310 Z10 F3000
    
    # Coletar amostras
    {% set measurements = [] %}
    {% for i in range(samples) %}
        RESPOND MSG="üìè Amostra {i+1}/{samples}"
        PROBE
        {% set z_pos = printer.toolhead.position.z %}
        {% set measurements = measurements + [z_pos] %}
        G1 Z10 F600  # Retra√ß√£o
        G4 P1000     # Pausa
    {% endfor %}
    
    # An√°lise estat√≠stica
    {% set avg = (measurements|sum) / measurements|length %}
    {% set min_val = measurements|min %}
    {% set max_val = measurements|max %}
    {% set range_val = max_val - min_val %}
    
    RESPOND MSG="üìä RESULTADOS ESTAT√çSTICOS:"
    RESPOND MSG="   M√©dia: {avg|round(4)}mm"
    RESPOND MSG="   M√≠nimo: {min_val|round(4)}mm"
    RESPOND MSG="   M√°ximo: {max_val|round(4)}mm"
    RESPOND MSG="   Amplitude: {range_val|round(4)}mm"
    
    {% if range_val < 0.02 %}
        RESPOND MSG="‚úÖ EXCELENTE: Repetibilidade < 0.02mm"
    {% elif range_val < 0.05 %}
        RESPOND MSG="‚úÖ BOM: Repetibilidade < 0.05mm"
    {% else %}
        RESPOND MSG="‚ö†Ô∏è ATEN√á√ÉO: Repetibilidade > 0.05mm - verificar sistema"
    {% endif %}

#####################################################################
#                    CONFIGURA√á√ÉO PARA DIFERENTES MESAS           #
#####################################################################

# Para mesa de vidro
[gcode_macro CONFIG_MESA_VIDRO]
gcode:
    RESPOND MSG="ü™ü Configura√ß√£o para mesa de vidro"
    # Sensor capacitivo pode ter dificuldade com vidro
    # Recomenda-se superf√≠cie met√°lica auxiliar

# Para mesa de alum√≠nio
[gcode_macro CONFIG_MESA_ALUMINIO]
gcode:
    RESPOND MSG="üîß Configura√ß√£o para mesa de alum√≠nio"
    # Ideal para sensor capacitivo
    # Ajustar sensibilidade se necess√°rio

# Para mesa magn√©tica
[gcode_macro CONFIG_MESA_MAGNETICA]
gcode:
    RESPOND MSG="üß≤ Configura√ß√£o para mesa magn√©tica"
    # Pode interferir com sensor capacitivo
    # Testar posicionamento do sensor

#####################################################################
#                         MANUTEN√á√ÉO PREVENTIVA                    #
#####################################################################

[gcode_macro MANUT_SENSOR_SEM]
description: Rotina de manuten√ß√£o semanal do sensor
gcode:
    RESPOND MSG="üîß MANUTEN√á√ÉO SEMANAL DO SENSOR"
    
    # Teste b√°sico
    TESTE_SENSOR_BASICO
    
    # Teste de repetibilidade
    TESTE_AUTO_REPETIBILIDADE SAMPLES=5
    
    # Limpeza virtual (lembrete)
    RESPOND MSG="üßΩ LEMBRETE: Limpe a superf√≠cie de refer√™ncia"
    RESPOND MSG="üîç LEMBRETE: Verifique fixa√ß√£o do sensor"
    RESPOND MSG="‚ö° LEMBRETE: Verifique conex√µes el√©tricas"
    
    RESPOND MSG="‚úÖ Manuten√ß√£o semanal conclu√≠da"

#####################################################################
#                    INTEGRA√á√ÉO COM SISTEMA EXISTENTE              #
#####################################################################

# Modifica√ß√£o da macro existente para usar sensor autom√°tico
[gcode_macro CALIBRAR_T0_AUTO]
description: Calibra√ß√£o autom√°tica de T0 usando sensor
gcode:
    RESPOND MSG="ü§ñ Calibra√ß√£o autom√°tica T0 iniciada"
    
    # Usar sistema autom√°tico se dispon√≠vel
    {% if 'probe' in printer %}
        CALIBRAR_AUTO_FERRAMENTA TOOL=0
    {% else %}
        # Fallback para sistema manual
        CALIBRAR_T0_TP223
    {% endif %}

[gcode_macro CALIBRAR_T0_XYZ_AUTO]
description: Calibra√ß√£o XYZ autom√°tica espec√≠fica para T0
gcode:
    RESPOND MSG="üîß Calibrando T0 XYZ automaticamente..."
    CALIBRAR_XYZ_AUTO_COMPLETO TOOL=extruder
    RESPOND MSG="‚úÖ T0 XYZ calibrado!"

# Comando unificado que escolhe m√©todo automaticamente
[gcode_macro CALIBRAR_INTELIGENTE]
description: Calibra√ß√£o inteligente - autom√°tica se sensor dispon√≠vel
gcode:
    {% set tool = params.TOOL|default(0)|int %}
    
    {% if 'probe' in printer %}
        RESPOND MSG="ü§ñ Usando calibra√ß√£o autom√°tica para T{tool}"
        CALIBRAR_AUTO_FERRAMENTA TOOL={tool}
    {% else %}
        RESPOND MSG="üë§ Usando calibra√ß√£o manual para T{tool}"
        CALIBRAR_T{tool}
    {% endif %}

[gcode_macro CALIBRAR_XYZ_INTELIGENTE]
description: Calibra√ß√£o XYZ inteligente baseada em condi√ß√µes
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}
        G28
    {% endif %}
    
    {% if printer.extruder.temperature < 180 %}
        RESPOND MSG="‚ö†Ô∏è Aquecendo extrusor..."
        M109 S200
    {% endif %}
    
    CALIBRAR_XYZ_AUTO_COMPLETO
    RESPOND MSG="üéØ Calibra√ß√£o XYZ inteligente conclu√≠da!"