# ====== CONFIGURAÇÃO DOS LEDs AUTOMÁTICOS ======

# Configuração principal dos LEDs
[neopixel led_strip]
pin: PD15  #host:gpio18
chain_count: 64                   # Ajuste para sua quantidade
color_order: RGB
initial_RED: 0.1
initial_GREEN: 0.1
initial_BLUE: 0.1

# ====== MACROS AUTOMÁTICAS ======

# Chamado quando a impressora liga
[delayed_gcode startup_leds]
initial_duration: 2.0
gcode:
    SET_LED LED=led_strip RED=0.0 GREEN=0.0 BLUE=1.0  # Azul = Ligando
    G4 P1000  # Espera 1 segundo
    SET_LED LED=led_strip RED=0.0 GREEN=1.0 BLUE=0.0  # Verde = Pronta

# Macro para início de impressão (cole no seu slicer)
[gcode_macro PRINT_START]
gcode:
    SET_LED LED=led_strip RED=1.0 GREEN=0.5 BLUE=0.0  # Laranja = Imprimindo
    # Suas outras configurações de início aqui...

# Macro para fim de impressão (cole no seu slicer)
[gcode_macro PRINT_END] 
gcode:
    SET_LED LED=led_strip RED=0.0 GREEN=1.0 BLUE=0.0  # Verde = Concluído
    G4 P5000  # Verde por 5 segundos
    SET_LED LED=led_strip RED=0.1 GREEN=0.1 BLUE=0.1  # Volta ao padrão
    # Suas outras configurações de fim aqui...

# LEDs durante aquecimento da mesa
[gcode_macro BED_MESH_CALIBRATE]
rename_existing: BED_MESH_CALIBRATE_BASE
gcode:
    SET_LED LED=led_strip RED=0.0 GREEN=0.0 BLUE=1.0  # Azul = Nivelando
    BED_MESH_CALIBRATE_BASE {rawparams}
    SET_LED LED=led_strip RED=0.0 GREEN=1.0 BLUE=0.0  # Verde = Concluído

# LEDs durante homing
[gcode_macro RGBG28]
rename_existing: G28_BASE
gcode:
    SET_LED LED=led_strip RED=1.0 GREEN=0.0 BLUE=1.0  # Magenta = Homing
    G28_BASE {rawparams}
    SET_LED LED=led_strip RED=0.0 GREEN=1.0 BLUE=0.0  # Verde = Concluído

# ====== CONTROLES MANUAIS ======

# Liga LEDs brancos
[gcode_macro LEDS_ON]
gcode:
    SET_LED LED=led_strip RED=1.0 GREEN=1.0 BLUE=1.0

# Desliga LEDs
[gcode_macro LEDS_OFF]
gcode:
    SET_LED LED=led_strip RED=0.0 GREEN=0.0 BLUE=0.0

# LEDs vermelhos (aquecimento/erro)
[gcode_macro LEDS_HEATING]
gcode:
    SET_LED LED=led_strip RED=1.0 GREEN=0.0 BLUE=0.0

# LEDs verdes (pronto)
[gcode_macro LEDS_READY]
gcode:
    SET_LED LED=led_strip RED=0.0 GREEN=1.0 BLUE=0.0

# LEDs azuis (trabalhando)
[gcode_macro LEDS_WORKING]
gcode:
    SET_LED LED=led_strip RED=0.0 GREEN=0.0 BLUE=1.0

# ====== EFEITO DE PROGRESSO DURANTE IMPRESSÃO ======

# Atualiza LEDs baseado no progresso (chame do slicer a cada layer)
[gcode_macro PROGRESS_LEDS]
gcode:
    {% set progress = params.P|default(0)|float %}
    {% set led_count = printer.configfile.settings.neopixel.led_strip.chain_count|int %}
    {% set leds_on = (progress * led_count / 100)|int %}
    
    # Desliga todos
    SET_LED LED=led_strip RED=0.0 GREEN=0.0 BLUE=0.0
    
    # Liga LEDs conforme progresso
    {% for i in range(1, leds_on + 1) %}
        SET_LED LED=led_strip RED=0.0 GREEN=1.0 BLUE=0.0 INDEX={i} TRANSMIT=0
    {% endfor %}
    
    # LED atual piscando
    {% if leds_on < led_count %}
        SET_LED LED=led_strip RED=1.0 GREEN=0.5 BLUE=0.0 INDEX={leds_on + 1} TRANSMIT=1
    {% endif %}