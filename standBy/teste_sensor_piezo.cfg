# Configura√ß√£o para teste do sensor piezoel√©trico no GPIO 22 (Pino 15)
# Adicione este arquivo ao printer.cfg com: [include teste_sensor_piezo.cfg]

# Sensor piezoel√©trico como bot√£o personalizado
# ATIVADO: Necess√°rio para calibra√ß√£o autom√°tica TP223
[gcode_button sensor_piezo]
pin: host:gpio22  # Pino 15 f√≠sico do Raspberry Pi (sem pull-up para maior sensibilidade)
press_gcode:
    # Resposta simples e segura
    RESPOND MSG="üî¥ Sensor acionado"
    # Atualizar vari√°vel para calibra√ß√£o autom√°tica
    SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=sensor_triggered VALUE=1
    SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=trigger_z VALUE={printer.gcode_move.gcode_position.z}
release_gcode:
    # Resposta simples e segura  
    RESPOND MSG="üü¢ Sensor liberado"

# Macro para teste r√°pido de sensibilidade
[gcode_macro TESTE_SENS_RAP]
description: Teste r√°pido para verificar sensibilidade do sensor
gcode:
    RESPOND MSG="üéØ TESTE R√ÅPIDO DE SENSIBILIDADE"
    RESPOND MSG="Estado inicial: {printer['gcode_button sensor_piezo'].state}"
    RESPOND MSG=""
    RESPOND MSG="üìã INSTRU√á√ïES:"
    RESPOND MSG="1. Toque LEVEMENTE o sensor"
    RESPOND MSG="2. Observe se aparece 'üî¥ Sensor acionado'"
    RESPOND MSG="3. Solte e veja se aparece 'üü¢ Sensor liberado'"
    RESPOND MSG=""
    RESPOND MSG="üîß SE A SENSIBILIDADE ESTIVER BAIXA:"
    RESPOND MSG="- Gire o potenci√¥metro da placa LM393 no sentido hor√°rio"
    RESPOND MSG="- Ou verifique as conex√µes dos fios"
    RESPOND MSG="- Teste com toques mais firmes"
    RESPOND MSG=""
    RESPOND MSG="‚ö° SE ESTIVER MUITO SENS√çVEL:"
    RESPOND MSG="- Gire o potenci√¥metro no sentido anti-hor√°rio"
    RESPOND MSG="- Verifique se n√£o h√° vibra√ß√£o na mesa"
    RESPOND MSG=""
    RESPOND MSG="Estado atual: {printer['gcode_button sensor_piezo'].state}"



    
[gcode_macro TTP223IND]
description: Teste independente do sensor de toque capacitivo TP223
variable_sensor_triggered: 0
variable_trigger_z: 0.0
variable_test_results: []
gcode:
    RESPOND MSG="üéØ ===== TTTP223_IND ====="
    
    # Reset vari√°veis
    SET_GCODE_VARIABLE MACRO=TTP223IND VARIABLE=sensor_triggered VALUE=0
    SET_GCODE_VARIABLE MACRO=TTP223IND VARIABLE=trigger_z VALUE=0.0
    
    # Salvar estado
    SAVE_GCODE_STATE NAME=teste_tp223
    G90
    
    # Mover para posi√ß√£o do sensor
    RESPOND MSG="üöÄ Movendo para posi√ß√£o do sensor TP223 (X320 Y100)..."
    G1 X320 Y100 Z10 F3000
    
    # Instru√ß√µes
    RESPOND MSG="üìã TESTE MANUAL:"
    RESPOND MSG="1. Use os controles para abaixar Z lentamente"
    RESPOND MSG="2. Observe quando o sensor TP223 detectar toque capacitivo"
    RESPOND MSG="3. Execute RESULTADO_TESTE_TP223 para ver dados"
    
    # Aguardar
    RESPOND MSG="‚è≥ Aguardando detec√ß√£o do sensor TP223..."
    RESPOND MSG="üí° Sensor TP223 monitorando GPIO 22"
    
    # Restaurar estado
    RESTORE_GCODE_STATE NAME=teste_tp223






[gcode_macro RESULTADO_TESTE_TP223]
description: Mostra resultado do √∫ltimo teste do sensor TP223
gcode:
    {% set triggered = printer["gcode_macro TESTE_TP223_IND"].sensor_triggered %}
    {% set trigger_z = printer["gcode_macro TESTE_TP223_IND"].trigger_z %}
    
    RESPOND MSG="üìä ===== RESULTADO TESTE TP223 ====="
    {% if triggered %}
        RESPOND MSG="‚úÖ Sensor TP223 ativado com sucesso!"
        RESPOND MSG="üìè Posi√ß√£o Z de detec√ß√£o: {trigger_z}mm"
        RESPOND MSG="üîß Offset calculado: {trigger_z + 0.5}mm"
        RESPOND MSG="üíæ Use este valor no z_offset do [probe]"
    {% else %}
        RESPOND MSG="‚ùå Sensor TP223 n√£o foi ativado ainda"
        RESPOND MSG="üí° Execute TESTE_TP223_IND primeiro"
    {% endif %}

# Macro para monitorar o estado do sensor em tempo real
[gcode_macro MONITOR_SENSOR_PIEZO]
description: Monitora o estado do sensor piezoel√©trico no GPIO 22
gcode:
    {% set duration = params.DURATION|default(60)|int %}  # Dura√ß√£o em segundos
    {% set interval = params.INTERVAL|default(0.5)|float %}  # Intervalo entre leituras
    
    RESPOND MSG="Iniciando monitoramento do sensor piezoel√©trico..."
    RESPOND MSG="GPIO 22 (Pino 15) - Dura√ß√£o: {duration}s, Intervalo: {interval}s"
    RESPOND MSG="Pressione o sensor para ver mudan√ßas de estado"
    RESPOND MSG="Para parar antes do tempo, use EMERGENCY_STOP"
    
    {% for i in range((duration / interval)|int) %}
        RESPOND MSG="Estado atual: {printer['gcode_button sensor_piezo'].state}"
        G4 P{interval * 1000}  # Pausa em milissegundos
    {% endfor %}
    
    RESPOND MSG="Monitoramento conclu√≠do!"

# Macro para teste r√°pido do sensor
[gcode_macro TESTE_SENSOR_PIEZO]
description: Teste r√°pido do sensor piezoel√©trico
gcode:
    RESPOND MSG="=== TESTE DO SENSOR PIEZOEL√âTRICO ==="
    RESPOND MSG="GPIO 22 (Pino 15 f√≠sico)"
    
    # Estado inicial
    RESPOND MSG="Estado inicial do sensor:"
    RESPOND MSG="Estado atual: {printer['gcode_button sensor_piezo'].state}"
    
    # Aguarda input do usu√°rio
    RESPOND MSG="Pressione o sensor para ver as mensagens autom√°ticas"
    RESPOND MSG="Estado esperado: 1 quando pressionado, 0 quando solto"
    RESPOND MSG="As mensagens aparecer√£o automaticamente quando tocar o sensor"

# Macro para calibra√ß√£o de sensibilidade
[gcode_macro CALIBRAR_SENSIBILIDADE_PIEZO]
description: Ajuda a calibrar a sensibilidade do sensor
gcode:
    {% set testes = params.TESTES|default(10)|int %}
    
    RESPOND MSG="=== CALIBRA√á√ÉO DE SENSIBILIDADE ==="
    RESPOND MSG="Realizando {testes} testes de sensibilidade"
    RESPOND MSG="Toque levemente no sensor a cada beep"
    
    {% for i in range(testes) %}
        RESPOND MSG="Teste {i+1}/{testes} - Toque AGORA!"
        M300 S1000 P200  # Beep
        G4 P1000  # Pausa 1 segundo
        RESPOND MSG="Estado: {printer['gcode_button sensor_piezo'].state}"
        G4 P2000  # Pausa 2 segundos entre testes
    {% endfor %}
    
    RESPOND MSG="Calibra√ß√£o conclu√≠da!"
    RESPOND MSG="Ajuste o potenci√¥metro da placa LM393 se necess√°rio"

# Macro para diagn√≥stico completo
[gcode_macro DIAGNOSTICO_SENSOR_PIEZO]
description: Diagn√≥stico completo do sensor piezoel√©trico
gcode:
    RESPOND MSG="=== DIAGN√ìSTICO DO SENSOR PIEZOEL√âTRICO ==="
    
    # Informa√ß√µes do sistema
    RESPOND MSG="Configura√ß√£o atual:"
    RESPOND MSG="- Pino: host:gpio22 (Pino 15 f√≠sico)"
    RESPOND MSG="- Pull-up: Ativado (^)"
    RESPOND MSG="- Tipo: Sensor piezoel√©trico com LM393"
    
    # Estado atual
    RESPOND MSG="Estado atual do sensor:"
    RESPOND MSG="Estado: {printer['gcode_button sensor_piezo'].state}"
    
    # Teste de conectividade
    RESPOND MSG="Iniciando teste de conectividade..."
    {% for i in range(5) %}
        RESPOND MSG="Leitura {i+1}/5: {printer['gcode_button sensor_piezo'].state}"
        G4 P1000
    {% endfor %}
    
    RESPOND MSG="Diagn√≥stico conclu√≠do!"
    RESPOND MSG="Verifique se o sensor responde consistentemente"

# Macro para monitoramento cont√≠nuo com log
[gcode_macro MONITOR_CONTINUO_PIEZO]
description: Monitoramento cont√≠nuo com log detalhado
gcode:
    {% set ciclos = params.CICLOS|default(20)|int %}
    
    RESPOND MSG="=== MONITORAMENTO CONT√çNUO ==="
    RESPOND MSG="Executando {ciclos} ciclos de monitoramento"
    
    {% for i in range(ciclos) %}
        {% set timestamp = printer.system_stats.cputime|round(1) %}
        RESPOND MSG="[{timestamp}s] Ciclo {i+1}/{ciclos} - Estado: {printer['gcode_button sensor_piezo'].state}"
        
        # Pausa vari√°vel para detectar mudan√ßas
        G4 P500
    {% endfor %}
    
    RESPOND MSG="Monitoramento cont√≠nuo finalizado!"

# Comandos √∫teis para refer√™ncia
[gcode_macro AJUDA_SENSOR_PIEZO]
description: Mostra comandos dispon√≠veis para teste do sensor
gcode:
    RESPOND MSG="=== COMANDOS DISPON√çVEIS ==="
    RESPOND MSG="TESTE_SENSOR_PIEZO - Teste b√°sico"
    RESPOND MSG="MONITOR_SENSOR_PIEZO DURATION=30 - Monitor por 30s"
    RESPOND MSG="CALIBRAR_SENSIBILIDADE_PIEZO TESTES=5 - 5 testes"
    RESPOND MSG="DIAGNOSTICO_SENSOR_PIEZO - Diagn√≥stico completo"
    RESPOND MSG="MONITOR_CONTINUO_PIEZO CICLOS=10 - 10 ciclos"
    RESPOND MSG="QUERY_PROBE - Estado atual do sensor"
    RESPOND MSG="=== CONEX√ïES ==="
    RESPOND MSG="Raspberry Pi Pino 15 (GPIO22) ‚Üí Placa LM393 OUT"
    RESPOND MSG="Raspberry Pi 5V ‚Üí Placa LM393 VCC"
    RESPOND MSG="Raspberry Pi GND ‚Üí Placa LM393 GND"
    RESPOND MSG="Piezo Centro ‚Üí Placa LM393 IN+"
    RESPOND MSG="Piezo Anel ‚Üí Placa LM393 GND"