#####################################################################
#          SISTEMA MULTI-FERRAMENTA - VERS√ÉO LIMPA               #
#                    SEM INTERCEPTA√á√ïES                           #
#####################################################################
# Este arquivo cont√©m apenas as funcionalidades de suporte para
# multi-ferramentas SEM interceptar comandos do Klipper/KlipperScreen
#
# INTERCEPTA√á√ïES REMOVIDAS:
# - PROBE_CALIBRATE (rename_existing removido)
# - Z_OFFSET_APPLY_PROBE (rename_existing removido)
# - ACCEPT (macro removida)
#
# FUNCIONALIDADES MANTIDAS:
# - Macros de suporte para multi-ferramentas
# - Aplica√ß√£o de offsets relativos
# - Utilit√°rios de diagn√≥stico
#
# NOVO SISTEMA RECOMENDADO:
# Use calibracao_multitools_independente.cfg
#####################################################################

[gcode_macro TOOL_STATE]
description: Estado das ferramentas multi-ferramenta
variable_tool: 1                      # Ferramenta ativa (1=T0, 2=T1, 3=T2, 4=T3)
variable_last_tool: 1                 # √öltima ferramenta usada
variable_tool_change_in_progress: False
gcode:
    # Macro de dados - n√£o executa c√≥digo

#####################################################################
#                    APLICA√á√ÉO DE OFFSETS RELATIVOS              #
#####################################################################

[gcode_macro APLICAR_OFFSET_REL]
description: Aplica offset de ferramenta relativa
gcode:
    {% set tool = params.TOOL|int %}
    
    RESPOND MSG="üîß Aplicando offset para T{tool - 1}..."
    
    # Obter offset da ferramenta
    {% set vars = printer.save_variables.variables %}
    {% set offset = 0.0 %}
    
    {% if tool == 2 %}
        {% set offset = vars.get('tool_0_offset_z', 0.0)|float %}
        RESPOND MSG="üìä Offset T1: {offset|round(4)}mm"
    {% elif tool == 3 %}
        {% set offset = vars.get('tool_1_offset_z', 0.0)|float %}
        RESPOND MSG="üìä Offset T2: {offset|round(4)}mm"
    {% elif tool == 4 %}
        {% set offset = vars.get('tool_2_offset_z', 0.0)|float %}
        RESPOND MSG="üìä Offset T3: {offset|round(4)}mm"
    {% else %}
        RESPOND MSG="üìä T0 (refer√™ncia): sem offset relativo"
    {% endif %}
    
    # Obter posi√ß√£o atual
    {% set current_z = printer.gcode_move.gcode_position.z|float %}
    {% set ref_z = printer.save_variables.variables.get('calibration_ref_z', 0.0)|float %}
    
    # Calcular novo offset baseado na posi√ß√£o atual
    {% set relative_offset = current_z - ref_z %}
    
    RESPOND MSG="üìä Calculando offset relativo:"
    RESPOND MSG="   Refer√™ncia T0: {ref_z|round(4)}mm"
    RESPOND MSG="   Posi√ß√£o atual: {current_z|round(4)}mm"
    RESPOND MSG="   Offset calculado: {relative_offset|round(4)}mm"
    
    # Salvar offset no variables.cfg
    {% if tool == 2 %}
        SAVE_VARIABLE VARIABLE=tool_0_offset_z VALUE={relative_offset}
        RESPOND MSG="üíæ T1 salvo em variables.cfg: tool_0_offset_z = {relative_offset|round(4)}"
    {% elif tool == 3 %}
        SAVE_VARIABLE VARIABLE=tool_1_offset_z VALUE={relative_offset}
        RESPOND MSG="üíæ T2 salvo em variables.cfg: tool_1_offset_z = {relative_offset|round(4)}"
    {% elif tool == 4 %}
        SAVE_VARIABLE VARIABLE=tool_2_offset_z VALUE={relative_offset}
        RESPOND MSG="üíæ T3 salvo em variables.cfg: tool_2_offset_z = {relative_offset|round(4)}"
    {% endif %}
    
    RESPOND MSG="‚úÖ Offset aplicado com sucesso!"
    RESPOND MSG="üîÑ Execute RESTART para aplicar mudan√ßas"

#####################################################################
#                    UTILIT√ÅRIOS DE DIAGN√ìSTICO                  #
#####################################################################

[gcode_macro STATUS_MULTITOOLS]
description: Mostra status do sistema multi-ferramentas
gcode:
    RESPOND MSG="üìä ===== STATUS MULTI-FERRAMENTAS ====="
    
    # Ferramenta ativa
    {% set active_tool = printer['gcode_macro TOOL_STATE'].tool|int %}
    RESPOND MSG="üîß Ferramenta ativa: T{active_tool - 1}"
    
    # Offsets salvos
    {% set vars = printer.save_variables.variables %}
    {% set t0_offset = printer.configfile.settings.bltouch.z_offset|float %}
    {% set t1_offset = vars.get('tool_0_offset_z', 0.0)|float %}
    {% set t2_offset = vars.get('tool_1_offset_z', 0.0)|float %}
    {% set t3_offset = vars.get('tool_2_offset_z', 0.0)|float %}
    
    RESPOND MSG="üìä OFFSETS ATUAIS:"
    RESPOND MSG="   T0 (refer√™ncia): {t0_offset|round(4)}mm [printer.cfg]"
    RESPOND MSG="   T1 (relativo): {t1_offset|round(4)}mm [variables.cfg]"
    RESPOND MSG="   T2 (relativo): {t2_offset|round(4)}mm [variables.cfg]"
    RESPOND MSG="   T3 (relativo): {t3_offset|round(4)}mm [variables.cfg]"
    
    # Verificar se offsets s√£o razo√°veis
    {% if t1_offset|abs > 1.0 or t2_offset|abs > 1.0 or t3_offset|abs > 1.0 %}
        RESPOND MSG="‚ö†Ô∏è ATEN√á√ÉO: Offsets muito grandes detectados!"
    {% endif %}
    
    RESPOND MSG="üí° SISTEMA RECOMENDADO:"
    RESPOND MSG="   Use calibracao_multitools_independente.cfg"
    RESPOND MSG="   Comandos: CALIBRAR_T0, CALIBRAR_T1, CALIBRAR_T2, CALIBRAR_T3"

[gcode_macro LIMPAR_OFFSETS]
description: Limpa todos os offsets de ferramentas (CUIDADO!)
gcode:
    RESPOND MSG="üö® ===== LIMPANDO OFFSETS MULTI-FERRAMENTAS ====="
    RESPOND MSG="‚ö†Ô∏è Esta a√ß√£o ir√° remover todos os offsets salvos!"
    
    # Limpar offsets das ferramentas
    SAVE_VARIABLE VARIABLE=tool_0_offset_z VALUE=0.0
    SAVE_VARIABLE VARIABLE=tool_1_offset_z VALUE=0.0
    SAVE_VARIABLE VARIABLE=tool_2_offset_z VALUE=0.0
    
    # Limpar vari√°veis de calibra√ß√£o
    SAVE_VARIABLE VARIABLE=calibration_ref_z VALUE=0.0
    SAVE_VARIABLE VARIABLE=calibration_tool VALUE=0
    
    RESPOND MSG="üóëÔ∏è Offsets limpos:"
    RESPOND MSG="   tool_0_offset_z = 0.0 (T1)"
    RESPOND MSG="   tool_1_offset_z = 0.0 (T2)"
    RESPOND MSG="   tool_2_offset_z = 0.0 (T3)"
    RESPOND MSG="   calibration_ref_z = 0.0"
    RESPOND MSG="   calibration_tool = 0"
    
    RESPOND MSG="‚úÖ Limpeza conclu√≠da!"
    RESPOND MSG="üîÑ Execute RESTART para aplicar mudan√ßas"
    RESPOND MSG="üí° Recalibre todas as ferramentas ap√≥s o restart"

#####################################################################
#                    INFORMA√á√ïES DO SISTEMA                      #
#####################################################################

[gcode_macro INFO_SISTEMA_MULTITOOLS]
description: Informa√ß√µes sobre o sistema multi-ferramentas
gcode:
    RESPOND MSG="üìñ ===== SISTEMA MULTI-FERRAMENTAS ====="
    RESPOND MSG="üîß VERS√ÉO: Limpa (sem intercepta√ß√µes)"
    RESPOND MSG=""
    RESPOND MSG="‚ùå INTERCEPTA√á√ïES REMOVIDAS:"
    RESPOND MSG="   ‚Ä¢ PROBE_CALIBRATE (rename_existing)"
    RESPOND MSG="   ‚Ä¢ Z_OFFSET_APPLY_PROBE (rename_existing)"
    RESPOND MSG="   ‚Ä¢ ACCEPT (macro personalizada)"
    RESPOND MSG=""
    RESPOND MSG="‚úÖ FUNCIONALIDADES MANTIDAS:"
    RESPOND MSG="   ‚Ä¢ APLICAR_OFFSET_FERRAMENTA_RELATIVA"
    RESPOND MSG="   ‚Ä¢ STATUS_MULTITOOLS"
    RESPOND MSG="   ‚Ä¢ LIMPAR_OFFSETS_MULTITOOLS"
    RESPOND MSG="   ‚Ä¢ Utilit√°rios de diagn√≥stico"
    RESPOND MSG=""
    RESPOND MSG="üéØ SISTEMA RECOMENDADO:"
    RESPOND MSG="   Arquivo: calibracao_multitools_independente.cfg"
    RESPOND MSG="   Comandos: CALIBRAR_T0, CALIBRAR_T1, CALIBRAR_T2, CALIBRAR_T3"
    RESPOND MSG="   Vantagens: Sem conflitos, mais confi√°vel"
    RESPOND MSG=""
    RESPOND MSG="üí° COMANDOS DISPON√çVEIS:"
    RESPOND MSG="   ‚Ä¢ STATUS_MULTITOOLS - Status do sistema"
    RESPOND MSG="   ‚Ä¢ LIMPAR_OFFSETS_MULTITOOLS - Limpar offsets"
    RESPOND MSG="   ‚Ä¢ INFO_SISTEMA_MULTITOOLS - Esta informa√ß√£o"

#####################################################################
#                    MIGRA√á√ÉO PARA NOVO SISTEMA                  #
#####################################################################

[gcode_macro MIGRAR_INDEP]
description: Instru√ß√µes para migrar para o sistema independente
gcode:
    RESPOND MSG="üîÑ ===== MIGRA√á√ÉO PARA SISTEMA INDEPENDENTE ====="
    RESPOND MSG=""
    RESPOND MSG="üìã PASSOS PARA MIGRA√á√ÉO:"
    RESPOND MSG=""
    RESPOND MSG="1Ô∏è‚É£ INCLUIR NOVO SISTEMA:"
    RESPOND MSG="   Adicione ao printer.cfg:"
    RESPOND MSG="   [include calibracao_multitools_independente.cfg]"
    RESPOND MSG=""
    RESPOND MSG="2Ô∏è‚É£ REMOVER SISTEMA ANTIGO (OPCIONAL):"
    RESPOND MSG="   Comente no printer.cfg:"
    RESPOND MSG="   #[include klipperscreen_multitools.cfg]"
    RESPOND MSG=""
    RESPOND MSG="3Ô∏è‚É£ REINICIAR KLIPPER:"
    RESPOND MSG="   Execute: RESTART"
    RESPOND MSG=""
    RESPOND MSG="4Ô∏è‚É£ TESTAR NOVOS COMANDOS:"
    RESPOND MSG="   ‚Ä¢ CALIBRAR_T0 - Calibrar T0 (refer√™ncia)"
    RESPOND MSG="   ‚Ä¢ CALIBRAR_T1 - Calibrar T1 (relativa)"
    RESPOND MSG="   ‚Ä¢ CALIBRAR_T2 - Calibrar T2 (relativa)"
    RESPOND MSG="   ‚Ä¢ CALIBRAR_T3 - Calibrar T3 (relativa)"
    RESPOND MSG="   ‚Ä¢ STATUS_CALIBRACAO_INDEPENDENTE - Status"
    RESPOND MSG=""
    RESPOND MSG="5Ô∏è‚É£ CONFIGURAR MENU (OPCIONAL):"
    RESPOND MSG="   Use: klipperscreen_menu_calibracao.cfg"
    RESPOND MSG=""
    RESPOND MSG="‚úÖ VANTAGENS DO NOVO SISTEMA:"
    RESPOND MSG="   ‚Ä¢ Sem intercepta√ß√µes problem√°ticas"
    RESPOND MSG="   ‚Ä¢ Controle total do processo"
    RESPOND MSG="   ‚Ä¢ Comandos dedicados para cada ferramenta"
    RESPOND MSG="   ‚Ä¢ Mais simples e confi√°vel"
    RESPOND MSG="   ‚Ä¢ F√°cil manuten√ß√£o e debug"

#####################################################################
#                    NOTA IMPORTANTE                             #
#####################################################################
# 
# ESTE ARQUIVO FOI LIMPO E N√ÉO INTERCEPTA MAIS COMANDOS!
# 
# Para calibra√ß√£o multi-ferramentas, use o novo sistema:
# - calibracao_multitools_independente.cfg
# - klipperscreen_menu_calibracao.cfg (opcional)
# 
# O novo sistema √© mais confi√°vel e n√£o causa conflitos
# com o KlipperScreen ou outros sistemas.
# 
#####################################################################