#
# MACRO PARA HOMING E CAPTURA DE REFER√äNCIAS T0, T1, T2
# Criada para obter refer√™ncias das ferramentas para compara√ß√£o
#

[gcode_macro HOMING_E_REFERENCIAS]
description: Faz homing e captura refer√™ncias de T0, T1, T2 para compara√ß√£o
gcode:
    RESPOND MSG="üè† ===== INICIANDO HOMING E CAPTURA DE REFER√äNCIAS ====="
    RESPOND MSG="üîß Processo: Homing ‚Üí T0 ‚Üí T1 ‚Üí T2 ‚Üí Relat√≥rio"
    
    # Salvar estado atual
    SAVE_GCODE_STATE NAME=homing_referencias
    
    # 1. HOMING COMPLETO
    RESPOND MSG="üè† 1/4 - Executando homing completo..."
    G28  # Homing de todos os eixos
    G90  # Modo absoluto
    
    # Aguardar estabiliza√ß√£o
    G4 P1000
    
    # 2. CAPTURAR REFER√äNCIA T0 (FERRAMENTA DE REFER√äNCIA)
    RESPOND MSG="üéØ 2/4 - Capturando refer√™ncia T0 (BLTouch)..."
    T0  # Ativar ferramenta T0
    G4 P2000  # Aguardar troca
    
    # Mover para posi√ß√£o central para medi√ß√£o
    G1 X130 Y100 Z10 F3000
    G4 P500
    
    # Medir posi√ß√£o de refer√™ncia T0 usando BLTouch
    PROBE_CALIBRATE
    TESTZ Z=-5  # Aproximar da mesa
    {% set ref_z_t0 = printer.gcode_move.gcode_position.z|float %}
    ABORT  # Sair do PROBE_CALIBRATE
    
    # Salvar refer√™ncia T0
    SAVE_VARIABLE VARIABLE=ref_t0_z VALUE={ref_z_t0}
    RESPOND MSG="{'‚úÖ T0 Refer√™ncia capturada: Z = ' ~ (ref_z_t0|round(4)) ~ 'mm'}"
    
    # 3. CAPTURAR REFER√äNCIA T1
    RESPOND MSG="üéØ 3/4 - Capturando refer√™ncia T1..."
    T1  # Ativar ferramenta T1
    G4 P2000  # Aguardar troca
    
    # Mover para posi√ß√£o central
    G1 X130 Y100 Z10 F3000
    G4 P500
    
    # Medir posi√ß√£o T1 (usando papel ou m√©todo manual)
    RESPOND MSG="üìã T1: Posicione papel e ajuste Z manualmente"
    RESPOND MSG="üí° Use comandos TESTZ para ajustar altura"
    RESPOND MSG="üí° Execute CONFIRMAR_REF_T1 quando perfeito"
    
    # Aguardar confirma√ß√£o manual (macro separada)
    # A posi√ß√£o ser√° salva pela macro CONFIRMAR_REF_T1
    
    # 4. CAPTURAR REFER√äNCIA T2
    RESPOND MSG="üéØ 4/4 - Preparando captura T2..."
    RESPOND MSG="üí° Execute T2 e depois CONFIRMAR_REF_T2 quando ajustado"
    
    # Restaurar estado
    RESTORE_GCODE_STATE NAME=homing_referencias
    
    RESPOND MSG="üèÅ ===== HOMING CONCLU√çDO - AGUARDANDO CONFIRMA√á√ïES ====="
    RESPOND MSG="üìù Pr√≥ximos passos:"
    RESPOND MSG="   1. Ajuste T1 e execute: CONFIRMAR_REF_T1"
    RESPOND MSG="   2. Execute T2, ajuste e execute: CONFIRMAR_REF_T2"
    RESPOND MSG="   3. Execute: RELATORIO_REFERENCIAS para ver compara√ß√£o"

[gcode_macro CONFIRMAR_REF_T1]
description: Confirma e salva a refer√™ncia da ferramenta T1
gcode:
    {% set current_z = printer.gcode_move.gcode_position.z|float %}
    SAVE_VARIABLE VARIABLE=ref_t1_z VALUE={current_z}
    RESPOND MSG="{'‚úÖ T1 Refer√™ncia confirmada: Z = ' ~ (current_z|round(4)) ~ 'mm'}"
    RESPOND MSG="üîÑ Agora execute T2 e ajuste para confirmar T2"

[gcode_macro CONFIRMAR_REF_T2]
description: Confirma e salva a refer√™ncia da ferramenta T2
gcode:
    {% set current_z = printer.gcode_move.gcode_position.z|float %}
    SAVE_VARIABLE VARIABLE=ref_t2_z VALUE={current_z}
    RESPOND MSG="{'‚úÖ T2 Refer√™ncia confirmada: Z = ' ~ (current_z|round(4)) ~ 'mm'}"
    RESPOND MSG="üéØ Todas as refer√™ncias capturadas! Execute: RELATORIO_REFERENCIAS"

[gcode_macro RELATORIO_REFERENCIAS]
description: Mostra relat√≥rio comparativo das refer√™ncias T0, T1, T2
gcode:
    {% set vars = printer.save_variables.variables %}
    {% set ref_t0 = vars.get('ref_t0_z', 0.0)|float %}
    {% set ref_t1 = vars.get('ref_t1_z', 0.0)|float %}
    {% set ref_t2 = vars.get('ref_t2_z', 0.0)|float %}
    
    RESPOND MSG="üìä ===== RELAT√ìRIO DE REFER√äNCIAS DAS FERRAMENTAS ====="
    RESPOND MSG="üéØ Posi√ß√µes Z capturadas:"
    RESPOND MSG="{'   T0 (BLTouch): ' ~ ('%+.4f'|format(ref_t0)) ~ 'mm'}"
    RESPOND MSG="{'   T1:           ' ~ ('%+.4f'|format(ref_t1)) ~ 'mm'}"
    RESPOND MSG="{'   T2:           ' ~ ('%+.4f'|format(ref_t2)) ~ 'mm'}"
    
    RESPOND MSG="üìè Diferen√ßas relativas ao T0:"
    {% set diff_t1 = ref_t1 - ref_t0 %}
    {% set diff_t2 = ref_t2 - ref_t0 %}
    RESPOND MSG="{'   T1 vs T0:     ' ~ ('%+.4f'|format(diff_t1)) ~ 'mm'}"
    RESPOND MSG="{'   T2 vs T0:     ' ~ ('%+.4f'|format(diff_t2)) ~ 'mm'}"
    
    RESPOND MSG="üìè Diferen√ßa entre T1 e T2:"
    {% set diff_t1_t2 = ref_t2 - ref_t1 %}
    RESPOND MSG="{'   T2 vs T1:     ' ~ ('%+.4f'|format(diff_t1_t2)) ~ 'mm'}"
    
    # Mostrar offsets atuais para compara√ß√£o
    {% set offset_t1 = vars.get('tool_0_offset_z', 0.0)|float %}
    {% set offset_t2 = vars.get('tool_1_offset_z', 0.0)|float %}
    
    RESPOND MSG="‚öôÔ∏è Offsets atuais configurados:"
    RESPOND MSG="   T0: 0.0000mm (refer√™ncia)"
    RESPOND MSG="{'   T1: ' ~ ('%+.4f'|format(offset_t1)) ~ 'mm'}"
    RESPOND MSG="{'   T2: ' ~ ('%+.4f'|format(offset_t2)) ~ 'mm'}"
    
    RESPOND MSG="üí° Sugest√µes de ajuste:"
    {% if diff_t1|abs > 0.05 %}
        RESPOND MSG="{'   T1 precisa ajuste: diferen√ßa de ' ~ ('%+.4f'|format(diff_t1)) ~ 'mm'}"
    {% else %}
        RESPOND MSG="   T1 est√° bem calibrado (diferen√ßa < 0.05mm)"
    {% endif %}
    
    {% if diff_t2|abs > 0.05 %}
        RESPOND MSG="{'   T2 precisa ajuste: diferen√ßa de ' ~ ('%+.4f'|format(diff_t2)) ~ 'mm'}"
    {% else %}
        RESPOND MSG="   T2 est√° bem calibrado (diferen√ßa < 0.05mm)"
    {% endif %}
    
    RESPOND MSG="üìã ===== FIM DO RELAT√ìRIO ====="

[gcode_macro RESET_REFERENCIAS]
description: Limpa todas as refer√™ncias salvas
gcode:
    SAVE_VARIABLE VARIABLE=ref_t0_z VALUE=0.0
    SAVE_VARIABLE VARIABLE=ref_t1_z VALUE=0.0
    SAVE_VARIABLE VARIABLE=ref_t2_z VALUE=0.0
    RESPOND MSG="üîÑ Todas as refer√™ncias foram resetadas"
    RESPOND MSG="üí° Execute HOMING_E_REFERENCIAS para capturar novamente"