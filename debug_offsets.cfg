#####################################################################
#                    DIAGN√ìSTICO DE OFFSETS                        #
#####################################################################

[gcode_macro DIAGNOSTICO_OFFSETS]
description: Diagn√≥stica problemas de mapeamento de offsets
gcode:
    RESPOND MSG="üîç ===== DIAGN√ìSTICO DE OFFSETS ====="
    RESPOND MSG="üìã MAPEAMENTO ATUAL:"
    
    # Mostrar mapeamento f√≠sico vs l√≥gico
    RESPOND MSG="üîß MAPEAMENTO F√çSICO ‚Üí L√ìGICO:"
    RESPOND MSG="   T0 (comando) ‚Üí TROCA TOOL=1 ‚Üí offset_x1/y1/z1 (DEVE SER 0,0,0)"
    RESPOND MSG="   T1 (comando) ‚Üí TROCA TOOL=2 ‚Üí offset_x2/y2/z2"
    RESPOND MSG="   T2 (comando) ‚Üí TROCA TOOL=3 ‚Üí offset_x3/y3/z3"
    RESPOND MSG="   T3 (comando) ‚Üí DESABILITADO"
    RESPOND MSG=""
    
    # Mostrar ferramenta ativa
    {% set active_tool = printer['gcode_macro TOOL_STATE'].tool|int %}
    {% if active_tool == 1 %}
        RESPOND MSG="üéØ FERRAMENTA ATIVA: T0 (ferramenta f√≠sica 1)"
    {% elif active_tool == 2 %}
        RESPOND MSG="üéØ FERRAMENTA ATIVA: T1 (ferramenta f√≠sica 2)"
    {% elif active_tool == 3 %}
        RESPOND MSG="üéØ FERRAMENTA ATIVA: T2 (ferramenta f√≠sica 3)"
    {% else %}
        RESPOND MSG="üéØ FERRAMENTA ATIVA: Nenhuma (tool={active_tool})"
    {% endif %}
    RESPOND MSG=""
    
    # Mostrar offsets armazenados
    RESPOND MSG="üìä OFFSETS ARMAZENADOS NO TOOL_DATA:"
    {% for i in range(1, 5) %}
        {% set x_offset = printer['gcode_macro TOOL_DATA']['offset_x' ~ i]|default(0.0)|float %}
        {% set y_offset = printer['gcode_macro TOOL_DATA']['offset_y' ~ i]|default(0.0)|float %}
        {% set z_offset = printer['gcode_macro TOOL_DATA']['offset_z' ~ i]|default(0.0)|float %}
        
        {% if i == 1 %}
            {% if x_offset == 0.0 and y_offset == 0.0 and z_offset == 0.0 %}
                RESPOND MSG="   ‚úÖ offset_x1/y1/z1 (T0): X={x_offset} Y={y_offset} Z={z_offset} - CORRETO"
            {% else %}
                RESPOND MSG="   ‚ùå offset_x1/y1/z1 (T0): X={x_offset} Y={y_offset} Z={z_offset} - DEVE SER 0,0,0!"
            {% endif %}
        {% else %}
            RESPOND MSG="   üîß offset_x{i}/y{i}/z{i} (T{i-1}): X={x_offset} Y={y_offset} Z={z_offset}"
        {% endif %}
    {% endfor %}
    RESPOND MSG=""
    
    # Verificar offset atualmente aplicado
    {% set current_x = printer.gcode_move.gcode_position.x - printer.gcode_move.position.x %}
    {% set current_y = printer.gcode_move.gcode_position.y - printer.gcode_move.position.y %}
    {% set current_z = printer.gcode_move.gcode_position.z - printer.gcode_move.position.z %}
    RESPOND MSG="üéØ OFFSET ATUALMENTE APLICADO:"
    RESPOND MSG="   X={current_x|round(4)} Y={current_y|round(4)} Z={current_z|round(4)}"
    RESPOND MSG=""
    
    # Recomenda√ß√µes
    {% if active_tool == 1 and (current_x != 0.0 or current_y != 0.0 or current_z != 0.0) %}
        RESPOND MSG="‚ö†Ô∏è PROBLEMA DETECTADO:"
        RESPOND MSG="   T0 est√° ativo mas tem offset n√£o-zero aplicado!"
        RESPOND MSG="   T0 deve ter offset 0,0,0 (√© a refer√™ncia BLTouch)"
        RESPOND MSG=""
        RESPOND MSG="üîß SOLU√á√ïES:"
        RESPOND MSG="   1. Execute CORRIGIR_OFFSET_T0 para zerar"
        RESPOND MSG="   2. Execute LIMPAR_OFFSETS_T0_PERMANENTE para corrigir TOOL_DATA"
    {% endif %}

[gcode_macro CORRIGIR_OFFSET_T0]
description: Corrige o offset de T0 para zero (refer√™ncia)
gcode:
    {% set active_tool = printer['gcode_macro TOOL_STATE'].tool|int %}
    
    {% if active_tool == 1 %}
        RESPOND MSG="üîß Corrigindo offset de T0 para ZERO (refer√™ncia BLTouch)..."
        SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0 MOVE=1
        RESPOND MSG="‚úÖ T0 agora tem offset correto: 0,0,0"
    {% else %}
        RESPOND MSG="‚ö†Ô∏è T0 n√£o est√° ativo. Ferramenta ativa: {active_tool}"
        RESPOND MSG="üí° Execute T0 primeiro, depois CORRIGIR_OFFSET_T0"
    {% endif %}

[gcode_macro LIMPAR_OFFSETS_T0_PERMANENTE]
description: Zera permanentemente os offsets de T0 no TOOL_DATA
gcode:
    RESPOND MSG="üßπ Zerando offsets de T0 no TOOL_DATA..."
    
    # Zerar offset_x1, offset_y1 (que correspondem ao T0)
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=offset_x1 VALUE=0.0
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=offset_y1 VALUE=0.0
    # offset_z1 removido - T0 sempre tem Z=0.0 (refer√™ncia)
    
    # Salvar nas vari√°veis persistentes
    SAVE_VARIABLE VARIABLE=tool_1_offset_x VALUE=0.0
    SAVE_VARIABLE VARIABLE=tool_1_offset_y VALUE=0.0
    SAVE_VARIABLE VARIABLE=tool_1_offset_z VALUE=0.0
    
    RESPOND MSG="‚úÖ Offsets de T0 zerados permanentemente"
    RESPOND MSG="üíæ Execute SAVE_CONFIG para salvar"
    RESPOND MSG="üîÑ Execute T0 para aplicar a corre√ß√£o"

[gcode_macro SHOW_MAP_TOOLS]
description: Mostra o mapeamento completo das ferramentas
gcode:
    RESPOND MSG="üó∫Ô∏è ===== MAPEAMENTO COMPLETO DAS FERRAMENTAS ====="
    RESPOND MSG=""
    RESPOND MSG="üìã COMANDOS ‚Üí MACROS ‚Üí OFFSETS:"
    RESPOND MSG="   T0 ‚Üí TROCA TOOL=1 ‚Üí offset_x1/y1/z1 (refer√™ncia BLTouch = 0,0,0)"
    RESPOND MSG="   T1 ‚Üí TROCA TOOL=2 ‚Üí offset_x2/y2/z2"
    RESPOND MSG="   T2 ‚Üí TROCA TOOL=3 ‚Üí offset_x3/y3/z3"
    RESPOND MSG="   T3 ‚Üí DESABILITADO (comentado no tools.cfg)"
    RESPOND MSG=""
    RESPOND MSG="üîß EXTRUSORES KLIPPER:"
    RESPOND MSG="   TOOL=1 (T0) ‚Üí extruder"
    RESPOND MSG="   TOOL=2 (T1) ‚Üí extruder1"
    RESPOND MSG="   TOOL=3 (T2) ‚Üí extruder2"
    RESPOND MSG=""
    RESPOND MSG="üìç POSI√á√ïES DOCK:"
    RESPOND MSG="   TOOL=1 (T0) ‚Üí dock_x1 = {printer['gcode_macro TOOL_DATA'].dock_x1}"
    RESPOND MSG="   TOOL=2 (T1) ‚Üí dock_x2 = {printer['gcode_macro TOOL_DATA'].dock_x2}"
    RESPOND MSG="   TOOL=3 (T2) ‚Üí dock_x3 = {printer['gcode_macro TOOL_DATA'].dock_x3}"
    RESPOND MSG="   TOOL=4 (T3) ‚Üí dock_x4 = {printer['gcode_macro TOOL_DATA'].dock_x4} (desabilitado)"
    RESPOND MSG=""
    RESPOND MSG="üí° LEMBRE-SE: T0 √© a refer√™ncia com BLTouch fixo, deve ter offset 0,0,0"

[gcode_macro TESTE_CORRECAO_T0]
description: Testa se a corre√ß√£o de T0 est√° funcionando
gcode:
    RESPOND MSG="üß™ ===== TESTE DE CORRE√á√ÉO T0 ====="
    
    # Ativar T0
    RESPOND MSG="1Ô∏è‚É£ Ativando T0..."
    T0
    G4 P2000  # Aguardar estabiliza√ß√£o
    
    # Verificar ferramenta ativa
    {% set active_tool = printer['gcode_macro TOOL_STATE'].tool|int %}
    RESPOND MSG="2Ô∏è‚É£ Ferramenta ativa: {active_tool} (deve ser 1 para T0)"
    
    # Verificar offset aplicado
    {% set current_x = printer.gcode_move.gcode_position.x - printer.gcode_move.position.x %}
    {% set current_y = printer.gcode_move.gcode_position.y - printer.gcode_move.position.y %}
    {% set current_z = printer.gcode_move.gcode_position.z - printer.gcode_move.position.z %}
    
    RESPOND MSG="3Ô∏è‚É£ Offset atualmente aplicado:"
    RESPOND MSG="   X={current_x|round(4)} Y={current_y|round(4)} Z={current_z|round(4)}"
    
    # Verificar se est√° correto
    {% if active_tool == 1 %}
        {% if current_x == 0.0 and current_y == 0.0 and current_z == 0.0 %}
            RESPOND MSG="‚úÖ TESTE PASSOU: T0 tem offset correto (0,0,0)"
        {% else %}
            RESPOND MSG="‚ùå TESTE FALHOU: T0 deveria ter offset 0,0,0"
            RESPOND MSG="üîß Execute CORRIGIR_OFFSET_T0 para corrigir"
        {% endif %}
    {% else %}
        RESPOND MSG="‚ùå TESTE FALHOU: T0 n√£o est√° ativo"
    {% endif %}
    
    RESPOND MSG="4Ô∏è‚É£ Testando troca T0 ‚Üí T1 ‚Üí T0..."
    T1
    G4 P2000
    T0
    G4 P2000
    
    # Verificar novamente ap√≥s troca
    {% set final_x = printer.gcode_move.gcode_position.x - printer.gcode_move.position.x %}
    {% set final_y = printer.gcode_move.gcode_position.y - printer.gcode_move.position.y %}
    {% set final_z = printer.gcode_move.gcode_position.z - printer.gcode_move.position.z %}
    
    RESPOND MSG="5Ô∏è‚É£ Offset ap√≥s troca T0‚ÜíT1‚ÜíT0:"
    RESPOND MSG="   X={final_x|round(4)} Y={final_y|round(4)} Z={final_z|round(4)}"
    
    {% if final_x == 0.0 and final_y == 0.0 and final_z == 0.0 %}
        RESPOND MSG="‚úÖ TESTE FINAL PASSOU: T0 mant√©m offset correto ap√≥s trocas"
        RESPOND MSG="üéâ CORRE√á√ÉO FUNCIONANDO PERFEITAMENTE!"
    {% else %}
        RESPOND MSG="‚ùå TESTE FINAL FALHOU: T0 n√£o mant√©m offset zero ap√≥s trocas"
        RESPOND MSG="üîß Problema ainda existe - verificar l√≥gica de APPLY_TOOL_OFFSET"
    {% endif %}