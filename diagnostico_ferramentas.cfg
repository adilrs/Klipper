# ===================================================================
# DIAGN√ìSTICO E RESOLU√á√ÉO DE PROBLEMAS DE FERRAMENTAS
# ===================================================================

[gcode_macro DIAGNOSTICO_COMPLETO]
description: Diagn√≥stico completo do sistema de ferramentas
gcode:
    RESPOND MSG="üîç ===== DIAGN√ìSTICO COMPLETO DO SISTEMA ====="
    RESPOND MSG=""
    
    # Estado atual
    {% set current_tool = printer['gcode_macro TOOL_STATE'].tool|int %}
    {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
    {% set show_current = current_tool - 1 %}
    {% set show_saved = saved_tool - 1 %}
    
    RESPOND MSG="üìä ESTADO ATUAL:"
    RESPOND MSG="   Ferramenta ativa (TOOL_STATE): T{show_current} (TOOL={current_tool})"
    RESPOND MSG="   Ferramenta salva (variables.cfg): T{show_saved} (TOOL={saved_tool})"
    
    {% if current_tool == saved_tool %}
        RESPOND MSG="   Status: ‚úÖ SINCRONIZADO"
    {% else %}
        RESPOND MSG="   Status: ‚ùå DESSINCRONIZADO - Execute SINCRONIZAR_ESTADO"
    {% endif %}
    
    RESPOND MSG=""
    RESPOND MSG="üîß OFFSETS Z ATIVOS:"
    {% for i in range(1, 5) %}
        {% set offset_z = printer['gcode_macro TOOL_DATA']['offset_z' ~ i]|default(0.0)|float %}
        {% set tool_display = i - 1 %}
        RESPOND MSG="   T{tool_display}: {('%+.4f'|format(offset_z))}mm"
    {% endfor %}
    
    RESPOND MSG=""
    RESPOND MSG="üíæ OFFSETS SALVOS (variables.cfg):"
    {% set tool_0_z = printer.save_variables.variables.get('tool_0_offset_z', 'N√ÉO DEFINIDO') %}
    {% set tool_1_z = printer.save_variables.variables.get('tool_1_offset_z', 'N√ÉO DEFINIDO') %}
    {% set tool_2_z = printer.save_variables.variables.get('tool_2_offset_z', 'N√ÉO DEFINIDO') %}
    RESPOND MSG="   T1: {tool_0_z}mm"
    RESPOND MSG="   T2: {tool_1_z}mm"
    RESPOND MSG="   T3: {tool_2_z}mm"
    
    RESPOND MSG=""
    RESPOND MSG="üõ†Ô∏è COMANDOS DE CORRE√á√ÉO:"
    {% if current_tool != saved_tool %}
        RESPOND MSG="   SINCRONIZAR_ESTADO - Corrige dessincroniza√ß√£o"
    {% endif %}
    RESPOND MSG="   FORCAR_FERRAMENTA_SEGURA - Reset completo para T0"
    RESPOND MSG="   INIT_TOOL_OFFSETS - Recarrega offsets Z"

[gcode_macro SINCRONIZAR_ESTADO]
description: Sincroniza estado da ferramenta entre TOOL_STATE e variables.cfg
gcode:
    {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
    SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={saved_tool}
    {% set show_t = saved_tool - 1 %}
    RESPOND PREFIX="INFO" MSG="üîÑ Estado sincronizado: T{show_t} ativa"
    M117 Estado sincronizado: T{show_t}

[gcode_macro FORCAR_FERRAMENTA_SEGURA]
description: For√ßa o sistema para T0 de forma segura
gcode:
    RESPOND PREFIX="INFO" MSG="üîÑ For√ßando sistema para T0 (estado seguro)..."
    
    # Definir T0 como ativa
    SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=1
    SAVE_VARIABLE VARIABLE=tool VALUE=1
    
    # Aplicar offset zero (T0 √© refer√™ncia)
    SET_GCODE_OFFSET X=0 Y=0 Z=0
    
    # Ativar extruder principal
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    
    RESPOND PREFIX="INFO" MSG="‚úÖ Sistema for√ßado para T0 - estado seguro"
    M117 T0 ativa (for√ßado)

[gcode_macro VERIFICAR_TRAVAMENTO]
description: Verifica se h√° condi√ß√µes que podem causar travamento
gcode:
    RESPOND MSG="üîç ===== VERIFICA√á√ÉO DE TRAVAMENTO ====="
    
    {% set current_tool = printer['gcode_macro TOOL_STATE'].tool|int %}
    {% set saved_tool = printer.save_variables.variables.tool|default(1)|int %}
    
    # Verificar dessincroniza√ß√£o
    {% if current_tool != saved_tool %}
        RESPOND MSG="‚ö†Ô∏è RISCO DE TRAVAMENTO: Estado dessincronizado"
        RESPOND MSG="   TOOL_STATE: {current_tool} | variables.cfg: {saved_tool}"
        RESPOND MSG="   Solu√ß√£o: Execute SINCRONIZAR_ESTADO"
    {% else %}
        RESPOND MSG="‚úÖ Estado sincronizado - sem risco de travamento"
    {% endif %}
    
    # Verificar ferramenta inv√°lida
    {% if current_tool < 1 or current_tool > 4 %}
        RESPOND MSG="‚ùå FERRAMENTA INV√ÅLIDA: TOOL={current_tool}"
        RESPOND MSG="   Solu√ß√£o: Execute FORCAR_FERRAMENTA_SEGURA"
    {% else %}
        RESPOND MSG="‚úÖ Ferramenta v√°lida: TOOL={current_tool}"
    {% endif %}
    
    # Verificar offsets
    {% set vars = printer.save_variables.variables %}
    # offset_z1 removido - T0 sempre tem Z=0.0 (refer√™ncia)
    {% set offset_z2 = vars.get('tool_0_offset_z', 0.0)|float %}
    {% set offset_z3 = vars.get('tool_1_offset_z', 0.0)|float %}
    
    RESPOND MSG="‚úÖ T0 com offset correto (0.0mm - refer√™ncia BLTouch)"
    
    RESPOND MSG="üìä Offsets atuais: T0=0.0 T1={offset_z2} T2={offset_z3} (todos direto de variables.cfg)"

[gcode_macro RESET_TOOLS]
description: Reset completo do sistema de ferramentas (EMERG√äNCIA)
gcode:
    RESPOND PREFIX="WARNING" MSG="üö® RESET COMPLETO DO SISTEMA DE FERRAMENTAS"
    
    # For√ßar T0
    SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE=1
    SAVE_VARIABLE VARIABLE=tool VALUE=1
    
    # Zerar todos os offsets
    SET_GCODE_OFFSET X=0 Y=0 Z=0
    
    # Ativar extruder principal
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    
    # Recarregar offsets
    INIT_TOOL_OFFSETS
    
    RESPOND PREFIX="INFO" MSG="‚úÖ Sistema resetado - T0 ativa, offsets recarregados"
    M117 Sistema resetado - T0 ativa

[gcode_macro TESTE_LOAD_OFF]
description: Testa se os offsets est√£o sendo carregados corretamente
gcode:
    RESPOND MSG="üß™ ===== TESTE DE CARREGAMENTO DE OFFSETS ====="
    
    # Mostrar valores em variables.cfg
    {% set vars = printer.save_variables.variables %}
    RESPOND MSG="üìÅ VALORES EM variables.cfg:"
    {% if 'tool_0_offset_z' in vars %}
        RESPOND MSG="   tool_0_offset_z = {vars.tool_0_offset_z}mm (T1)"
    {% else %}
        RESPOND MSG="   tool_0_offset_z = N√ÉO ENCONTRADO (T1)"
    {% endif %}
    {% if 'tool_1_offset_z' in vars %}
        RESPOND MSG="   tool_1_offset_z = {vars.tool_1_offset_z}mm (T2)"
    {% else %}
        RESPOND MSG="   tool_1_offset_z = N√ÉO ENCONTRADO (T2)"
    {% endif %}
    {% if 'tool_2_offset_z' in vars %}
        RESPOND MSG="   tool_2_offset_z = {vars.tool_2_offset_z}mm (OBSOLETO)"
    {% else %}
        RESPOND MSG="   tool_2_offset_z = N√ÉO ENCONTRADO (OBSOLETO)"
    {% endif %}
    
    RESPOND MSG=""
    RESPOND MSG="üõ†Ô∏è OFFSETS Z AGORA S√ÉO LIDOS DIRETAMENTE DE variables.cfg:"
    RESPOND MSG="   T0 = 0.0mm (sempre - refer√™ncia BLTouch)"
    RESPOND MSG="   T1 = {vars.get('tool_0_offset_z', 0.0)}mm"
    RESPOND MSG="   T2 = {vars.get('tool_1_offset_z', 0.0)}mm"
    
    RESPOND MSG=""
    RESPOND MSG="üîÑ EXECUTANDO INIT_TOOL_OFFSETS..."
    INIT_TOOL_OFFSETS
    
    RESPOND MSG=""
    RESPOND MSG="üõ†Ô∏è OFFSETS Z AP√ìS INIT_TOOL_OFFSETS (lidos de variables.cfg):"
    RESPOND MSG="   T0 = 0.0mm (sempre - refer√™ncia BLTouch)"
    RESPOND MSG="   T1 = {vars.get('tool_0_offset_z', 0.0)}mm"
    RESPOND MSG="   T2 = {vars.get('tool_1_offset_z', 0.0)}mm"
    
    RESPOND MSG=""
    RESPOND MSG="‚úÖ TESTE CONCLU√çDO: Offsets Z agora s√£o lidos diretamente de variables.cfg"
    RESPOND MSG="üí° N√£o h√° mais sincroniza√ß√£o com TOOL_DATA - sistema simplificado!"

[gcode_macro FORCAR_APLICACAO_OFFSETS]
description: For√ßa a aplica√ß√£o correta dos offsets da ferramenta ativa
gcode:
    {% set current_tool = printer['gcode_macro TOOL_STATE'].tool|int %}
    
    RESPOND MSG="üîß For√ßando aplica√ß√£o de offsets para TOOL={current_tool}..."
    
    # Primeiro, recarregar offsets do variables.cfg
    INIT_TOOL_OFFSETS
    
    # Aguardar um momento para garantir que os valores foram atualizados
    G4 P100
    
    # Aplicar offset da ferramenta ativa
    {% set vars = printer.save_variables.variables %}
    {% if current_tool == 1 %}
        # T0 sempre tem offset zero (refer√™ncia)
        SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0 MOVE=1
        RESPOND MSG="‚úÖ T0: Offset ZERO aplicado (refer√™ncia BLTouch)"
    {% elif current_tool == 2 %}
        # T1 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
        {% set x = printer['gcode_macro TOOL_DATA']['offset_x2']|default(0)|float %}
        {% set y = printer['gcode_macro TOOL_DATA']['offset_y2']|default(0)|float %}
        {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
        SET_GCODE_OFFSET X={x} Y={y} Z={z} MOVE=1
        RESPOND MSG="‚úÖ T1: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
    {% elif current_tool == 3 %}
        # T2 - X/Y fixos do TOOL_DATA, Z direto do variables.cfg
        {% set x = printer['gcode_macro TOOL_DATA']['offset_x3']|default(0)|float %}
        {% set y = printer['gcode_macro TOOL_DATA']['offset_y3']|default(0)|float %}
        {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
        SET_GCODE_OFFSET X={x} Y={y} Z={z} MOVE=1
        RESPOND MSG="‚úÖ T2: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
    {% else %}
        RESPOND MSG="‚ö†Ô∏è Ferramenta desconhecida: TOOL={current_tool}"
    {% endif %}
    
    M117 Offsets aplicados - TOOL={current_tool}