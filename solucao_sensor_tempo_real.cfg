# Macro de teste simples para verificar detec√ß√£o em tempo real
[gcode_macro TESTE_SENSOR_MOVIMENTO]
description: Teste simples de detec√ß√£o do sensor durante movimento
gcode:
    RESPOND MSG="üéØ Teste de detec√ß√£o em movimento - Posicionando..."
    G90
    G1 X320 Y100 Z10 F3000
    
    RESPOND MSG="üìã INSTRU√á√ïES:"
    RESPOND MSG="1. Toque no sensor TP223 AGORA para testar"
    RESPOND MSG="2. O sistema ir√° descer lentamente"
    RESPOND MSG="3. Toque no sensor quando quiser parar"
    
    # Verificar estado inicial
    {% if printer['gcode_button sensor_tp223_teste'].state == 'PRESSED' %}
        RESPOND MSG="‚úÖ Sensor j√° est√° ativado!"
    {% else %}
        RESPOND MSG="‚ö™ Sensor n√£o ativado - iniciando descida..."
        
        # Descida lenta com verifica√ß√µes
        G1 Z9 F100
        {% if printer['gcode_button sensor_tp223_teste'].state == 'PRESSED' %}
            RESPOND MSG="üîç SENSOR DETECTADO em Z=9mm!"
        {% else %}
            G1 Z8 F100
            {% if printer['gcode_button sensor_tp223_teste'].state == 'PRESSED' %}
                RESPOND MSG="üîç SENSOR DETECTADO em Z=8mm!"
            {% else %}
                G1 Z7 F100
                {% if printer['gcode_button sensor_tp223_teste'].state == 'PRESSED' %}
                    RESPOND MSG="üîç SENSOR DETECTADO em Z=7mm!"
                {% else %}
                    RESPOND MSG="‚ùå Sensor n√£o detectado durante movimento"
                {% endif %}
            {% endif %}
        {% endif %}
    {% endif %}
    
    G1 Z15 F1000  # Subir para posi√ß√£o segura
    RESPOND MSG="‚úÖ Teste conclu√≠do!"

# ===================================================================
#           SOLU√á√ÉO PARA DETEC√á√ÉO EM TEMPO REAL DO SENSOR TP223
# ===================================================================
# Problema identificado: Loops Jinja2 s√£o processados em tempo de compila√ß√£o,
# n√£o conseguindo detectar mudan√ßas de estado do sensor em tempo real.
# Solu√ß√£o: Usar comandos G-code condicionais e recurs√£o de macros.
# ===================================================================

[gcode_macro ESCANEAMENTO_VERTICAL_TP223]
description: Escaneamento vertical com detec√ß√£o em tempo real do sensor TP223
variable_altura_atual: 10.0
variable_altura_minima: 0.0
variable_passo: 1.0
variable_sensor_detectado: 0
variable_altura_deteccao: 0.0
gcode:
    RESPOND MSG="üéØ Iniciando escaneamento vertical com sensor TP223..."
    
    # Reset das vari√°veis
    SET_GCODE_VARIABLE MACRO=ESCANEAMENTO_VERTICAL_TP223 VARIABLE=sensor_detectado VALUE=0
    SET_GCODE_VARIABLE MACRO=ESCANEAMENTO_VERTICAL_TP223 VARIABLE=altura_atual VALUE=10.0
    SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=sensor_triggered VALUE=0
    
    # Posicionamento inicial
    G90
    G1 X320 Y100 Z10 F3000
    
    # Iniciar descida recursiva
    _DESCIDA_RECURSIVA_TP223

[gcode_macro _DESCIDA_RECURSIVA_TP223]
description: Descida recursiva que verifica sensor a cada passo
gcode:
    {% set altura = printer["gcode_macro ESCANEAMENTO_VERTICAL_TP223"].altura_atual %}
    {% set sensor_ok = printer["gcode_macro ESCANEAMENTO_VERTICAL_TP223"].sensor_detectado %}
    
    # Verificar se j√° detectou sensor ou chegou ao limite
    {% if sensor_ok == 1 %}
        RESPOND MSG="‚úÖ Sensor detectado! Finalizando escaneamento."
        G1 Z20 F1000  # Subir para posi√ß√£o segura
        _FINALIZAR_ESCANEAMENTO_TP223
    {% elif altura <= 0 %}
        RESPOND MSG="‚ö†Ô∏è Chegou a Z=0 sem detectar sensor!"
        G1 Z20 F1000
        _FINALIZAR_ESCANEAMENTO_TP223
    {% else %}
        # Verificar sensor ANTES de descer
        {% if printer['gcode_button sensor_tp223_teste'].state == 'PRESSED' %}
            {% set altura_atual = printer.gcode_move.gcode_position.z %}
            RESPOND MSG="üîç SENSOR TP223 DETECTADO ANTES DO MOVIMENTO! Altura: Z={altura_atual}mm"
            SET_GCODE_VARIABLE MACRO=ESCANEAMENTO_VERTICAL_TP223 VARIABLE=sensor_detectado VALUE=1
            SET_GCODE_VARIABLE MACRO=ESCANEAMENTO_VERTICAL_TP223 VARIABLE=altura_deteccao VALUE={altura_atual}
            _FINALIZAR_ESCANEAMENTO_TP223
        {% else %}
            # Descer um passo pequeno (0.5mm) para maior precis√£o
            {% set proxima_altura = altura - 0.5 %}
            G1 Z{proxima_altura} F150  # Velocidade mais lenta
            G4 P100  # Pausa menor para estabiliza√ß√£o
            
            RESPOND MSG="üìç Altura atual: Z={proxima_altura}mm - Verificando sensor..."
            
            # Verificar sensor ap√≥s movimento
            _VERIFICAR_SENSOR_TP223
            
            # Preparar pr√≥ximo passo
            SET_GCODE_VARIABLE MACRO=ESCANEAMENTO_VERTICAL_TP223 VARIABLE=altura_atual VALUE={proxima_altura}
            
            # Continuar descida se sensor n√£o foi detectado
            {% if printer["gcode_macro ESCANEAMENTO_VERTICAL_TP223"].sensor_detectado == 0 %}
                UPDATE_DELAYED_GCODE ID=continuar_descida DURATION=0.2
            {% endif %}
        {% endif %}
    {% endif %}

[gcode_macro _VERIFICAR_SENSOR_TP223]
description: Verifica estado atual do sensor TP223
gcode:
    # Verificar se o sensor foi ativado (verifica√ß√£o em tempo real)
    {% if printer['gcode_button sensor_tp223_teste'].state == 'PRESSED' %}
        {% set altura_atual = printer.gcode_move.gcode_position.z %}
        RESPOND MSG="üîç SENSOR TP223 DETECTADO! Altura: Z={altura_atual}mm"
        SET_GCODE_VARIABLE MACRO=ESCANEAMENTO_VERTICAL_TP223 VARIABLE=sensor_detectado VALUE=1
        SET_GCODE_VARIABLE MACRO=ESCANEAMENTO_VERTICAL_TP223 VARIABLE=altura_deteccao VALUE={altura_atual}
        # Parar movimento atual e subir para posi√ß√£o segura
        M400  # Aguardar movimentos pendentes
        G91   # Modo relativo
        G1 Z5 F1000  # Subir 5mm para posi√ß√£o segura
        G90   # Modo absoluto
    {% else %}
        RESPOND MSG="‚ö™ Sensor n√£o ativado em Z={printer.gcode_move.gcode_position.z}mm"
    {% endif %}

[delayed_gcode continuar_descida]
gcode:
    _DESCIDA_RECURSIVA_TP223

[gcode_macro _FINALIZAR_ESCANEAMENTO_TP223]
description: Finaliza o escaneamento e exibe resultados
gcode:
    {% set detectado = printer["gcode_macro ESCANEAMENTO_VERTICAL_TP223"].sensor_detectado %}
    {% set altura = printer["gcode_macro ESCANEAMENTO_VERTICAL_TP223"].altura_deteccao %}
    
    RESPOND MSG="üìä ===== RESULTADO DO ESCANEAMENTO ====="
    {% if detectado == 1 %}
        RESPOND MSG="‚úÖ Sensor TP223 funcionando corretamente!"
        RESPOND MSG="üìè Altura de detec√ß√£o: Z={altura}mm"
        RESPOND MSG="üéØ Trigger do sensor: ATIVO"
    {% else %}
        RESPOND MSG="‚ùå Sensor TP223 n√£o respondeu durante o escaneamento"
        RESPOND MSG="üîß Verificar: conex√£o GPIO 22, alimenta√ß√£o, configura√ß√£o"
    {% endif %}
    RESPOND MSG="========================================"

# ===================================================================
#                    MACRO DE TESTE ALTERNATIVA
# ===================================================================

[gcode_macro TESTE_SENSOR_PROBE_NATIVO]
description: Teste usando comando PROBE nativo do Klipper
gcode:
    RESPOND MSG="üîç Testando sensor usando comando PROBE nativo..."
    
    # Posicionar
    G90
    G1 X320 Y100 Z10 F3000
    
    # Tentar usar PROBE se estiver configurado
    {% if printer.probe %}
        RESPOND MSG="üì° Usando PROBE nativo do Klipper..."
        PROBE
        {% set probe_z = printer.probe.last_z_result %}
        RESPOND MSG="‚úÖ PROBE detectou superf√≠cie em Z={probe_z}mm"
    {% else %}
        RESPOND MSG="‚ö†Ô∏è PROBE n√£o configurado - usando m√©todo alternativo"
        ESCANEAMENTO_VERTICAL_TP223
    {% endif %}

# ===================================================================
#                         COMANDOS DE DEBUG
# ===================================================================

[gcode_macro DEBUG_SENSOR_TP223]
description: Debug detalhado do estado do sensor TP223
gcode:
    RESPOND MSG="üîß ===== DEBUG SENSOR TP223 ====="
    RESPOND MSG="GPIO 22 State: {printer['gcode_button sensor_tp223_teste'].state}"
    RESPOND MSG="Sensor Triggered: {printer['gcode_macro TESTE_TP223_IND'].sensor_triggered}"
    RESPOND MSG="Trigger Z: {printer['gcode_macro TESTE_TP223_IND'].trigger_z}"
    RESPOND MSG="Posi√ß√£o atual Z: {printer.gcode_move.gcode_position.z}"
    RESPOND MSG="==============================="

[gcode_macro RESET_SENSOR_TP223]
description: Reset completo das vari√°veis do sensor TP223
gcode:
    SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=sensor_triggered VALUE=0
    SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=trigger_z VALUE=0.0
    SET_GCODE_VARIABLE MACRO=ESCANEAMENTO_VERTICAL_TP223 VARIABLE=sensor_detectado VALUE=0
    SET_GCODE_VARIABLE MACRO=ESCANEAMENTO_VERTICAL_TP223 VARIABLE=altura_deteccao VALUE=0.0
    RESPOND MSG="üîÑ Vari√°veis do sensor TP223 resetadas"