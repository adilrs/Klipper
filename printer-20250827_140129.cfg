#[include mainsail-config/client.cfg]
[include mainsail.cfg]
#[server]
#unix_socket: /home/adilson/printer_data/comms/klippy.sock
[virtual_sdcard]
path: /home/adilson/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_29003D000451333232383731-if00
restart_method: command
[mcu host]
serial: /tmp/klipper_host_mcu 


  
#[mcu]                           # FLY board ID
#serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
### To find USB firmware ID: ls -l /dev/serial/by-id/
### Replace /dev/serial/by-id/usb-Klipper_stm32f407xx_XXXXXXXXXXXXXXXXXXXXX with the ID you found.

#canbus_uuid: e51d5c71a901
### To find CAN firmware ID: ~/klippy-env/bin/python ~/klipper/scripts/canbus_query.py can0
### For CAN ID, replace 'serial' with 'canbus_uuid:' and append the ID.
#[auto_speed]

#####################################################################
#                     Configuração de PAUSE Seguro                 #
#####################################################################
[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos: True
variable_custom_park_x: 300.0    # Posição X próxima ao limpa bicos
variable_custom_park_y: 200.0    # Posição Y segura para pause
variable_custom_park_dz: 5.0     # Elevação Z (5mm para segurança extra)
variable_retract: 2.0            # Retração durante PAUSE (2mm)
variable_cancel_retract: 5.0     # Retração durante CANCEL_PRINT
variable_speed_retract: 50.0     # Velocidade de retração
variable_unretract: 2.0          # Valor para desfazer retração
variable_speed_unretract: 50.0   # Velocidade para desfazer retração
variable_speed_hop: 20.0         # Velocidade de movimento Z
variable_speed_move: 100.0       # Velocidade de movimento XY
variable_user_resume_macro: "LIMPEZA_RESUME"  # Limpeza automática ao resumir
gcode:

#####################################################################
#                     MACRO DE LIMPEZA NO RESUME                  #
#####################################################################
[gcode_macro LIMPEZA_RESUME]
description: Limpeza automática do bico ao resumir impressão
gcode:
    {% set active_tool = printer.toolhead.extruder %}
    {% set temp = printer[active_tool].temperature|float %}
    
    {% if temp >= 170 %}
        RESPOND MSG="🧼 Executando limpeza automática do bico..."
        
        # Salva posição atual
        SAVE_GCODE_STATE NAME=limpeza_resume_state
        
        # Ativa servo para limpeza
        SET_SERVO SERVO=tool_servo WIDTH=1
        
        # Aplica offset da ferramenta ativa
        {% set tool_num = printer["gcode_macro TOOL_STATE"].tool|int %}
        {% if tool_num > 0 %}
            {% set x = printer["gcode_macro TOOL_DATA"]["offset_x" ~ tool_num]|default(0.0)|float %}
            {% set y = printer["gcode_macro TOOL_DATA"]["offset_y" ~ tool_num]|default(0.0)|float %}
            {% set z = printer["gcode_macro TOOL_DATA"]["offset_z" ~ tool_num]|default(0.0)|float %}
            SET_GCODE_OFFSET X={x} Y={y} Z={z} MOVE=0
        {% endif %}
        
        # Movimento para área de limpeza
        G90
        G1 X235 Y200 F10000
        G1 X280 Y260 F10000
        G1 X313 Y251 F10000
        
        # Posição inicial de limpeza
        G1 X235 Y250 F3000
        
        # Trajeto de limpeza
        G1 X300 Y260 F10000
        
        # Retorno via rota segura
        G1 Y200 F10000
        G1 X313 Y251 F10000
        
        # Pequena extrusão para limpar
        G91
        G1 E5 F3000
        G1 Y-12
        G4 P1000
        G90
        
        # Desativa servo
        SET_SERVO SERVO=tool_servo WIDTH=0
        
        # Restaura posição e offsets
        APPLY_TOOL_OFFSET
        RESTORE_GCODE_STATE NAME=limpeza_resume_state MOVE=1
        
        RESPOND MSG="✅ Limpeza concluída - retomando impressão"
    {% else %}
        RESPOND MSG="{'⚠️ Temperatura baixa (' ~ temp ~ '°C) - pulando limpeza'}"
    {% endif %}

#####################################################################
#                            Printer and Acceleration               #
#####################################################################
[input_shaper]
shaper_type_x: mzv
shaper_freq_x: 44.6
shaper_type_y: mzv
shaper_freq_y: 36.2
[force_move]
enable_force_move: true
[save_variables]
filename: ~/printer_data/config/variables.cfg
[resonance_tester]
accel_chip: adxl345
probe_points: 100,100,20
#max_accel: 5000
# CORREÇÃO IMPLEMENTADA - delayed_gcode original desabilitado
# A correção está no arquivo correcao_reinicio_ferramentas.cfg
[delayed_gcode init_tool_restore_OLD]
initial_duration: 1
gcode:
  {% set saved = printer.save_variables.variables.tool|default(1)|int %}
  {% set extr = "extruder" if saved==1 else "extruder" ~ (saved-1) %}
  SET_GCODE_VARIABLE MACRO=TOOL_STATE VARIABLE=tool VALUE={saved}
  RESPOND PREFIX="DEBUG" MSG="Boot restore: tool={saved} -> {extr}"
  ACTIVATE_EXTRUDER EXTRUDER={extr}
  RESPOND PREFIX="DEBUG" MSG="After ACTIVATE: active={printer.toolhead.extruder}"
  APPLY_TOOL_OFFSET_UNSEC
  INIT_TOOL_OFFSETS
  #M117 Ferramenta restaurada automaticamente

[gcode_macro PREPARE_IMPRESSAO]
description: Aplica limites seguros antes de imprimir
gcode:
  SET_VELOCITY_LIMIT VELOCITY=200 ACCEL=3500
  M117 Limites aplicados

[printer]                       # Printer settings
kinematics: corexy              # Kinematics: cartesian or corexy, etc.
max_velocity: 150
max_accel: 700
#max_velocity: 300               # Max printer speed   
#max_accel: 3000                 # Max acceleration (max 3000)
max_z_velocity: 15              # Max Z speed
max_z_accel: 100                # Max Z acceleration
square_corner_velocity: 5.0     # Square corner velocity, lower to reduce inertia
max_z_accel: 30              ; 👈 aceleração mais suave
max_z_velocity: 7        ; 👈 opcional se quiser deixar mais explícito
#####################################################################
#                             Temperature Monitoring                #
#####################################################################
#[temperature_sensor Fly-D8]     # FLY board temperature (rename as needed)
#sensor_type: temperature_mcu     # Linked to mcu (default)
[temperature_sensor rpi_temp]
sensor_type: temperature_host
min_temp: 10
max_temp: 85


[firmware_retraction]
#Você também pode ajustar os valores de retração durante a impressão, usando os seguintes comandos para controle mais fino:
#SET_RETRACTION  RETRACT_LENGTH=3  RETRACT_SPEED=40 UNRETRACT_EXTRA_LENGTH=0  UNRETRACT_SPEED=40
# Retraction settings
retract_length: 5.0
retract_speed: 50.0
unretract_extra_length: 0.1
unretract_speed: 50.0 
[exclude_object]
#--------------------------------------------------------------------
[temperature_sensor FLY-π]        # Host temperature
sensor_type: temperature_host     # Linked to host

[gcode_macro MODO_HOMING]
gcode:
  SET_TMC_FIELD STEPPER=stepper_x FIELD=TPWMTHRS VALUE=1048575
  SET_TMC_FIELD STEPPER=stepper_y FIELD=TPWMTHRS VALUE=1048575

[gcode_macro MODO_IMPRESSAO]
gcode:
  SET_TMC_FIELD STEPPER=stepper_x FIELD=TPWMTHRS VALUE=0
  SET_TMC_FIELD STEPPER=stepper_y FIELD=TPWMTHRS VALUE=0
  
[gcode_macro FG28]
description: "Força homing completo, ignorando estado"
gcode:
  M117 Forçando homing completo...
  MODO_HOMING
  G28
  MODO_IMPRESSAO
  M117 Homing forçado concluído!

  
[homing_override]
axes: xyz
gcode:
  RGBG28
  MODO_HOMING
  M117 Modo SpreadCycle ativado para homing
  
  # ⬇️ Aplica offset neutro temporário para homing
  SET_GCODE_OFFSET X=0 Y=0 Z=0
  
  # 🔍 Verifica parâmetros e status dos eixos
  {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
  {% set homed = printer.toolhead.homed_axes %}
  
  # ✅ Elevar Z antes do homing (apenas se necessário)
  {% if 'Z' not in homed %}
    SET_KINEMATIC_POSITION Z=0
    G1 Z5 F600
  {% endif %}
  
  # 🏠 HOMING Y (apenas se solicitado e não homado)
  {% if home_all or 'Y' in params %}
    {% if 'Y' not in homed %}
      M117 Homing Y...
      G4 P1000
      G28 Y
      G91
      G1 Y10 F3000
      G90
      M117 Y homado com sucesso
    {% else %}
      M117 Y já homado — pulando
    {% endif %}
  {% endif %}
  
  # 🏠 HOMING X (apenas se solicitado e não homado)
  {% if home_all or 'X' in params %}
    {% if 'X' not in homed %}
      M117 Homing X...
      G4 P2000
      G28 X
      G91
      G1 X10 F3000
      G90
      M117 X homado com sucesso
    {% else %}
      M117 X já homado — pulando
    {% endif %}
  {% endif %}
  
  # 🏠 HOMING Z (com verificação adequada)
  {% if home_all or 'Z' in params %}
    {% if 'Z' not in homed %}
      M117 Homing Z...
      MODO_IMPRESSAO
      G90
      G1 X130 Y100 F5000
      G28 Z
      G1 Z10 F1200
      M117 Z homado com sucesso
    {% else %}
      M117 Z já homado — pulando
    {% endif %}
  {% endif %}
  
  # 🔄 Finalização
  MODO_IMPRESSAO
  M117 Modo StealthChop ativado para impressão
  
  # ⬇️ Restaura offset da ferramenta atualmente selecionada
  APPLY_TOOL_OFFSET
  
  # ✅ Confirma conclusão
  M117 Homing concluído

  
#[homing_override]
#set_position_z: 0
#axes: x, y, z
#gcode:
#    M118 >>> Executando homing_override personalizado
#    G90
#    G1 Z10 F600           ; levanta o bico
#    G28 Y                 ; homing do eixo Y
#    #G1 F1000 Y10
###   G1 X110 Y180 F6000     ; move para o centro da cama
#    G28 Z                 ; homing do Z no centro
#####################################################################
# 	                         Bed Mesh Calibration
#####################################################################
#[safe_z_home]
#home_xy_position: 150,100  # centro da cama
#z_hop: 20
#z_hop_speed: 15
[adxl345]
cs_pin: PB12
spi_bus: spi2
[resonance_tester]
accel_chip: adxl345
probe_points: 150,100,20


[bed_mesh]
speed: 300                   # Calibration speed
#move_speed: 200                   # Calibration speed
horizontal_move_z: 5         # Z lift before moving to next point
mesh_min: 40,5
# Min calibration point x, y
#mesh_max: 250,270         # Max calibration point x, y  270, 270   
mesh_max: 280,150

probe_count: 3,3             # Sample points (4X4 = 16 points)
mesh_pps: 2,2                # Additional sample points
algorithm: bicubic           # Algorithm model
bicubic_tension: 0.2  
#z_hop: 10.0         # altura em milímetros (padrão: 5.0)
fade_start: 1.0
fade_end: 10.0
fade_target: 0.0
horizontal_move_z: 5  ; 

[bltouch]
set_output_mode: 5V
sensor_pin: ^PC0             # Signal pin
control_pin: PE6             # Servo control
x_offset: 40
y_offset: -50
#z_offset: 0.0                # ← Corrigido: valor neutro
speed: 5.0
sample_retract_dist: 10.0
stow_on_each_sample: True    # Força retração após cada medição
pin_up_touch_mode_reports_triggered: False  # Evita falsos triggers

samples: 1
samples_tolerance: 0.08
samples_tolerance_retries:2

#####################################################################
#             X/Y Stepper Motor Settings                            # 
#####################################################################
#                   z1                 z2
#                       B__________A
#                     
# 
# 
# 
#                   Z0     12864      Z3
# Sensorless homing ativado – fim de curso X+ e Y+ desabilitados fisicamente
#####################################################################
#                  X Stepper Motor      (DRIVER0)                   #
#####################################################################
## DRIVER0 motor position
[stepper_x]
step_pin: PE5                       # X step pin
dir_pin: PA8                        # X direction pin, add ! to reverse
enable_pin: !PA15                   # X enable pin, add ! or motor won't work
rotation_distance: 40               # Pulley circumference mm (2GT-20T: 40, 2GT-16T: 32)
microsteps: 16                      # Microsteps, higher = better quality, more load
full_steps_per_rotation: 200        # Steps per revolution (1.8°: 200, 0.9°: 400)
#endstop_pin: !PD9                    # Endstop pin, normally closed recommended
endstop_pin: tmc2209_stepper_x:virtual_endstop        # Endstop interface
### Add ! to reverse state if needed, prevents crashes if wire breaks
position_min: -20                   # Min soft limit
position_endstop: -20               # Max soft limit (250mm-300mm-350mm)
position_max: 315                   # Max mechanical limit (250mm-300mm-350mm)
homing_speed: 30                    # Homing speed (max 100)
homing_retract_dist: 0            # Retract distance after first trigger
#--------------------------------------------------------------------
##  Ensure correct driver model (2208 or 2209)

#--------------------------------------------------------------------
#[tmc2209 stepper_x]
#cs_pin: PC9                         # SPI CS pin
#spi_bus: spi3                       # SPI bus
#run_current: 1.0                    # Motor run current
#interpolate: False                  # 256 microstep interpolation (True/False)
#sense_resistor: 0.075               # Do not change (2209 Pro: 0.033)
#stealthchop_threshold: 100            # StealthChop threshold (set 0 to disable)

#####################################################################
#                  Y Stepper Motor      (DRIVER1)                   #
####################################################################
## DRIVER1 motor position
[stepper_y]
step_pin: PE4
dir_pin: PC11
enable_pin: !PC12
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 200
#endstop_pin: !PD8                   # Endstop pin, normally closed recommended
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_min: 0
position_endstop: 0   #200
position_max: 280
homing_speed: 30
homing_retract_dist: 0

[tmc2209 stepper_x]
uart_pin: ^PC9
interpolate: True
run_current: 0.7
hold_current: 0.5

sense_resistor: 0.110
stealthchop_threshold: 0    #999999
diag_pin: PD9   # Pino conectado ao DIAG do driver
driver_SGTHRS: 90

[tmc2209 stepper_y]
uart_pin: ^PC10
interpolate: True
run_current: 0.7
hold_current: 0.5

sense_resistor: 0.110
stealthchop_threshold: 0     #999999
diag_pin: PD8
driver_SGTHRS: 100

#--------------------------------------------------------------------
#[tmc2209 stepper_y]
#cs_pin: PC10
#spi_bus: spi3                       # SPI bus
#run_current: 1.0                    # Motor run current
#interpolate: False                  # 256 microstep interpolation (True/False)
#sense_resistor: 0.075               # Do not change (2209 Pro: 0.033)
#stealthchop_threshold: 100            # StealthChop threshold (set 0 to disable)


#####################################################################
#                             Extruder Configuration
#####################################################################


## DRIVER4 motor position
[extruder]

step_pin: PE1
dir_pin: !PD7
enable_pin: !PB6
heater_pin: PD12
sensor_type: EPCOS 100K B57560G104F  # Generic 3950
sensor_pin: PC4
max_power: 1.0
min_temp: -100
max_temp: 250

microsteps: 16
rotation_distance: 32.7  #34.5575   #33.30  #34,5575
full_steps_per_rotation: 200
max_extrude_only_distance: 1000
nozzle_diameter: 0.400
filament_diameter: 1.750
min_extrude_temp: 150
pressure_advance: 0.12  ; ou até 0.25 conforme o tubo
pressure_advance_smooth_time: 0.04
#control: pid
#pid_kp: 26.213
#pid_ki: 1.304
#pid_kd: 131.721
 

##--------------------------------------------------------------------
## DRIVER5 motor position
 


[extruder1]
step_pin: PE0
dir_pin: PC13
enable_pin: !PC14
heater_pin: PD13                   # Heater pin (e0)
sensor_type: EPCOS 100K B57560G104F #Generic 3950           # Sensor type
sensor_pin: PC3       
microsteps: 16
full_steps_per_rotation: 200        # Steps per revolution (200 for 1.8°, 400 for 0.9°)
rotation_distance: 32.2 #34.5575 #33.30
max_extrude_only_distance: 1000
nozzle_diameter: 0.400              # Nozzle diameter
filament_diameter: 1.750            # Filament diameter
max_power: 1.0                      # Max heater PWM output
min_temp: -235                      # Min extruder temp
max_temp: 350                       # Max extruder temp
min_extrude_temp: 150               # Min extrude temp
pressure_advance: 0.12  ; ou até 0.25 conforme o tubo
pressure_advance_smooth_time: 0.04
## Nozzle PID tune: "PID_CALIBRATE HEATER=extruder TARGET=245"
control = pid
pid_kp = 26.213
pid_ki = 1.304
pid_Kd = 131.721

## DRIVER6 motor position



[extruder2]                          # Extruder
step_pin:PE7
dir_pin: PE11
enable_pin: !PE10
heater_pin: PD14                    # Heater pin (e0)
sensor_type: EPCOS 100K B57560G104F  #Generic 3950           # Sensor type
sensor_pin: PC2                     # Sensor pin (T_E0)
microsteps: 16
max_extrude_only_distance: 1000
full_steps_per_rotation: 200        # Steps per revolution (200 for 1.8°, 400 for 0.9°)
rotation_distance: 32.7 # 34.5575  # 33.30
nozzle_diameter: 0.400              # Nozzle diameter
filament_diameter: 1.750            # Filament diameter
max_power: 1.0                      # Max heater PWM output
min_temp: -100                        # Min extruder temp
max_temp: 250                       # Max extruder temp
min_extrude_temp: 150               # Min extrude temp
pressure_advance: 0.12  ; ou até 0.25 conforme o tubo
pressure_advance_smooth_time: 0.04
# Nozzle PID tune: "PID_CALIBRATE HEATER=extruder TARGET=245"
control = pid
pid_kp = 26.213
pid_ki = 1.304
pid_kd = 131.721


# EXTRUSORES - Precisão e torque
[tmc2209 extruder]
uart_pin: PD6
interpolate: true
run_current: 1.0  # Reduzido de 1.0A
hold_current: 0.8  # 50% da run_current
sense_resistor: 0.110
stealthchop_threshold: 0  # SpreadCycle sempre

[tmc2209 extruder1]
uart_pin: PB7
interpolate: true
run_current: 1.0
hold_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[tmc2209 extruder2]
uart_pin: PC15
interpolate: true
run_current: 0.6
hold_current: 0.4
sense_resistor: 0.110
stealthchop_threshold: 100

## DRIVER7 motor position
[extruder3]
step_pin: PE8
dir_pin: PE9
enable_pin: !PE12
heater_pin: PD15                    # Heater pin (e3)
sensor_type: EPCOS 100K B57560G104F  #Generic 3950           # Sensor type
sensor_pin: PC1                     # Sensor pin (T_E3)
microsteps: 16
max_extrude_only_distance: 1000
full_steps_per_rotation: 200        # Steps per revolution (200 for 1.8°, 400 for 0.9°)
rotation_distance: 32.7             # Ajustar conforme necessário
nozzle_diameter: 0.400              # Nozzle diameter
filament_diameter: 1.750            # Filament diameter
max_power: 1.0                      # Max heater PWM output
min_temp: -100                      # Min extruder temp
max_temp: 250                       # Max extruder temp
min_extrude_temp: 150               # Min extrude temp
pressure_advance: 0.12              # ou até 0.25 conforme o tubo
pressure_advance_smooth_time: 0.04
# Nozzle PID tune: "PID_CALIBRATE HEATER=extruder3 TARGET=245"
control = pid
pid_kp = 26.213
pid_ki = 1.304
pid_kd = 131.721

[tmc2209 extruder3]
uart_pin: PE13
interpolate: true
run_current: 0.6
hold_current: 0.4
sense_resistor: 0.110
stealthchop_threshold: 100

#####################################################################
#                            Heated Bed Configuration
#####################################################################
[heater_bed]
heater_pin: PB0              # Bed heater pin
sensor_type: Generic 3950    # Bed sensor type
sensor_pin: PC5              # Bed sensor pin
max_power: 1.0               # Bed power
min_temp: -235               # Min bed temp
max_temp: 120                # Max bed temp
# Bed PID tune: "PID_CALIBRATE HEATER=heater_bed TARGET=100"
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769
#####################################################################
#                             Fan Configuration
#####################################################################
#[fan]                        # Model cooling fan
#pin:PA0
#kick_start_time: 1.0         # Startup time (do not change)
#off_below: 0.10              # Do not change
#hardware_pwm: true
#max_power: 1.0
#--------------------------------------------------------------------
[heater_fan HOTEND_0]
pin: PA0
heater: extruder
heater_temp: 50.0

[heater_fan HOTEND_1]
pin: PA1
heater: extruder1
heater_temp: 50.0
[heater_fan HOTEND_2]
pin: PA2
heater: extruder2
heater_temp: 50.0

[heater_fan HOTEND_3]
pin: PA3
heater: extruder3
heater_temp: 50.0


#[heater_fan Throat Cooling]   # Throat cooling fan
#pin:PA1
#max_power: 1.0
#kick_start_time: 0.5         # Startup time (do not change)
#heater: extruder             # Linked device: extruder
#heater_temp: 50              # Fan turns on at this temp
#fan_speed: 1.0
#--------------------------------------------------------------------
#[heater_fan Bed Fan]         # Electronics bay fan
#pin: PA2
#max_power: 1.0
#shutdown_speed: 0.0
##kick_start_time: 5.0
#heater: heater_bed           # Linked device: bed
#heater_temp: 50              # Fan turns on at this temp
#fan_speed: 1.0
[controller_fan stepper_fan]
pin: PC6  # Substitua pelo pino real do seu cooler
kick_start_time: 0.5
off_below: 0.1
idle_timeout: 120  # tempo em segundos (2 minutos)
stepper: stepper_x, stepper_y, stepper_z,  extruder, extruder1, extruder2, extruder3
#valid steppers are: stepper_x, stepper_y, stepper_z, stepper_z1, extruder, extruder1, extruder2, extruder3
#---------------------------------------------------------------
#[fan_generic Bed Fan1]
#pin:PC6
#max_power: 1.0
# #--------------------------------------------------------------------
[fan_generic Print_Cooling]
pin:PC8
max_power: 1.0
# #--------------------------------------------------------------------
[fan_generic SideFan2]
pin:PC7
max_power: 1.0

#####################################################################
#                           Idle Timeout                            #
#####################################################################
[idle_timeout]
timeout: 1800                # Turn off bed after 30 minutes idle

#####################################################################
#                           Bed Leveling Probe                      #
#####################################################################
# Default PL08N probe should not be lower than nozzle, only for leveling.
# If your PL08N is NO (normally open), add ! to pin.
#[probe]
#pin: ^PC0                   # Endstop pin, normally closed + ! to reverse, io-2
#x_offset: 0                  # X offset from nozzle
#y_offset: 25.0               # Y offset from nozzle
#z_offset: 0                  # Z offset from nozzle
#speed: 10.0                  # Probing speed
#samples: 3                   # Number of samples
#samples_result: median       # Value method (default: median)
#sample_retract_dist: 4.0     # Probe retract distance
#samples_tolerance: 0.007     # Sample tolerance (too small may increase samples)
#samples_tolerance_retries: 3 # Retries if out of tolerance
##--------------------------------------------------------------------


 
# Z offset from nozzle
#probe_with_touch_mode: True
#pin_up_touch_mode_reports_triggered: False
#####################################################################
#                               Homing                              #
#####################################################################
#[safe_z_home]                # Z endstop coordinates
#home_xy_position: 167,151
##home_xy_position:150,40     # Z endstop position (IMPORTANT! Adjust as needed)
#speed:100                    # Homing speed
#z_hop:10                     # Z lift before homing
#--------------------------------------------------------------------
#[homing_override]
#axes: z
#set_position_z: 0
#gcode:
#   G90
#   G0 Z15 F600
#   G28 X Y
#    ## Z endstop XY position
#    ## Update X0 and Y0 to your values (e.g. X157, Y305)
#    ## Z endstop position
#   G0 X185 Y250 F3600    #250mm   
#   G28 Z
#   G0 Z10 F1800

#####################################################################
#                           2Z Leveling 
#####################################################################
 
[gcode_macro G32]
gcode:
  G28
  Z_TILT_ADJUST
  G1 Z10 F600

#####################################################################
#                            LED Configuration (enable if needed)
#####################################################################
#[neopixel sb_leds]
#pin: PA4                   # Signal pin
#chain_count: 24            # Number of LEDs
#color_order: GRB           # LED type
#initial_RED: 0.1            # Red
#initial_BLUE: 0.1             # Blue
#initial_WHITE: 0.0          
#--------------------------------------------------------------------
[board_pins]
aliases:
    EXP1_1=PB10, EXP1_3=PA14,  EXP1_5=PE15, EXP1_7=PE13, EXP1_9=<GND>,
    EXP1_2=PB1,  EXP1_4=PA13,  EXP1_6=PE14, EXP1_8=PB11, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PB14, EXP2_3=PA9,  EXP2_5=PA10,  EXP2_7=PE12,  EXP2_9=<GND>,
    EXP2_2=PB13, EXP2_4=PB12, EXP2_6=PB15,  EXP2_8=<RST>, EXP2_10=<NC>,
#--------------------------------------------------------------------    
#[display]
#lcd_type: uc1701                # LCD driver type
#cs_pin: EXP1_3                  # LCD CS pin
#a0_pin: EXP1_4                  # LCD A0 pin
#rst_pin: EXP1_5                 # LCD reset pin
#contrast: 63                    # Contrast
#encoder_pins: ^EXP2_5, ^!EXP2_3 # Encoder pins
#click_pin: ^!EXP1_2             # Encoder button pin
# --------------------------------------------------------------------
#### For FLY Mini12864
#[neopixel fly_mini12864]
#pin: EXP1_6                     # LCD backlight pin
#chain_count: 3
#initial_RED: 0.5                # Red LED brightness (0-1)
#initial_GREEN: 0.5              # Green LED brightness (0-1)
#initial_BLUE: 0.5               # Blue LED brightness (0-1)
#color_order: RGB                # Color order
#####################################################################
#                           Custom gcode Macros
#####################################################################
#####################################################################
#                     Z Stepper Motors                              #
## DRIVER2 motor position
#[include printer_single_z.cfg]


[gcode_macro TESTE_ECO]
gcode:
    RESPOND PREFIX="SHELL" MSG="Resultado: {printer['gcode_shell_command eco'].last_output}"
[include printer_dual_z.cfg]
#--------------------------------------------------------------------

[include pre_heat.cfg]
[include init_tool_offsets.cfg]
[include macros.cfg]
[include lidar.cfg]
[include auto_calibration.cfg]    # Sistema de calibração automática de tool offsets
[include debug_offsets.cfg]        # Diagnóstico e correção de problemas de offsets
[include diagnostico_ferramentas.cfg]
[include correcao_offsets.cfg]  # Diagnóstico e resolução de problemas de ferramentas
[include verificacao_ferramenta.cfg]  # Verificação e correção de estado de ferramenta
[include correcao_reinicio_ferramentas.cfg]
[include diagnostico_dessincronizacao.cfg]  # CORREÇÃO: Problema de reinício de ferramentas
# ===== SISTEMA MULTI-FERRAMENTA - NOVA VERSÃO INDEPENDENTE =====
[include calibracao_multitools_independente.cfg]  # Sistema independente de calibração (RECOMENDADO)
[include klipperscreen_menu_calibracao.cfg]        # Menu personalizado para KlipperScreen (opcional)

# ===== SISTEMA ANTIGO (DESATIVADO - CAUSAVA INTERCEPTAÇÕES) =====
#[include klipperscreen_multitools.cfg]  # Sistema antigo DESATIVADO - interceptações removidas
#[include leds.cfg]
#  blt era 1.5 
#[include custos.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bltouch]
#*# z_offset = 0.95
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.394375, -0.168438, -0.634688
#*# 	-0.307813, 0.173125, -0.015000
#*# 	-0.695625, -0.023125, 0.220000
#*# x_count = 3
#*# y_count = 3
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 40.0
#*# max_x = 280.0
#*# min_y = 5.0
#*# max_y = 150.0
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 67.766
#*# pid_ki = 2.841
#*# pid_kd = 404.052
#*#
#*# [bed_mesh MESA1]
#*# version = 1
#*# points =
#*# 	-0.286875, -0.073438, -0.230313
#*# 	-0.052188, 0.075312, -0.073750
#*# 	-0.211563, -0.138438, -0.206563
#*# x_count = 3
#*# y_count = 3
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 40.0
#*# max_x = 280.0
#*# min_y = 5.0
#*# max_y = 150.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 29.055
#*# pid_ki = 2.807
#*# pid_kd = 75.180
#*#
#*# [extruder1]
#*#
#*# [extruder2]
