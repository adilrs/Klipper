# Macro de Diagnóstico Completo do BLTouch
# Criada para resolver problemas de "BLTouch failed to deploy"

[gcode_macro DIAGNOSTICO_BLTOUCH]
description: Executa diagnóstico completo do BLTouch
gcode:
    RESPOND MSG="=== INICIANDO DIAGNÓSTICO BLTOUCH ==="
    
    # Etapa 1: Reset do BLTouch
    RESPOND MSG="Etapa 1: Reset do BLTouch"
    BLTOUCH_DEBUG COMMAND=reset
    G4 P1000  # Aguarda 1 segundo
    
    # Etapa 2: Teste de Deploy
    RESPOND MSG="Etapa 2: Teste de Deploy"
    BLTOUCH_DEBUG COMMAND=pin_down
    G4 P2000  # Aguarda 2 segundos
    
    # Etapa 3: Teste de Retração
    RESPOND MSG="Etapa 3: Teste de Retração"
    BLTOUCH_DEBUG COMMAND=pin_up
    G4 P1000  # Aguarda 1 segundo
    
    # Etapa 4: Teste de Self-Test
    RESPOND MSG="Etapa 4: Self-Test do BLTouch"
    BLTOUCH_DEBUG COMMAND=self_test
    G4 P3000  # Aguarda 3 segundos
    
    # Etapa 5: Reset final
    RESPOND MSG="Etapa 5: Reset final"
    BLTOUCH_DEBUG COMMAND=reset
    G4 P1000
    
    RESPOND MSG="=== DIAGNÓSTICO CONCLUÍDO ==="

[gcode_macro RESET_BLTOUCH_COMPLETO]
description: Reset completo do BLTouch com múltiplas tentativas
gcode:
    RESPOND MSG="=== RESET COMPLETO BLTOUCH ==="
    
    # Múltiplos resets para garantir funcionamento
    {% for i in range(3) %}
        RESPOND MSG="Reset {i+1}/3"
        BLTOUCH_DEBUG COMMAND=reset
        G4 P2000
        
        # Teste rápido após cada reset
        BLTOUCH_DEBUG COMMAND=pin_down
        G4 P500
        BLTOUCH_DEBUG COMMAND=pin_up
        G4 P500
    {% endfor %}
    
    RESPOND MSG="=== RESET COMPLETO FINALIZADO ==="

[gcode_macro HOMING_SEGURO_BLTOUCH]
description: Homing seguro com reset preventivo do BLTouch
gcode:
    RESPOND MSG="=== HOMING SEGURO COM BLTOUCH ==="
    
    # Reset preventivo
    RESET_BLTOUCH_COMPLETO
    
    # Homing dos eixos X e Y primeiro
    RESPOND MSG="Homing X e Y"
    G28 X Y
    
    # Aguarda e faz reset antes do Z
    G4 P2000
    BLTOUCH_DEBUG COMMAND=reset
    G4 P1000
    
    # Homing do eixo Z
    RESPOND MSG="Homing Z com BLTouch"
    G28 Z
    
    RESPOND MSG="=== HOMING SEGURO CONCLUÍDO ==="

[gcode_macro VERIFICAR_BLTOUCH]
description: Verifica se o BLTouch está funcionando corretamente
gcode:
    RESPOND MSG="=== VERIFICAÇÃO BLTOUCH ==="
    
    # Teste básico de funcionamento
    BLTOUCH_DEBUG COMMAND=reset
    G4 P1000
    
    # Teste de deploy/retract múltiplas vezes
    {% for i in range(5) %}
        RESPOND MSG="Teste {i+1}/5"
        BLTOUCH_DEBUG COMMAND=pin_down
        G4 P1000
        BLTOUCH_DEBUG COMMAND=pin_up
        G4 P1000
    {% endfor %}
    
    # Self-test final
    BLTOUCH_DEBUG COMMAND=self_test
    G4 P3000
    
    RESPOND MSG="=== VERIFICAÇÃO CONCLUÍDA ==="