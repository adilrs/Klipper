# ===================================================================
#                 TESTE INDEPENDENTE SENSOR TP223
# ===================================================================
# Configura√ß√£o para testar o sensor de toque capacitivo TP223 sem interferir
# no BLTouch que permanece ativo como probe principal
# Sensor: TP223 - Sensor de toque capacitivo digital
# ===================================================================

# Sensor TP223 como bot√£o para teste independente
[gcode_button sensor_tp223_teste]
pin: ^host:gpio22                    # GPIO 22 com pullup interno (TP223 sa√≠da digital)
press_gcode:
    RESPOND MSG="üîç SENSOR ATIVADO! Posi√ß√£o: X{printer.gcode_move.gcode_position.x} Y{printer.gcode_move.gcode_position.y} Z{printer.gcode_move.gcode_position.z}"
    SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=sensor_triggered VALUE=1
    SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=trigger_z VALUE={printer.gcode_move.gcode_position.z}

# ===================================================================
#                           MACROS DE TESTE
# ===================================================================

 # Macro para teste independente do sensor TP223
[gcode_macro TESTE_TP223_IND]
description: Teste independente do sensor de toque capacitivo TP223
variable_sensor_triggered: 0
variable_trigger_z: 0.0
variable_test_results: []
gcode:
    RESPOND MSG="üéØ ===== TESTE INDEPENDENTE SENSOR TP223 ====="
    
    # Reset vari√°veis
    SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=sensor_triggered VALUE=0
    SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=trigger_z VALUE=0.0
    
    # Salvar estado
    SAVE_GCODE_STATE NAME=teste_tp223
    G90
    
    # Mover para posi√ß√£o do sensor
    RESPOND MSG="üöÄ Movendo para posi√ß√£o do sensor TP223 (X320 Y100)..."
    G1 X320 Y100 Z10 F3000
    
    # Instru√ß√µes
    RESPOND MSG="üìã TESTE MANUAL:"
    RESPOND MSG="1. Use os controles para abaixar Z lentamente"
    RESPOND MSG="2. Observe quando o sensor TP223 detectar toque capacitivo"
    RESPOND MSG="3. Execute RESULTADO_TESTE_TP223 para ver dados"
    
    # Aguardar
    RESPOND MSG="‚è≥ Aguardando detec√ß√£o do sensor TP223..."
    RESPOND MSG="üí° Sensor TP223 monitorando GPIO 22"
    
    # Restaurar estado
    RESTORE_GCODE_STATE NAME=teste_tp223


[gcode_macro RESULTADO_TESTE_TP223]
description: Mostra resultado do √∫ltimo teste do sensor TP223
gcode:
    {% set triggered = printer["gcode_macro TESTE_TP223_IND"].sensor_triggered %}
    {% set trigger_z = printer["gcode_macro TESTE_TP223_IND"].trigger_z %}
    
    RESPOND MSG="üìä ===== RESULTADO TESTE TP223 ====="
    {% if triggered %}
        RESPOND MSG="‚úÖ Sensor TP223 ativado com sucesso!"
        RESPOND MSG="üìè Posi√ß√£o Z de detec√ß√£o: {trigger_z}mm"
        RESPOND MSG="üîß Offset calculado: {trigger_z + 0.5}mm"
        RESPOND MSG="üíæ Use este valor no z_offset do [probe]"
    {% else %}
        RESPOND MSG="‚ùå Sensor TP223 n√£o foi ativado ainda"
        RESPOND MSG="üí° Execute TESTE_TP223_IND primeiro"
    {% endif %}

[gcode_macro TESTE_PRECISAO_TP223_MANUAL]
description: Teste de precis√£o manual do sensor TP223
variable_measurements: []
variable_measurement_count: 0
gcode:
    RESPOND MSG="üéØ ===== TESTE PRECIS√ÉO TP223 MANUAL ====="
    
    # Reset
    SET_GCODE_VARIABLE MACRO=TESTE_PRECISAO_TP223_MANUAL VARIABLE=measurements VALUE="[]"
    SET_GCODE_VARIABLE MACRO=TESTE_PRECISAO_TP223_MANUAL VARIABLE=measurement_count VALUE=0
    
    # Posicionar
    G90
    G1 X320 Y100 Z10 F3000
    
    RESPOND MSG="üìã INSTRU√á√ïES:"
    RESPOND MSG="1. Abaixe Z at√© ativar o sensor TP223"
    RESPOND MSG="2. Execute REGISTRAR_MEDICAO_TP223"
    RESPOND MSG="3. Levante Z e repita 10 vezes"
    RESPOND MSG="4. Execute CALCULAR_PRECISAO_TP223"

[gcode_macro REGISTRAR_MEDICAO_TP223]
description: Registra uma medi√ß√£o do teste de precis√£o
gcode:
    {% set triggered = printer["gcode_macro TESTE_TP223_IND"].sensor_triggered %}
    {% set trigger_z = printer["gcode_macro TESTE_TP223_IND"].trigger_z %}
    {% set count = printer["gcode_macro TESTE_PRECISAO_TP223_MANUAL"].measurement_count %}
    
    {% if triggered %}
        {% set new_count = count + 1 %}
        SET_GCODE_VARIABLE MACRO=TESTE_PRECISAO_TP223_MANUAL VARIABLE=measurement_count VALUE={new_count}
        RESPOND MSG="üìè Medi√ß√£o {new_count}: Z = {trigger_z}mm"
        
        # Reset para pr√≥xima medi√ß√£o
        SET_GCODE_VARIABLE MACRO=TESTE_TP223_IND VARIABLE=sensor_triggered VALUE=0
        
        {% if new_count >= 10 %}
            RESPOND MSG="‚úÖ 10 medi√ß√µes completas! Execute CALCULAR_PRECISAO_TP223"
        {% else %}
            RESPOND MSG="‚è≥ Levante Z e fa√ßa a pr√≥xima medi√ß√£o ({10 - new_count} restantes)"
        {% endif %}
    {% else %}
        RESPOND MSG="‚ùå Sensor TP223 n√£o foi ativado. Abaixe Z at√© tocar a mesa."
    {% endif %}

[gcode_macro CALCULAR_PRECISAO_TP223]
description: Calcula estat√≠sticas de precis√£o do sensor TP223
gcode:
    {% set count = printer["gcode_macro TESTE_PRECISAO_TP223_MANUAL"].measurement_count %}
    
    RESPOND MSG="üìä ===== ESTAT√çSTICAS PRECIS√ÉO TP223 ====="
    RESPOND MSG="üìè Total de medi√ß√µes: {count}"
    
    {% if count >= 3 %}
        RESPOND MSG="‚úÖ Dados suficientes para an√°lise"
        RESPOND MSG="üí° Analise as medi√ß√µes registradas no console"
        RESPOND MSG="üéØ Range ideal: < 0.02mm para boa precis√£o"
        RESPOND MSG="‚ö†Ô∏è  Range > 0.05mm indica necessidade de ajuste"
    {% else %}
        RESPOND MSG="‚ùå Dados insuficientes. M√≠nimo 3 medi√ß√µes."
    {% endif %}

# ===================================================================
#                         COMANDOS √öTEIS
# ===================================================================
# TESTE_TP223_IND      - Inicia teste do sensor TP223
# RESULTADO_TESTE_TP223         - Mostra √∫ltimo resultado
# TESTE_PRECISAO_TP223_MANUAL   - Inicia teste de precis√£o
# REGISTRAR_MEDICAO_TP223       - Registra uma medi√ß√£o
# CALCULAR_PRECISAO_TP223       - Calcula estat√≠sticas
# G1 X320 Y100 Z10 F3000        - Mover para posi√ß√£o do sensor
# ===================================================================