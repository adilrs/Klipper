# ===================================================================
#           SOLU√á√ÉO FINAL PARA SENSOR TP223 - DETEC√á√ÉO EM TEMPO REAL
# ===================================================================
# Problema resolvido: Uso de verifica√ß√£o direta do gcode_button state
# em vez de vari√°veis Jinja2 que n√£o s√£o atualizadas em tempo real
# ===================================================================

[gcode_macro ESCANEAMENTO_FINAL_TP223]
description: Escaneamento vertical com detec√ß√£o garantida do sensor TP223
variable_altura_inicial: 10.0
variable_altura_minima: 0.5
variable_passo: 0.1
variable_velocidade: 100
gcode:
    RESPOND MSG="üéØ ESCANEAMENTO FINAL TP223 - Detec√ß√£o em tempo real"
    
    # Posicionamento inicial
    G90
    G1 X320 Y100 Z{printer['gcode_macro ESCANEAMENTO_FINAL_TP223'].altura_inicial} F3000
    
    RESPOND MSG="üìã Iniciando descida com verifica√ß√£o cont√≠nua..."
    
    # Usar comando nativo PROBE_ACCURACY com sensor customizado
    _DESCIDA_COM_DETECCAO_TP223

[gcode_macro _DESCIDA_COM_DETECCAO_TP223]
description: Descida controlada com detec√ß√£o em cada passo
variable_sensor_detectado: 0
variable_altura_atual: 10.0
gcode:
    # Reset das vari√°veis
    SET_GCODE_VARIABLE MACRO=_DESCIDA_COM_DETECCAO_TP223 VARIABLE=sensor_detectado VALUE=0
    SET_GCODE_VARIABLE MACRO=_DESCIDA_COM_DETECCAO_TP223 VARIABLE=altura_atual VALUE=10.0
    
    # Iniciar descida recursiva
    _PASSO_DESCIDA_TP223

[gcode_macro _PASSO_DESCIDA_TP223]
description: Um passo da descida com verifica√ß√£o do sensor
gcode:
    {% set altura = printer['gcode_macro _DESCIDA_COM_DETECCAO_TP223'].altura_atual %}
    {% set sensor_ok = printer['gcode_macro _DESCIDA_COM_DETECCAO_TP223'].sensor_detectado %}
    
    # Verificar se sensor j√° foi detectado
    {% if sensor_ok == 1 %}
        RESPOND MSG="‚úÖ Sensor j√° detectado! Finalizando."
        G1 Z15 F1000
        RESPOND MSG="üèÅ Escaneamento finalizado."
    {% elif altura <= 0.5 %}
        RESPOND MSG="‚ö†Ô∏è Chegou ao limite m√≠nimo Z=0.5mm"
        RESPOND MSG="‚ùå Sensor n√£o detectado durante todo o percurso"
        G1 Z15 F1000
        RESPOND MSG="üèÅ Escaneamento finalizado."
    {% else %}
        # Verificar sensor ANTES do movimento
        {% if printer['gcode_button sensor_tp223_teste'].state == 'PRESSED' %}
            RESPOND MSG="üîç SENSOR DETECTADO em Z={printer.gcode_move.gcode_position.z}mm!"
            SET_GCODE_VARIABLE MACRO=_DESCIDA_COM_DETECCAO_TP223 VARIABLE=sensor_detectado VALUE=1
            G1 Z{printer.gcode_move.gcode_position.z + 5} F1000  # Subir 5mm
            RESPOND MSG="‚úÖ Detec√ß√£o bem-sucedida! Sensor funcionando."
        {% else %}
            # Descer um passo
            {% set proxima_altura = altura - 0.1 %}
            G1 Z{proxima_altura} F100
            G4 P50  # Pausa curta para estabiliza√ß√£o
            
            # Verificar sensor AP√ìS o movimento
            {% if printer['gcode_button sensor_tp223_teste'].state == 'PRESSED' %}
                RESPOND MSG="üîç SENSOR DETECTADO em Z={proxima_altura}mm!"
                SET_GCODE_VARIABLE MACRO=_DESCIDA_COM_DETECCAO_TP223 VARIABLE=sensor_detectado VALUE=1
                G1 Z{proxima_altura + 5} F1000  # Subir 5mm
                RESPOND MSG="‚úÖ Detec√ß√£o bem-sucedida! Sensor funcionando."
            {% else %}
                RESPOND MSG="üìç Z={proxima_altura}mm - Sensor n√£o ativado, continuando..."
                SET_GCODE_VARIABLE MACRO=_DESCIDA_COM_DETECCAO_TP223 VARIABLE=altura_atual VALUE={proxima_altura}
                # Continuar descida
                UPDATE_DELAYED_GCODE ID=continuar_passo_descida DURATION=0.1
            {% endif %}
        {% endif %}
    {% endif %}

[delayed_gcode continuar_passo_descida]
gcode:
    _PASSO_DESCIDA_TP223

# ===================================================================
#                    MACRO DE TESTE R√ÅPIDO
# ===================================================================

[gcode_macro TESTE_RAPIDO_TP223]
description: Teste r√°pido do sensor TP223
gcode:
    RESPOND MSG="‚ö° TESTE R√ÅPIDO TP223"
    
    # Posicionar
    G90
    G1 X320 Y100 Z10 F3000
    
    # Verificar estado atual
    {% if printer['gcode_button sensor_tp223_teste'].state == 'PRESSED' %}
        RESPOND MSG="‚úÖ Sensor TP223 est√° ATIVO!"
    {% else %}
        RESPOND MSG="‚ö™ Sensor TP223 n√£o est√° ativo"
    {% endif %}
    
    RESPOND MSG="üìã Toque no sensor agora e execute novamente para testar"

# ===================================================================
#                    DIAGN√ìSTICO COMPLETO
# ===================================================================

[gcode_macro DIAGNOSTICO_TP223]
description: Diagn√≥stico completo do sensor TP223
gcode:
    RESPOND MSG="üîß DIAGN√ìSTICO COMPLETO TP223"
    
    # Verificar configura√ß√£o
    RESPOND MSG="üìä Estado do sensor: {printer['gcode_button sensor_tp223_teste'].state}"
    RESPOND MSG="üìç Posi√ß√£o atual: X{printer.gcode_move.gcode_position.x} Y{printer.gcode_move.gcode_position.y} Z{printer.gcode_move.gcode_position.z}"
    
    # Posicionar para teste
    G90
    G1 X320 Y100 Z10 F3000
    
    RESPOND MSG="üéØ Posicionado em X320 Y100 Z10"
    RESPOND MSG="üìã INSTRU√á√ïES:"
    RESPOND MSG="1. Toque no sensor TP223"
    RESPOND MSG="2. Execute TESTE_RAPIDO_TP223 para verificar"
    RESPOND MSG="3. Execute ESCANEAMENTO_FINAL_TP223 para teste completo"

# ===================================================================
#                    CONFIGURA√á√ÉO DE EMERG√äNCIA
# ===================================================================

[gcode_macro PARAR_ESCANEAMENTO]
description: Para qualquer escaneamento em andamento
gcode:
    M400  # Aguardar movimentos pendentes
    G91   # Modo relativo
    G1 Z5 F1000  # Subir 5mm
    G90   # Modo absoluto
    RESPOND MSG="üõë Escaneamento interrompido pelo usu√°rio"