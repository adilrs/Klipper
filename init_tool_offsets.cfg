#####################################################################
#                    SINCRONIZA√á√ÉO DE OFFSETS                     #
#####################################################################

[gcode_macro INIT_TOOL_OFFSETS]
description: Sincroniza offsets de variables.cfg para TOOL_DATA na inicializa√ß√£o
gcode:
    RESPOND MSG="üîÑ Sincronizando offsets de variables.cfg ‚Üí TOOL_DATA..."
    
    # Sincronizar APENAS offsets Z de variables.cfg para TOOL_DATA
    # Os valores X e Y permanecem fixos no tools.cfg
    {% set vars = printer.save_variables.variables %}
    
    # ‚úÖ SIMPLIFICADO: Offsets Z agora s√£o lidos diretamente do variables.cfg
    # N√£o √© mais necess√°rio sincronizar para TOOL_DATA
    
    # T0 (tool_1) - sempre offset ZERO (refer√™ncia BLTouch)
    RESPOND MSG="üîÑ T0: Offset Z=0.0mm (refer√™ncia BLTouch)"
    
    # T1 (tool_2) - verifica se existe no variables.cfg
    {% if 'tool_0_offset_z' in vars %}
        RESPOND MSG="{'üîÑ T1: Z=' ~ ('%+.4f'|format(vars.tool_0_offset_z)) ~ 'mm (lido diretamente de variables.cfg)'}"
    {% else %}
        RESPOND MSG="‚ö†Ô∏è T1: tool_0_offset_z n√£o encontrado em variables.cfg"
    {% endif %}
    
    # T2 (tool_3) - verifica se existe no variables.cfg
    {% if 'tool_1_offset_z' in vars %}
        RESPOND MSG="{'üîÑ T2: Z=' ~ ('%+.4f'|format(vars.tool_1_offset_z)) ~ 'mm (lido diretamente de variables.cfg)'}"
    {% else %}
        RESPOND MSG="‚ö†Ô∏è T2: tool_1_offset_z n√£o encontrado em variables.cfg"
    {% endif %}
    
    # T3 (tool_4) - Z seria lido diretamente de variables.cfg
    {% if 'tool_2_offset_z' in vars %}
        RESPOND MSG="{'üîÑ T3: Z=' ~ ('%+.4f'|format(vars.tool_2_offset_z)) ~ 'mm (lido diretamente de variables.cfg)'}"
    {% else %}
        RESPOND MSG="‚ö†Ô∏è T3: tool_2_offset_z n√£o encontrado em variables.cfg"
    {% endif %}
    
    # Mostrar offsets Z sincronizados
    {% for tool_num in range(1, 4) %}
        {% set var_name = 'tool_' ~ (tool_num - 1) ~ '_offset_z' if tool_num > 1 else 'tool_0_offset_z' %}
        {% if tool_num == 3 %}
            {% set var_name = 'tool_2_offset_z' %}
        {% endif %}
        {% set saved_z = printer.save_variables.variables.get(var_name, 0.0)|float %}
        {% if saved_z != 0.0 %}
            RESPOND MSG="{'‚úÖ T' ~ tool_num ~ ' Z-offset sincronizado: ' ~ ('%+.4f'|format(saved_z)) ~ 'mm'}"
        {% endif %}
    {% endfor %}
    
    # Garantir que T0 sempre tenha offset zero (√© a refer√™ncia BLTouch)
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=offset_x1 VALUE=0.0
    SET_GCODE_VARIABLE MACRO=TOOL_DATA VARIABLE=offset_y1 VALUE=0.0
    # offset_z1 removido - T0 sempre tem Z=0.0 (refer√™ncia)
    
    RESPOND MSG="üéØ T0 for√ßado para offset ZERO (refer√™ncia BLTouch)"
    RESPOND MSG="‚úÖ Sincroniza√ß√£o conclu√≠da - TOOL_DATA atualizado com variables.cfg"
    RESPOND MSG="üí° Agora os offsets calibrados ser√£o mantidos ap√≥s reinicializa√ß√£o!"

[gcode_macro VERIFICAR_SINCRONIZACAO]
description: Verifica se TOOL_DATA e variables.cfg est√£o sincronizados
gcode:
    RESPOND MSG="üîç ===== VERIFICA√á√ÉO DE SINCRONIZA√á√ÉO ===="
    
    {% for tool_num in range(1, 4) %}
        {% set var_suffix = tool_num - 1 if tool_num > 1 else 0 %}
        {% if tool_num == 3 %}
            {% set var_suffix = 2 %}
        {% endif %}
        {% set saved_x = printer.save_variables.variables.get('tool_' ~ var_suffix ~ '_offset_x', 0.0)|float %}
        {% set saved_y = printer.save_variables.variables.get('tool_' ~ var_suffix ~ '_offset_y', 0.0)|float %}
        {% set saved_z = printer.save_variables.variables.get('tool_' ~ var_suffix ~ '_offset_z', 0.0)|float %}
        
        {% set tool_x = printer['gcode_macro TOOL_DATA']['offset_x' ~ tool_num]|default(0.0)|float %}
        {% set tool_y = printer['gcode_macro TOOL_DATA']['offset_y' ~ tool_num]|default(0.0)|float %}
        {% set tool_z = printer['gcode_macro TOOL_DATA']['offset_z' ~ tool_num]|default(0.0)|float %}
        
        RESPOND MSG="{'üìä T' ~ tool_num ~ ':'}"
        RESPOND MSG="{'   variables.cfg: X=' ~ ('%+.3f'|format(saved_x)) ~ ' Y=' ~ ('%+.3f'|format(saved_y)) ~ ' Z=' ~ ('%+.4f'|format(saved_z))}"
        RESPOND MSG="{'   TOOL_DATA:     X=' ~ ('%+.3f'|format(tool_x)) ~ ' Y=' ~ ('%+.3f'|format(tool_y)) ~ ' Z=' ~ ('%+.4f'|format(tool_z))}"
        
        {% if saved_x == tool_x and saved_y == tool_y and saved_z == tool_z %}
            RESPOND MSG="   Status: ‚úÖ SINCRONIZADO"
        {% else %}
            RESPOND MSG="   Status: ‚ùå DESSINCRONIZADO"
        {% endif %}
        RESPOND MSG=""
    {% endfor %}
    
    RESPOND MSG="üí° Se houver dessincroniza√ß√£o, execute INIT_TOOL_OFFSETS"

[gcode_macro MIGRAR_OFF_VAR]
description: Migra APENAS offsets Z para variables.cfg (X/Y ficam fixos no tools.cfg)
gcode:
    RESPOND MSG="üîÑ Migrando apenas offsets Z para variables.cfg..."
    
    # Migrar apenas valores Z para variables.cfg
    # Os valores X e Y permanecem fixos no tools.cfg
    
    # T0 (tool_1) - Preto
    SAVE_VARIABLE VARIABLE=tool_1_offset_z VALUE=0.0
    
    # T1 (tool_2) - Branco
    SAVE_VARIABLE VARIABLE=tool_1_offset_z VALUE=0.8
    
    # T2 (tool_3) - Roxo
    SAVE_VARIABLE VARIABLE=tool_1_offset_z VALUE=0.3
    
    # T3 (tool_4) - Verde
    SAVE_VARIABLE VARIABLE=tool_2_offset_z VALUE=0.0
    
    RESPOND MSG="‚úÖ Migra√ß√£o Z conclu√≠da! X/Y mantidos no tools.cfg."
    RESPOND MSG="üí° Execute SAVE_CONFIG e depois INIT_TOOL_OFFSETS para sincronizar."