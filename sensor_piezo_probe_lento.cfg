# Configura√ß√£o do sensor piezoel√©trico para PROBE AUTOM√ÅTICO LENTO
# Solu√ß√£o para detectar toque mesmo com aproxima√ß√£o lenta do bico

# OP√á√ÉO 1: Configura√ß√£o como probe anal√≥gico (mais sens√≠vel a press√£o lenta)
# COMENTADO: Conflito com gcode_button sensor_piezo em teste_sensor_piezo.cfg
#[probe]
#pin: !host:gpio22  # Pino invertido para maior sensibilidade
#x_offset: 0
#y_offset: 0
#z_offset: 0  # Ajustar conforme necess√°rio
#speed: 1.0   # Velocidade muito baixa para gerar mais press√£o
#samples: 3   # M√∫ltiplas amostras para maior confiabilidade
#sample_retract_dist: 2.0
#samples_result: median
#samples_tolerance: 0.100
#samples_tolerance_retries: 3

# OP√á√ÉO 2: Configura√ß√£o h√≠brida - gcode_button com sensibilidade extrema
# COMENTADO: Conflito com gcode_button sensor_piezo em teste_sensor_piezo.cfg
#[gcode_button sensor_piezo_backup]
#pin: !host:gpio22  # Pino invertido como backup
#press_gcode:
#    RESPOND MSG="üéØ Contato detectado - Probe lento!"
#release_gcode:
#    RESPOND MSG="üü¢ Sensor liberado"

# Macro para teste de aproxima√ß√£o lenta (simula probe autom√°tico)
[gcode_macro TST_APR_LNT]
description: Testa detec√ß√£o com aproxima√ß√£o lenta como probe autom√°tico
gcode:
    RESPOND MSG="üêå TESTE DE APROXIMA√á√ÉO LENTA"
    RESPOND MSG="‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    RESPOND MSG=""
    RESPOND MSG="Este teste simula como o bico se aproxima durante"
    RESPOND MSG="a calibra√ß√£o autom√°tica - DEVAGAR e com press√£o gradual."
    RESPOND MSG=""
    RESPOND MSG="üéØ COMO TESTAR:"
    RESPOND MSG="1. Aproxime seu dedo MUITO DEVAGAR do sensor"
    RESPOND MSG="2. Fa√ßa press√£o gradual e constante"
    RESPOND MSG="3. Mantenha contato por 2-3 segundos"
    RESPOND MSG="4. Solte devagar"
    RESPOND MSG=""
    RESPOND MSG="‚ö†Ô∏è  IMPORTANTE:"
    RESPOND MSG="- Simule o movimento do bico descendo lentamente"
    RESPOND MSG="- Use press√£o constante, n√£o movimento r√°pido"
    RESPOND MSG="- O sensor DEVE detectar este tipo de contato"
    RESPOND MSG=""
    RESPOND MSG="Estado inicial: {printer['gcode_button sensor_piezo_backup'].state}"
    RESPOND MSG=""
    RESPOND MSG="üëÜ TESTE AGORA: Aproxima√ß√£o lenta com press√£o gradual"

# Macro para calibra√ß√£o de sensibilidade para probe lento
[gcode_macro CAL_PRB_LNT]
description: Calibra sensor especificamente para probe autom√°tico lento
gcode:
    RESPOND MSG="üîß CALIBRA√á√ÉO PARA PROBE LENTO"
    RESPOND MSG="‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    RESPOND MSG=""
    RESPOND MSG="üéØ OBJETIVO: Detectar contato com movimento lento"
    RESPOND MSG=""
    RESPOND MSG="üìã AJUSTES NECESS√ÅRIOS:"
    RESPOND MSG="1. HARDWARE - Placa LM393:"
    RESPOND MSG="   - Gire potenci√¥metro para M√ÅXIMA sensibilidade"
    RESPOND MSG="   - LED deve acender com press√£o muito leve"
    RESPOND MSG="   - Teste com peso de uma moeda"
    RESPOND MSG=""
    RESPOND MSG="2. SOFTWARE - Configura√ß√£o Klipper:"
    RESPOND MSG="   - Pin invertido (!host:gpio22)"
    RESPOND MSG="   - Velocidade de probe baixa (1-2mm/s)"
    RESPOND MSG="   - M√∫ltiplas amostras para confiabilidade"
    RESPOND MSG=""
    RESPOND MSG="3. MEC√ÇNICO - Instala√ß√£o:"
    RESPOND MSG="   - Sensor bem fixo na mesa"
    RESPOND MSG="   - Superf√≠cie r√≠gida (n√£o flex√≠vel)"
    RESPOND MSG="   - Contato direto com √°rea de impress√£o"
    RESPOND MSG=""
    RESPOND MSG="üß™ TESTE DE VALIDA√á√ÉO:"
    RESPOND MSG="Execute: TESTE_APROXIMACAO_LENTA"

# Macro para teste de diferentes configura√ß√µes de pin
[gcode_macro TST_CFG_PIN]
description: Testa diferentes configura√ß√µes de pin para encontrar a melhor
gcode:
    RESPOND MSG="üîå TESTE DE CONFIGURA√á√ïES DE PIN"
    RESPOND MSG="‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    RESPOND MSG=""
    RESPOND MSG="Vamos testar qual configura√ß√£o funciona melhor:"
    RESPOND MSG=""
    RESPOND MSG="üìä CONFIGURA√á√ïES TESTADAS:"
    RESPOND MSG="1. host:gpio22 (normal, sem pull-up)"
    RESPOND MSG="2. ^host:gpio22 (com pull-up interno)"
    RESPOND MSG="3. !host:gpio22 (invertido)"
    RESPOND MSG="4. !^host:gpio22 (invertido com pull-up)"
    RESPOND MSG=""
    RESPOND MSG="üîç TESTE ATUAL: !host:gpio22 (invertido)"
    RESPOND MSG="Estado: {printer['gcode_button sensor_piezo_backup'].state}"
    RESPOND MSG=""
    RESPOND MSG="üí° COMO INTERPRETAR:"
    RESPOND MSG="- Estado 0 = Sem contato"
    RESPOND MSG="- Estado 1 = Com contato"
    RESPOND MSG="- Se invertido: l√≥gica pode estar trocada"
    RESPOND MSG=""
    RESPOND MSG="Fa√ßa um teste de press√£o lenta agora..."

# Macro para configura√ß√£o de probe com par√¢metros otimizados
[gcode_macro CFG_PRB_PZO]
description: Configura par√¢metros ideais para probe piezoel√©trico
gcode:
    RESPOND MSG="‚öôÔ∏è  CONFIGURA√á√ÉO DE PROBE PIEZOEL√âTRICO"
    RESPOND MSG="‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    RESPOND MSG=""
    RESPOND MSG="üìã PAR√ÇMETROS RECOMENDADOS:"
    RESPOND MSG=""
    RESPOND MSG="[probe]"
    RESPOND MSG="pin: !host:gpio22"
    RESPOND MSG="speed: 1.0          # Muito lento para gerar press√£o"
    RESPOND MSG="lift_speed: 5.0     # Subida r√°pida ap√≥s detec√ß√£o"
    RESPOND MSG="samples: 3          # M√∫ltiplas medi√ß√µes"
    RESPOND MSG="sample_retract_dist: 2.0"
    RESPOND MSG="samples_result: median"
    RESPOND MSG="samples_tolerance: 0.100"
    RESPOND MSG="samples_tolerance_retries: 3"
    RESPOND MSG=""
    RESPOND MSG="üéØ ESTRAT√âGIA:"
    RESPOND MSG="- Velocidade baixa = mais tempo de contato"
    RESPOND MSG="- Mais tempo = mais chance de detec√ß√£o"
    RESPOND MSG="- M√∫ltiplas amostras = maior confiabilidade"
    RESPOND MSG="- Pin invertido = melhor sensibilidade"
    RESPOND MSG=""
    RESPOND MSG="‚ö†Ô∏è  ATEN√á√ÉO:"
    RESPOND MSG="Esta configura√ß√£o substitui o gcode_button"
    RESPOND MSG="Use apenas uma das duas configura√ß√µes!"

# Macro para diagn√≥stico de problema de sensibilidade
[gcode_macro DIG_PRB_LNT]
description: Diagnostica problemas com probe lento
gcode:
    RESPOND MSG="üîç DIAGN√ìSTICO - PROBE LENTO"
    RESPOND MSG="‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    RESPOND MSG=""
    RESPOND MSG="‚ùì PROBLEMA: Sensor n√£o detecta movimento lento"
    RESPOND MSG=""
    RESPOND MSG="üîß POSS√çVEIS CAUSAS E SOLU√á√ïES:"
    RESPOND MSG=""
    RESPOND MSG="1. SENSIBILIDADE INSUFICIENTE:"
    RESPOND MSG="   ‚ùå Problema: Potenci√¥metro mal ajustado"
    RESPOND MSG="   ‚úÖ Solu√ß√£o: Gire hor√°rio at√© m√°xima sensibilidade"
    RESPOND MSG=""
    RESPOND MSG="2. CONFIGURA√á√ÉO DE PIN:"
    RESPOND MSG="   ‚ùå Problema: Pin n√£o invertido"
    RESPOND MSG="   ‚úÖ Solu√ß√£o: Use !host:gpio22 (com !)"
    RESPOND MSG=""
    RESPOND MSG="3. VELOCIDADE DE PROBE:"
    RESPOND MSG="   ‚ùå Problema: Muito r√°pido (>3mm/s)"
    RESPOND MSG="   ‚úÖ Solu√ß√£o: Use speed: 1.0 ou menor"
    RESPOND MSG=""
    RESPOND MSG="4. INSTALA√á√ÉO MEC√ÇNICA:"
    RESPOND MSG="   ‚ùå Problema: Sensor mal fixado"
    RESPOND MSG="   ‚úÖ Solu√ß√£o: Fixa√ß√£o r√≠gida na mesa"
    RESPOND MSG=""
    RESPOND MSG="5. TIPO DE SENSOR:"
    RESPOND MSG="   ‚ùå Problema: Piezo puro (s√≥ detecta mudan√ßa)"
    RESPOND MSG="   ‚úÖ Solu√ß√£o: Use sensor de press√£o ou strain gauge"
    RESPOND MSG=""
    RESPOND MSG="üß™ PR√ìXIMOS PASSOS:"
    RESPOND MSG="1. Execute: TESTE_APROXIMACAO_LENTA"
    RESPOND MSG="2. Se n√£o funcionar: considere sensor diferente"
    RESPOND MSG="3. Alternativa: BLTouch ou sensor indutivo"