#####################################################################
#                    CORRE√á√ÉO DEFINITIVA DE OFFSETS               #
#####################################################################

[gcode_macro CORRIGIR_OFF_DEF]
description: Corre√ß√£o definitiva do problema de offsets Z
gcode:
    RESPOND MSG="üîß ===== CORRE√á√ÉO DEFINITIVA DE OFFSETS ====="
    
    # 1. Verificar valores em variables.cfg
    {% set vars = printer.save_variables.variables %}
    RESPOND MSG="üìÅ Valores em variables.cfg:"
    RESPOND MSG="   tool_1_offset_z = {vars.get('tool_1_offset_z', 'N√ÉO DEFINIDO')}"
    RESPOND MSG="   tool_2_offset_z = {vars.get('tool_2_offset_z', 'N√ÉO DEFINIDO')} (OBSOLETO)"
    
    # 2. ‚úÖ SIMPLIFICADO: Verificar offsets Z em variables.cfg
    RESPOND MSG="üîç Verificando offsets Z em variables.cfg:"
    
    # Verificar T1
    {% if 'tool_0_offset_z' in vars %}
        RESPOND MSG="‚úÖ T1: tool_0_offset_z = {vars.tool_0_offset_z}mm"
    {% else %}
        RESPOND MSG="‚ö†Ô∏è T1: tool_0_offset_z n√£o encontrado em variables.cfg"
    {% endif %}
    
    # Verificar T2
    {% if 'tool_1_offset_z' in vars %}
        RESPOND MSG="‚úÖ T2: tool_1_offset_z = {vars.tool_1_offset_z}mm"
    {% else %}
        RESPOND MSG="‚ö†Ô∏è T2: tool_1_offset_z n√£o encontrado em variables.cfg"
    {% endif %}
    
    # 3. Aplicar offset da ferramenta ativa
    {% set current_tool = printer['gcode_macro TOOL_STATE'].tool|int %}
    RESPOND MSG="üéØ Aplicando offset para ferramenta ativa (TOOL={current_tool})..."
    
    {% if current_tool == 1 %}
        SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0 MOVE=1
        RESPOND MSG="‚úÖ T0: Offset ZERO aplicado"
    {% elif current_tool == 2 %}
        {% set x = printer['gcode_macro TOOL_DATA']['offset_x2']|default(0)|float %}
        {% set y = printer['gcode_macro TOOL_DATA']['offset_y2']|default(0)|float %}
        {% set z = vars.get('tool_0_offset_z', 0.0)|float %}
        SET_GCODE_OFFSET X={x} Y={y} Z={z} MOVE=1
        RESPOND MSG="‚úÖ T1: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
    {% elif current_tool == 3 %}
        {% set x = printer['gcode_macro TOOL_DATA']['offset_x3']|default(0)|float %}
        {% set y = printer['gcode_macro TOOL_DATA']['offset_y3']|default(0)|float %}
        {% set z = vars.get('tool_1_offset_z', 0.0)|float %}
        SET_GCODE_OFFSET X={x} Y={y} Z={z} MOVE=1
        RESPOND MSG="‚úÖ T2: Offset aplicado X={x} Y={y} Z={z} (Z direto de variables.cfg)"
    {% endif %}
    
    RESPOND MSG="‚úÖ CORRE√á√ÉO CONCLU√çDA!"
    M117 Offsets corrigidos

[gcode_macro VERIF_PROB_OFF]
description: Verifica se o problema de offsets ainda existe
gcode:
    RESPOND MSG="üîç ===== VERIFICA√á√ÉO DO PROBLEMA ====="
    
    # Verificar ferramenta ativa
    {% set current_tool = printer['gcode_macro TOOL_STATE'].tool|int %}
    {% set show_t = current_tool - 1 %}
    RESPOND MSG="üéØ Ferramenta ativa: T{show_t} (TOOL={current_tool})"
    
    # Verificar offset aplicado
    {% set current_x = printer.gcode_move.gcode_position.x - printer.gcode_move.position.x %}
    {% set current_y = printer.gcode_move.gcode_position.y - printer.gcode_move.position.y %}
    {% set current_z = printer.gcode_move.gcode_position.z - printer.gcode_move.position.z %}
    RESPOND MSG="üìè Offset atualmente aplicado: X={current_x|round(4)} Y={current_y|round(4)} Z={current_z|round(4)}"
    
    # Verificar se est√° correto
    {% if current_tool == 1 %}
        {% if current_x == 0.0 and current_y == 0.0 and current_z == 0.0 %}
            RESPOND MSG="‚úÖ T0: Offset correto (deve ser 0,0,0)"
        {% else %}
            RESPOND MSG="‚ùå T0: Offset incorreto! Deveria ser 0,0,0"
        {% endif %}
    {% elif current_tool == 2 %}
        {% set expected_z = printer.save_variables.variables.get('tool_1_offset_z', 0.0)|float %}
        {% if current_z == expected_z %}
            RESPOND MSG="‚úÖ T1: Offset Z correto ({expected_z}mm)"
        {% else %}
            RESPOND MSG="‚ùå T1: Offset Z incorreto! Esperado: {expected_z}mm, Atual: {current_z}mm"
        {% endif %}
    {% elif current_tool == 3 %}
        {% set expected_z = printer.save_variables.variables.get('tool_1_offset_z', 0.0)|float %}
        {% if current_z == expected_z %}
            RESPOND MSG="‚úÖ T2: Offset Z correto ({expected_z}mm)"
        {% else %}
            RESPOND MSG="‚ùå T2: Offset Z incorreto! Esperado: {expected_z}mm, Atual: {current_z}mm"
        {% endif %}
    {% endif %}
    
    RESPOND MSG="üí° Se houver problemas, execute: CORRIGIR_OFFSETS_DEFINITIVO"