# Monitor avanÃ§ado para GPIO 22 (Pino 15) - Sensor PiezoelÃ©trico
# Sistema de monitoramento em tempo real com anÃ¡lise de padrÃµes

# Macro para monitoramento em tempo real com display visual
[gcode_macro MONITOR_TEMPO_REAL]
description: Monitor visual em tempo real do GPIO 22
gcode:
    {% set duracao = params.DURACAO|default(30)|int %}
    {% set intervalo = params.INTERVALO|default(0.1)|float %}
    
    RESPOND MSG="â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    RESPOND MSG="â•‘     MONITOR TEMPO REAL - GPIO 22     â•‘"
    RESPOND MSG="â•‘        Pino 15 (Sensor Piezo)       â•‘"
    RESPOND MSG="â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND MSG="DuraÃ§Ã£o: {duracao}s | Intervalo: {intervalo}s"
    RESPOND MSG="ğŸŸ¢ = Sensor livre | ğŸ”´ = Sensor acionado"
    RESPOND MSG="Pressione CTRL+C no terminal para parar"
    RESPOND MSG=""
    
    {% set total_leituras = (duracao / intervalo)|int %}
    {% for i in range(total_leituras) %}
        {% set tempo_atual = (i * intervalo)|round(1) %}
        QUERY_PROBE
        # A resposta do QUERY_PROBE serÃ¡ mostrada automaticamente
        G4 P{(intervalo * 1000)|int}
        
        # A cada 10 leituras, mostra progresso
        {% if (i + 1) % 10 == 0 %}
            {% set progresso = ((i + 1) / total_leituras * 100)|int %}
            RESPOND MSG="â±ï¸  Progresso: {progresso}% ({tempo_atual}s/{duracao}s)"
        {% endif %}
    {% endfor %}
    
    RESPOND MSG="âœ… Monitoramento concluÃ­do!"

# Macro para teste de resposta rÃ¡pida
[gcode_macro TESTE_RESPOSTA_RAPIDA]
description: Testa a velocidade de resposta do sensor
gcode:
    {% set repeticoes = params.REPETICOES|default(20)|int %}
    
    RESPOND MSG="âš¡ TESTE DE RESPOSTA RÃPIDA âš¡"
    RESPOND MSG="Testando {repeticoes} leituras consecutivas"
    RESPOND MSG="Intervalo: 50ms entre leituras"
    RESPOND MSG=""
    
    {% for i in range(repeticoes) %}
        RESPOND MSG="ğŸ“Š Leitura {i+1}/{repeticoes}: {printer['gcode_button sensor_piezo'].state}"
        G4 P50  # 50ms entre leituras
    {% endfor %}
    
    RESPOND MSG="âœ… Teste de resposta concluÃ­do!"

# Macro para anÃ¡lise de estabilidade
[gcode_macro ANALISE_ESTABILIDADE]
description: Analisa a estabilidade do sensor ao longo do tempo
gcode:
    {% set ciclos = params.CICLOS|default(50)|int %}
    {% set pausa_ciclo = params.PAUSA|default(2)|int %}
    
    RESPOND MSG="ğŸ“ˆ ANÃLISE DE ESTABILIDADE ğŸ“ˆ"
    RESPOND MSG="Ciclos: {ciclos} | Pausa entre ciclos: {pausa_ciclo}s"
    RESPOND MSG="Deixe o sensor em repouso durante o teste"
    RESPOND MSG=""
    
    {% for i in range(ciclos) %}
        {% set minuto = (i * pausa_ciclo / 60)|round(1) %}
        RESPOND MSG="ğŸ” Ciclo {i+1}/{ciclos} (t={minuto}min): {printer['gcode_button sensor_piezo'].state}"
        
        {% if pausa_ciclo > 0 %}
            G4 P{pausa_ciclo * 1000}
        {% endif %}
        
        # Checkpoint a cada 10 ciclos
        {% if (i + 1) % 10 == 0 %}
            RESPOND MSG="ğŸ“‹ Checkpoint: {i+1} ciclos completados"
        {% endif %}
    {% endfor %}
    
    RESPOND MSG="âœ… AnÃ¡lise de estabilidade concluÃ­da!"
    RESPOND MSG="Verifique se houve leituras inconsistentes"

# Macro para teste de sensibilidade com nÃ­veis
[gcode_macro TESTE_SENS_NIV]
description: Teste de sensibilidade com diferentes nÃ­veis de toque
gcode:
    RESPOND MSG="ğŸ¯ TESTE DE SENSIBILIDADE POR NÃVEIS ğŸ¯"
    RESPOND MSG="Siga as instruÃ§Ãµes para cada nÃ­vel de toque"
    RESPOND MSG=""
    
    # NÃ­vel 1: Toque muito leve
    RESPOND MSG="ğŸ“ NÃVEL 1: Toque MUITO LEVE"
    RESPOND MSG="Toque levemente o sensor (como uma pena)"
    RESPOND MSG="Pressione qualquer tecla e execute QUERY_PROBE"
    G4 P3000
    RESPOND MSG="Estado NÃ­vel 1: {printer['gcode_button sensor_piezo'].state}"
    
    # NÃ­vel 2: Toque normal
    RESPOND MSG="ğŸ“ NÃVEL 2: Toque NORMAL"
    RESPOND MSG="Toque normalmente o sensor"
    RESPOND MSG="Aguarde 3 segundos..."
    G4 P3000
    RESPOND MSG="Estado NÃ­vel 2: {printer['gcode_button sensor_piezo'].state}"
    
    # NÃ­vel 3: Toque firme
    RESPOND MSG="ğŸ“ NÃVEL 3: Toque FIRME"
    RESPOND MSG="Pressione firmemente o sensor"
    RESPOND MSG="Aguarde 3 segundos..."
    G4 P3000
    RESPOND MSG="Estado NÃ­vel 3: {printer['gcode_button sensor_piezo'].state}"
    
    # Estado final
    RESPOND MSG="ğŸ“ ESTADO FINAL: Sensor livre"
    RESPOND MSG="Solte completamente o sensor"
    RESPOND MSG="Aguarde 3 segundos..."
    G4 P3000
    RESPOND MSG="Estado Final: {printer['gcode_button sensor_piezo'].state}"
    
    RESPOND MSG="âœ… Teste de sensibilidade concluÃ­do!"
    RESPOND MSG="Ajuste o potenciÃ´metro da placa LM393 se necessÃ¡rio"

# Macro para monitoramento com contador de eventos
[gcode_macro CONTADOR_EVENTOS]
description: Conta quantas vezes o sensor Ã© acionado
variable_eventos_detectados: 0
variable_estado_anterior: 0
gcode:
    {% set duracao = params.DURACAO|default(60)|int %}
    {% set intervalo = params.INTERVALO|default(0.2)|float %}
    
    # Reset do contador
    SET_GCODE_VARIABLE MACRO=CONTADOR_EVENTOS VARIABLE=eventos_detectados VALUE=0
    SET_GCODE_VARIABLE MACRO=CONTADOR_EVENTOS VARIABLE=estado_anterior VALUE=0
    
    RESPOND MSG="ğŸ”¢ CONTADOR DE EVENTOS ğŸ”¢"
    RESPOND MSG="DuraÃ§Ã£o: {duracao}s | VerificaÃ§Ã£o a cada {intervalo}s"
    RESPOND MSG="Toque o sensor vÃ¡rias vezes para testar"
    RESPOND MSG=""
    
    {% set total_checks = (duracao / intervalo)|int %}
    {% for i in range(total_checks) %}
        # Monitora estado do sensor automaticamente via gcode_button
        G4 P{(intervalo * 1000)|int}
        
        {% if (i + 1) % 25 == 0 %}
            {% set tempo_decorrido = ((i + 1) * intervalo)|int %}
            RESPOND MSG="â° Tempo: {tempo_decorrido}s/{duracao}s"
        {% endif %}
    {% endfor %}
    
    RESPOND MSG="âœ… Monitoramento de eventos concluÃ­do!"
    RESPOND MSG="Verifique o log para contar os eventos manualmente"

# Macro para teste de ruÃ­do/interferÃªncia
[gcode_macro TESTE_RUIDO]
description: Detecta ruÃ­do ou interferÃªncia no sensor
gcode:
    {% set amostras = params.AMOSTRAS|default(100)|int %}
    
    RESPOND MSG="ğŸŒŠ TESTE DE RUÃDO/INTERFERÃŠNCIA ğŸŒŠ"
    RESPOND MSG="Coletando {amostras} amostras rÃ¡pidas"
    RESPOND MSG="NÃƒO toque no sensor durante este teste"
    RESPOND MSG=""
    
    {% for i in range(amostras) %}
        {% if i % 20 == 0 %}
            RESPOND MSG="ğŸ“Š Amostra {i+1}-{(i+20)|min(amostras)}/{amostras} - Estado: {printer['gcode_button sensor_piezo'].state}"
        {% endif %}
        G4 P25  # 25ms entre amostras (40Hz)
    {% endfor %}
    
    RESPOND MSG="âœ… Teste de ruÃ­do concluÃ­do!"
    RESPOND MSG="Se houve mudanÃ§as de estado, pode haver interferÃªncia"
    RESPOND MSG="Verifique conexÃµes e blindagem se necessÃ¡rio"

# Macro de ajuda com menu visual
[gcode_macro MENU_SENSOR_PIEZO]
description: Menu principal para testes do sensor piezoelÃ©trico
gcode:
    RESPOND MSG="â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    RESPOND MSG="â•‘           MENU SENSOR PIEZOELÃ‰TRICO              â•‘"
    RESPOND MSG="â•‘              GPIO 22 (Pino 15)                  â•‘"
    RESPOND MSG="â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    RESPOND MSG="â•‘  TESTES BÃSICOS:                                â•‘"
    RESPOND MSG="â•‘  â€¢ TESTE_SENSOR_PIEZO - Teste inicial           â•‘"
    RESPOND MSG="â•‘  â€¢ Monitoramento automÃ¡tico ativo               â•‘"
    RESPOND MSG="â•‘                                                  â•‘"
    RESPOND MSG="â•‘  MONITORAMENTO:                                 â•‘"
    RESPOND MSG="â•‘  â€¢ MONITOR_TEMPO_REAL DURACAO=30               â•‘"
    RESPOND MSG="â•‘  â€¢ TESTE_RESPOSTA_RAPIDA REPETICOES=20          â•‘"
    RESPOND MSG="â•‘  â€¢ ANALISE_ESTABILIDADE CICLOS=30               â•‘"
    RESPOND MSG="â•‘                                                  â•‘"
    RESPOND MSG="â•‘  CALIBRAÃ‡ÃƒO:                                    â•‘"
    RESPOND MSG="â•‘  â€¢ TESTE_SENSIBILIDADE_NIVEIS                   â•‘"
    RESPOND MSG="â•‘  â€¢ CALIBRAR_SENSIBILIDADE_PIEZO                 â•‘"
    RESPOND MSG="â•‘                                                  â•‘"
    RESPOND MSG="â•‘  DIAGNÃ“STICO:                                   â•‘"
    RESPOND MSG="â•‘  â€¢ DIAGNOSTICO_SENSOR_PIEZO                     â•‘"
    RESPOND MSG="â•‘  â€¢ TESTE_RUIDO AMOSTRAS=50                      â•‘"
    RESPOND MSG="â•‘  â€¢ CONTADOR_EVENTOS DURACAO=60                  â•‘"
    RESPOND MSG="â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    RESPOND MSG="ğŸ’¡ Dica: Comece com TESTE_SENSOR_PIEZO"
    RESPOND MSG="ğŸ”§ Ajuste o potenciÃ´metro da placa LM393 conforme necessÃ¡rio"